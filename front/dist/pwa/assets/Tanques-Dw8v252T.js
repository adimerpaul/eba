import{_ as F,c as p,o as r,w as t,b as s,a as e,Q as g,e as m,t as n,P as h,d as w,a7 as d,ac as V,O as f,a9 as b,ag as x,f as y,h as O,aj as U,ai as Q,a8 as N,ae as T,af as H,aa as I,ab as P}from"./index-CAulUK1l.js";import{Q as D}from"./QSelect-Db_8UKnU.js";import{Q as k}from"./QTd--KRd0I6g.js";import{Q as R}from"./QBadge-CRQLzB3T.js";import{Q as z}from"./QLinearProgress-Knx0hMuG.js";import{Q as S}from"./QChip-BiqMtwu8.js";import{Q as _,b as c,a as q}from"./position-engine-CzBd1S9u.js";import{Q as E}from"./QList-BmdHpSHo.js";import{Q as B}from"./QBtnDropdown-Dsx3L-fp.js";import{Q as A}from"./QTable-BqrnDCIu.js";import{Q as j}from"./QForm-BvqvUmRs.js";import{Q as M}from"./QPage-CV8wXvdH.js";import{C as v}from"./ClosePopup-C4Pt3EwD.js";import"./format-B-I0JNio.js";import"./selection-18ztxYWA.js";import"./QBtnGroup-D77osZ6I.js";import"./QMarkupTable-CowDf2cr.js";import"./use-fullscreen-97cLa6dV.js";const L={name:"TanquesPage",data(){return{loading:!1,rows:[],stats:{total_tanques:0,operativos:0,ocupacion_promedio:0,tanques_llenos:0},columns:[{name:"actions",label:"Acciones",align:"right"},{name:"codigo_tanque",label:"Código",align:"left",field:"codigo_tanque"},{name:"nombre_tanque",label:"Nombre",align:"left",field:"nombre_tanque"},{name:"planta",label:"Planta",align:"left"},{name:"capacidad_kg",label:"Capacidad (kg)",align:"right",field:"capacidad_kg"},{name:"ocupacion",label:"Ocupación",align:"left"},{name:"estado_operativo",label:"Estado",align:"left",field:"estado_operativo"}],filter:"",plantaId:null,plantaOptions:[],dlg:{open:!1,mode:"create",row:null},form:{codigo_tanque:"",nombre_tanque:"",planta_id:null,capacidad_litros:0,capacidad_kg:0,estado_operativo:"OPERATIVO",descripcion:""},saving:!1,dlgOcupacion:{open:!1,row:null},loadingOcupacion:!1,ocupacionData:null,dlgHistorial:{open:!1,row:null},loadingHistorial:!1,historialData:[],historialColumns:[{name:"id",label:"#",align:"left",field:"id"},{name:"fecha_proceso",label:"Fecha",align:"left",field:"fecha_proceso"},{name:"producto",label:"Producto",align:"left",field:i=>i.producto?.nombre_producto||"-"},{name:"cantidad_entrada_kg",label:"Entrada (kg)",align:"right",field:"cantidad_entrada_kg",format:i=>Number(i||0).toFixed(2)},{name:"cantidad_salida_kg",label:"Salida (kg)",align:"right",field:"cantidad_salida_kg",format:i=>Number(i||0).toFixed(2)},{name:"estado",label:"Estado",align:"left",field:"estado"}]}},computed:{canSubmit(){const i=this.form;return!!(i.codigo_tanque&&i.nombre_tanque&&i.planta_id&&i.capacidad_kg>0&&i.estado_operativo)}},mounted(){this.fetchPlantas(),this.fetchEstadisticas(),this.fetch()},methods:{async fetch(){this.loading=!0;try{const i={};this.plantaId&&(i.planta_id=this.plantaId),this.filter&&(i.search=this.filter);const{data:a}=await this.$axios.get("/tanques",{params:i});this.rows=a}catch{this.$q.notify({type:"negative",message:"No se pudieron cargar los tanques"})}finally{this.loading=!1}},fetchDebounced(){clearTimeout(this._fetchTimer),this._fetchTimer=setTimeout(()=>this.fetch(),500)},async fetchPlantas(){try{const{data:i}=await this.$axios.get("/plantas");this.plantaOptions=i}catch{this.$q.notify({type:"warning",message:"No se pudieron cargar plantas"})}},async fetchEstadisticas(){try{const{data:i}=await this.$axios.get("/tanques/estadisticas");this.stats=i}catch(i){console.error("Error cargando estadísticas:",i)}},getOcupacionColor(i){return i>=90?"negative":i>=70?"orange":"positive"},openCreate(){this.dlg={open:!0,mode:"create",row:null},this.form={codigo_tanque:"",nombre_tanque:"",planta_id:null,capacidad_litros:0,capacidad_kg:0,estado_operativo:"OPERATIVO",descripcion:""}},openEdit(i){this.dlg={open:!0,mode:"edit",row:i},this.form={codigo_tanque:i.codigo_tanque||"",nombre_tanque:i.nombre_tanque||"",planta_id:i.planta_id||i.planta?.id||null,capacidad_litros:i.capacidad_litros||0,capacidad_kg:i.capacidad_kg||0,estado_operativo:i.estado_operativo||"OPERATIVO",descripcion:i.descripcion||""}},async onSubmit(){if(this.canSubmit){this.saving=!0;try{this.dlg.mode==="create"?await this.$axios.post("/tanques",this.form):await this.$axios.put(`/tanques/${this.dlg.row.id}`,this.form),this.$q.notify({type:"positive",message:"Guardado"}),this.dlg.open=!1,await this.fetch(),await this.fetchEstadisticas()}catch(i){this.$q.notify({type:"negative",message:i.response?.data?.message||"No se pudo guardar"})}finally{this.saving=!1}}},async onDelete(i){this.$q.dialog({title:"Eliminar",message:`¿Eliminar el tanque ${i.nombre_tanque}?`,cancel:!0,persistent:!0}).onOk(async()=>{try{await this.$axios.delete(`/tanques/${i.id}`),this.$q.notify({type:"positive",message:"Eliminado"}),await this.fetch(),await this.fetchEstadisticas()}catch(a){this.$q.notify({type:"negative",message:a.response?.data?.message||"No se pudo eliminar"})}})},async openOcupacion(i){this.dlgOcupacion={open:!0,row:i},this.loadingOcupacion=!0,this.ocupacionData=null;try{const{data:a}=await this.$axios.get(`/tanques/${i.id}/ocupacion`);this.ocupacionData=a}catch{this.$q.notify({type:"negative",message:"No se pudo cargar detalle de ocupación"})}finally{this.loadingOcupacion=!1}},async openHistorial(i){this.dlgHistorial={open:!0,row:i},this.loadingHistorial=!0,this.historialData=[];try{const{data:a}=await this.$axios.get(`/tanques/${i.id}/historial`);this.historialData=a}catch{this.$q.notify({type:"negative",message:"No se pudo cargar historial"})}finally{this.loadingHistorial=!1}}}},G={class:"row q-col-gutter-md q-mb-md"},Z={class:"col-12 col-sm-6 col-md-3"},J={class:"text-h6 text-primary"},K={class:"col-12 col-sm-6 col-md-3"},W={class:"text-h6 text-positive"},X={class:"col-12 col-sm-6 col-md-3"},Y={class:"text-h6 text-orange"},$={class:"col-12 col-sm-6 col-md-3"},ee={class:"text-h6 text-negative"},te={class:"row items-center q-gutter-sm"},ae={key:0,class:"row items-center q-gutter-xs"},oe={class:"col"},le={class:"absolute-full flex flex-center"},ie={class:"text-caption"},se={key:1,class:"text-grey-7 text-caption"},ne={class:"row q-col-gutter-md"},de={class:"col-12 col-md-4"},re={class:"col-12 col-md-8"},ce={class:"col-12 col-md-6"},ue={class:"col-12 col-md-6"},pe={class:"col-12 col-md-6"},me={class:"col-12 col-md-6"},fe={class:"col-12"},_e={key:0,class:"text-center q-pa-md"},ge={key:1},he={class:"row q-col-gutter-md q-mb-md"},be={class:"col-6"},ve={class:"text-h6"},xe={class:"col-6"},ye={class:"text-h6"},ke={class:"col-6"},qe={class:"text-h6 text-positive"},we={class:"col-6"},Ve={key:0,class:"text-center q-pa-md"};function Ce(i,a,Oe,Qe,l,u){return r(),p(M,{class:"q-pa-md"},{default:t(()=>[s("div",G,[s("div",Z,[e(g,{flat:"",bordered:""},{default:t(()=>[e(m,{class:"text-center"},{default:t(()=>[s("div",J,n(l.stats.total_tanques||0),1),a[12]||(a[12]=s("div",{class:"text-caption text-grey-7"},"Total Tanques",-1))]),_:1})]),_:1})]),s("div",K,[e(g,{flat:"",bordered:""},{default:t(()=>[e(m,{class:"text-center"},{default:t(()=>[s("div",W,n(l.stats.operativos||0),1),a[13]||(a[13]=s("div",{class:"text-caption text-grey-7"},"Operativos",-1))]),_:1})]),_:1})]),s("div",X,[e(g,{flat:"",bordered:""},{default:t(()=>[e(m,{class:"text-center"},{default:t(()=>[s("div",Y,n(l.stats.ocupacion_promedio||0)+"%",1),a[14]||(a[14]=s("div",{class:"text-caption text-grey-7"},"Ocupación Promedio",-1))]),_:1})]),_:1})]),s("div",$,[e(g,{flat:"",bordered:""},{default:t(()=>[e(m,{class:"text-center"},{default:t(()=>[s("div",ee,n(l.stats.tanques_llenos||0),1),a[15]||(a[15]=s("div",{class:"text-caption text-grey-7"},"Tanques >90%",-1))]),_:1})]),_:1})])]),e(A,{rows:l.rows,columns:l.columns,"row-key":"id",flat:"",bordered:"",dense:"","wrap-cells":"","rows-per-page-options":[0],title:"Tanques de Almacenamiento",loading:l.loading,filter:l.filter},{"top-right":t(()=>[s("div",te,[e(D,{modelValue:l.plantaId,"onUpdate:modelValue":[a[0]||(a[0]=o=>l.plantaId=o),u.fetch],options:l.plantaOptions,"option-value":"id","option-label":"nombre_planta","emit-value":"","map-options":"",dense:"",filled:"",clearable:"",label:"Planta",style:{"min-width":"220px"}},null,8,["modelValue","options","onUpdate:modelValue"]),e(x,{modelValue:l.filter,"onUpdate:modelValue":[a[1]||(a[1]=o=>l.filter=o),u.fetchDebounced],dense:"",outlined:"",placeholder:"Buscar por código, nombre"},{append:t(()=>[e(w,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),e(y,{color:"positive",icon:"add_circle_outline",label:"Nuevo","no-caps":"",loading:l.loading,onClick:u.openCreate},null,8,["loading","onClick"]),e(y,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:l.loading,onClick:u.fetch},null,8,["loading","onClick"])])]),"body-cell-planta":t(o=>[e(k,{props:o},{default:t(()=>[d(n(o.row.planta?.nombre_planta||"-"),1)]),_:2},1032,["props"])]),"body-cell-capacidad_kg":t(o=>[e(k,{props:o,class:"text-right"},{default:t(()=>[d(n(Number(o.row.capacidad_kg||0).toFixed(2)),1)]),_:2},1032,["props"])]),"body-cell-ocupacion":t(o=>[e(k,{props:o},{default:t(()=>[o.row.capacidad_kg&&o.row.porcentaje_ocupacion!==null?(r(),b("div",ae,[s("div",oe,[e(z,{value:o.row.porcentaje_ocupacion/100,color:u.getOcupacionColor(o.row.porcentaje_ocupacion),size:"18px",rounded:""},{default:t(()=>[s("div",le,[e(R,{color:"transparent","text-color":"white",label:`${o.row.porcentaje_ocupacion.toFixed(1)}%`},null,8,["label"])])]),_:2},1032,["value","color"])]),s("div",ie,n(Number(o.row.ocupacion_actual_kg||0).toFixed(2))+" kg ",1)])):(r(),b("div",se," Sin capacidad configurada "))]),_:2},1032,["props"])]),"body-cell-estado_operativo":t(o=>[e(k,{props:o},{default:t(()=>[e(S,{color:o.row.estado_operativo==="OPERATIVO"?"positive":o.row.estado_operativo==="MANTENIMIENTO"?"orange":"negative","text-color":"white",size:"sm",dense:""},{default:t(()=>[d(n(o.row.estado_operativo),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-actions":t(o=>[e(k,{props:o,class:"text-right"},{default:t(()=>[e(B,{label:"Opciones",dense:"",color:"primary","no-caps":"",size:"10px"},{default:t(()=>[e(E,null,{default:t(()=>[h((r(),p(_,{clickable:"",onClick:C=>u.openOcupacion(o.row)},{default:t(()=>[e(c,{avatar:""},{default:t(()=>[e(w,{name:"bar_chart"})]),_:1}),e(c,null,{default:t(()=>a[16]||(a[16]=[d("Ver Ocupación")])),_:1})]),_:2},1032,["onClick"])),[[V],[v]]),h((r(),p(_,{clickable:"",onClick:C=>u.openHistorial(o.row)},{default:t(()=>[e(c,{avatar:""},{default:t(()=>[e(w,{name:"history"})]),_:1}),e(c,null,{default:t(()=>a[17]||(a[17]=[d("Historial")])),_:1})]),_:2},1032,["onClick"])),[[V],[v]]),e(f),h((r(),p(_,{clickable:"",onClick:C=>u.openEdit(o.row)},{default:t(()=>[e(c,{avatar:""},{default:t(()=>[e(w,{name:"edit"})]),_:1}),e(c,null,{default:t(()=>a[18]||(a[18]=[d("Editar")])),_:1})]),_:2},1032,["onClick"])),[[V],[v]]),h((r(),p(_,{clickable:"",onClick:C=>u.onDelete(o.row)},{default:t(()=>[e(c,{avatar:""},{default:t(()=>[e(w,{name:"delete",color:"negative"})]),_:1}),e(c,null,{default:t(()=>a[19]||(a[19]=[s("span",{class:"text-negative"},"Eliminar",-1)])),_:1})]),_:2},1032,["onClick"])),[[V],[v]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","filter"]),e(O,{modelValue:l.dlg.open,"onUpdate:modelValue":a[9]||(a[9]=o=>l.dlg.open=o),persistent:""},{default:t(()=>[e(g,{style:{"min-width":"560px","max-width":"820px"}},{default:t(()=>[e(m,{class:"text-h6"},{default:t(()=>[d(n(l.dlg.mode==="create"?"Nuevo Tanque":"Editar Tanque"),1)]),_:1}),e(f),e(m,null,{default:t(()=>[e(j,{onSubmit:U(u.onSubmit,["prevent"]),ref:"formRef"},{default:t(()=>[s("div",ne,[s("div",de,[e(x,{modelValue:l.form.codigo_tanque,"onUpdate:modelValue":a[2]||(a[2]=o=>l.form.codigo_tanque=o),dense:"",filled:"",label:"Código tanque *"},null,8,["modelValue"])]),s("div",re,[e(x,{modelValue:l.form.nombre_tanque,"onUpdate:modelValue":a[3]||(a[3]=o=>l.form.nombre_tanque=o),dense:"",filled:"",label:"Nombre tanque *"},null,8,["modelValue"])]),s("div",ce,[e(D,{modelValue:l.form.planta_id,"onUpdate:modelValue":a[4]||(a[4]=o=>l.form.planta_id=o),options:l.plantaOptions,"option-value":"id","option-label":"nombre_planta","emit-value":"","map-options":"",dense:"",filled:"",label:"Planta *"},null,8,["modelValue","options"])]),s("div",ue,[e(D,{modelValue:l.form.estado_operativo,"onUpdate:modelValue":a[5]||(a[5]=o=>l.form.estado_operativo=o),options:["OPERATIVO","MANTENIMIENTO","FUERA_DE_SERVICIO"],dense:"",filled:"",label:"Estado operativo *"},null,8,["modelValue"])]),s("div",pe,[e(x,{modelValue:l.form.capacidad_litros,"onUpdate:modelValue":a[6]||(a[6]=o=>l.form.capacidad_litros=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",filled:"",label:"Capacidad (litros) *"},null,8,["modelValue"])]),s("div",me,[e(x,{modelValue:l.form.capacidad_kg,"onUpdate:modelValue":a[7]||(a[7]=o=>l.form.capacidad_kg=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",filled:"",label:"Capacidad (kg) *"},null,8,["modelValue"])]),s("div",fe,[e(x,{modelValue:l.form.descripcion,"onUpdate:modelValue":a[8]||(a[8]=o=>l.form.descripcion=o),type:"textarea",autogrow:"",dense:"",filled:"",label:"Descripción"},null,8,["modelValue"])])])]),_:1},8,["onSubmit"])]),_:1}),e(f),e(Q,{align:"right"},{default:t(()=>[h(e(y,{flat:"",label:"Cancelar"},null,512),[[v]]),e(y,{color:"primary",loading:l.saving,disable:!u.canSubmit,label:"Guardar",onClick:u.onSubmit},null,8,["loading","disable","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(O,{modelValue:l.dlgOcupacion.open,"onUpdate:modelValue":a[10]||(a[10]=o=>l.dlgOcupacion.open=o)},{default:t(()=>[e(g,{style:{"min-width":"600px"}},{default:t(()=>[e(m,{class:"text-h6"},{default:t(()=>[d(" Detalle de Ocupación - "+n(l.dlgOcupacion.row?.codigo_tanque),1)]),_:1}),e(f),e(m,null,{default:t(()=>[l.loadingOcupacion?(r(),b("div",_e,[e(T,{color:"primary",size:"3em"})])):l.ocupacionData?(r(),b("div",ge,[s("div",he,[s("div",be,[a[20]||(a[20]=s("div",{class:"text-caption text-grey-7"},"Capacidad Total",-1)),s("div",ve,n(Number(l.ocupacionData.capacidad_kg||0).toFixed(2))+" kg",1)]),s("div",xe,[a[21]||(a[21]=s("div",{class:"text-caption text-grey-7"},"Ocupación Actual",-1)),s("div",ye,n(Number(l.ocupacionData.ocupacion_actual_kg||0).toFixed(2))+" kg",1)]),s("div",ke,[a[22]||(a[22]=s("div",{class:"text-caption text-grey-7"},"Disponible",-1)),s("div",qe,n(Number(l.ocupacionData.capacidad_disponible_kg||0).toFixed(2))+" kg",1)]),s("div",we,[a[23]||(a[23]=s("div",{class:"text-caption text-grey-7"},"Porcentaje",-1)),s("div",{class:H(["text-h6",`text-${u.getOcupacionColor(l.ocupacionData.porcentaje_ocupacion)}`])},n(Number(l.ocupacionData.porcentaje_ocupacion||0).toFixed(1))+"% ",3)])]),e(f,{class:"q-my-md"}),a[26]||(a[26]=s("div",{class:"text-subtitle2 q-mb-sm"},"Procesos en Curso",-1)),e(E,{bordered:"",separator:"",dense:""},{default:t(()=>[(r(!0),b(I,null,P(l.ocupacionData.procesos_activos,o=>(r(),p(_,{key:o.id},{default:t(()=>[e(c,null,{default:t(()=>[e(q,null,{default:t(()=>[d("Proceso #"+n(o.id)+" - "+n(o.producto?.nombre_producto),1)]),_:2},1024),e(q,{caption:""},{default:t(()=>[d(n(o.fecha_proceso),1)]),_:2},1024)]),_:2},1024),e(c,{side:""},{default:t(()=>[e(q,null,{default:t(()=>[d(n(Number(o.cantidad_entrada_kg||0).toFixed(2))+" kg",1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),l.ocupacionData.procesos_activos?.length?N("",!0):(r(),p(_,{key:0},{default:t(()=>[e(c,{class:"text-grey-7 text-center"},{default:t(()=>a[24]||(a[24]=[d(" Sin procesos activos ")])),_:1})]),_:1}))]),_:1}),a[27]||(a[27]=s("div",{class:"text-subtitle2 q-my-sm"},"Lotes Almacenados",-1)),e(E,{bordered:"",separator:"",dense:""},{default:t(()=>[(r(!0),b(I,null,P(l.ocupacionData.lotes_almacenados,o=>(r(),p(_,{key:o.id},{default:t(()=>[e(c,null,{default:t(()=>[e(q,null,{default:t(()=>[d(n(o.codigo_lote)+" - "+n(o.producto?.nombre_producto),1)]),_:2},1024),e(q,{caption:""},{default:t(()=>[d(n(o.fecha_produccion),1)]),_:2},1024)]),_:2},1024),e(c,{side:""},{default:t(()=>[e(q,null,{default:t(()=>[d(n(Number(o.cantidad_kg||0).toFixed(2))+" kg",1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),l.ocupacionData.lotes_almacenados?.length?N("",!0):(r(),p(_,{key:0},{default:t(()=>[e(c,{class:"text-grey-7 text-center"},{default:t(()=>a[25]||(a[25]=[d(" Sin lotes almacenados ")])),_:1})]),_:1}))]),_:1})])):N("",!0)]),_:1}),e(f),e(Q,{align:"right"},{default:t(()=>[h(e(y,{flat:"",label:"Cerrar"},null,512),[[v]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(O,{modelValue:l.dlgHistorial.open,"onUpdate:modelValue":a[11]||(a[11]=o=>l.dlgHistorial.open=o)},{default:t(()=>[e(g,{style:{"min-width":"700px","max-width":"90vw"}},{default:t(()=>[e(m,{class:"text-h6"},{default:t(()=>[d(" Historial de Procesos - "+n(l.dlgHistorial.row?.codigo_tanque),1)]),_:1}),e(f),e(m,null,{default:t(()=>[l.loadingHistorial?(r(),b("div",Ve,[e(T,{color:"primary",size:"3em"})])):(r(),p(A,{key:1,rows:l.historialData,columns:l.historialColumns,"row-key":"id",flat:"",bordered:"",dense:"","rows-per-page-options":[10]},{"body-cell-estado":t(o=>[e(k,{props:o},{default:t(()=>[e(S,{color:o.row.estado==="FINALIZADO"?"positive":"orange","text-color":"white",size:"sm",dense:""},{default:t(()=>[d(n(o.row.estado),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"]))]),_:1}),e(f),e(Q,{align:"right"},{default:t(()=>[h(e(y,{flat:"",label:"Cerrar"},null,512),[[v]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Ze=F(L,[["render",Ce],["__scopeId","data-v-20052d0a"]]);export{Ze as default};
