import{_ as I,c as g,o as u,w as r,b as i,a as t,f,a9 as _,a8 as h,aa as M,ab as F,t as n,P as E,d as C,a7 as p,ac as W,h as R,Q as x,e as b,O as U,ag as v,v as oo,aB as eo,aC as to,j as so,af as L,a6 as V,aj as io}from"./index-BYmx5CNZ.js";import{Q as S}from"./QSpace-yjffq0IW.js";import{Q as j}from"./QBanner-DRdTdlhT.js";import{Q as ro}from"./QLinearProgress--ydnym95.js";import{Q as w}from"./QTooltip-BGE4xi2l.js";import{Q as K,a as k,b as Y,c as A}from"./QTabPanels-COuTR9Jx.js";import{Q as Z}from"./QBadge-XCEdf9Kh.js";import{Q as ao}from"./QPage-p00VibaV.js";import{P as lo}from"./ProductorForm-C9A0eu9c.js";import{M as no,L as co,P as uo,a as mo,b as po,c as go}from"./MedicamentosFormulario-Cnp8mvGu.js";import{Q as X,b as T}from"./position-engine-WcV6P5pk.js";import{Q as fo}from"./QList-BvaTzhwT.js";import{Q as ho}from"./QBtnDropdown-De2p2AUs.js";import{Q as q}from"./QChip-BFVaIQP4.js";import{Q}from"./QMarkupTable-CxD-gDWx.js";import{Q as D}from"./QSelect-CE_gFS-5.js";import{Q as J}from"./QForm-BDdhN3pk.js";import{C as P}from"./ClosePopup-DF6m3UZZ.js";import{Q as _o}from"./QInnerLoading-C2gi1RYI.js";import"./auto-fljMw0yZ.js";import{h as H}from"./moment-C5S46NFB.js";import{C as bo}from"./chart-DihOV3X-.js";import"./selection-BcgxACWv.js";import"./QResizeObserver-CpmGT2BI.js";import"./use-panel-DWGxyhPB.js";import"./touch-BjYP5sR0.js";import"./use-render-cache-DLxPkVnQ.js";import"./marker-shadow-DgURvpVU.js";import"./QBtnGroup-CGN2IjQ1.js";import"./format-WFf_bcNU.js";const yo={name:"ProductorRunsas",props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm()}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},methods:{hydrateFromProductor(){this.productor?.runsas?this.list=this.productor.runsas:this.fetchRunsas()},async fetchRunsas(){console.log(this.productor),this.loading=!0;try{const{data:e}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});console.log(e),this.list=Array.isArray(e)?e:e?.data||[]}catch(e){console.log(e),this.list=[],this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(e){return e==="VIGENTE"?"green":e==="VENCIDO"?"red":e==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(e){this.form={id:e.id,productor_id:this.productor?.id||e.productor_id,codigo:e.codigo||null,subcodigo:e.subcodigo||"",fecha_registro:e.fecha_registro||null,fecha_vencimiento:e.fecha_vencimiento||null,estado:e.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const e={...this.form,productor_id:this.productor.id};e.id?await this.$axios.put(`runsas/${e.id}`,e):await this.$axios.post("runsas",e),this.$alert?.success?.(e.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(e){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${e.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(o){this.$alert?.error?.(o.response?.data?.message||"No se pudo eliminar")}})}}},vo={class:"row items-center q-gutter-sm q-mb-sm"},xo={key:0},Ao={class:"text-h6"},Co={class:"col-12 col-sm-4"},Vo={class:"col-12 col-sm-8"},ko={class:"col-6 col-sm-3"},wo={class:"col-6 col-sm-3"},Eo={class:"col-12 col-sm-3"},Po={class:"col-12 text-right q-gutter-sm q-mt-sm"};function No(e,o,d,m,s,l){return u(),g(b,null,{default:r(()=>[i("div",vo,[o[6]||(o[6]=i("div",{class:"text-subtitle1"},"Certificaciones Runsa",-1)),t(S),t(f,{dense:"",color:"primary",icon:"add_circle",label:"Nueva",onClick:l.startCreate,disable:s.saving,"no-caps":""},null,8,["onClick","disable"])]),t(Q,{dense:""},{default:r(()=>[o[10]||(o[10]=i("thead",null,[i("tr",{class:"bg-grey-3"},[i("th",{class:"text-left"},"#"),i("th",{class:"text-left",style:{width:"120px"}},"Opciones"),i("th",{class:"text-left"},"Codigo"),i("th",{class:"text-left"},"Subcodigo"),i("th",{class:"text-left"},"Registro"),i("th",{class:"text-left"},"Vencimiento"),i("th",{class:"text-left"},"Estado")])],-1)),i("tbody",null,[(u(!0),_(M,null,F(s.list||[],(c,N)=>(u(),_("tr",{key:c.id||N},[i("td",null,n(N+1),1),i("td",null,[t(ho,{dense:"",label:"Opciones",color:"primary","no-caps":"",size:"10px"},{default:r(()=>[t(fo,null,{default:r(()=>[E((u(),g(X,{clickable:"",onClick:O=>l.startEdit(c)},{default:r(()=>[t(T,{avatar:""},{default:r(()=>[t(C,{name:"edit"})]),_:1}),t(T,null,{default:r(()=>o[7]||(o[7]=[p("Editar")])),_:1})]),_:2},1032,["onClick"])),[[W],[P]]),E((u(),g(X,{clickable:"",onClick:O=>l.remove(c)},{default:r(()=>[t(T,{avatar:""},{default:r(()=>[t(C,{name:"delete",class:"text-negative"})]),_:1}),t(T,{class:"text-negative"},{default:r(()=>o[8]||(o[8]=[p("Eliminar")])),_:1})]),_:2},1032,["onClick"])),[[W],[P]])]),_:2},1024)]),_:2},1024)]),i("td",null,n(c.codigo||"-"),1),i("td",null,n(c.subcodigo||"-"),1),i("td",null,n(c.fecha_registro||"-"),1),i("td",null,n(c.fecha_vencimiento||"-"),1),i("td",null,[t(q,{color:l.chip(c.estado),"text-color":"white",size:"xs",class:"text-bold"},{default:r(()=>[p(n(c.estado),1)]),_:2},1032,["color"])])]))),128)),!s.loading&&(d.productor?.runsas?.length||0)===0?(u(),_("tr",xo,o[9]||(o[9]=[i("td",{colspan:"8",class:"text-center text-grey"},"Sin registros",-1)]))):h("",!0)])]),_:1}),t(R,{modelValue:s.dlg.open,"onUpdate:modelValue":o[5]||(o[5]=c=>s.dlg.open=c),persistent:""},{default:r(()=>[t(x,{style:{"min-width":"720px","max-width":"95vw"}},{default:r(()=>[t(b,{class:"row items-center q-gutter-sm"},{default:r(()=>[i("div",Ao,n(s.form.id?"Editar runsa":"Nueva runsa"),1),t(S),E(t(f,{flat:"",round:"",dense:"",icon:"close"},null,512),[[P]])]),_:1}),t(U),t(b,null,{default:r(()=>[t(J,{onSubmit:l.submit,class:"row q-col-gutter-sm"},{default:r(()=>[i("div",Co,[t(v,{modelValue:s.form.codigo,"onUpdate:modelValue":o[0]||(o[0]=c=>s.form.codigo=c),dense:"",outlined:"",label:"Codigo",rules:[c=>!!c||"Requerido"]},null,8,["modelValue","rules"])]),i("div",Vo,[t(v,{modelValue:s.form.subcodigo,"onUpdate:modelValue":o[1]||(o[1]=c=>s.form.subcodigo=c),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),i("div",ko,[t(v,{modelValue:s.form.fecha_registro,"onUpdate:modelValue":o[2]||(o[2]=c=>s.form.fecha_registro=c),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),i("div",wo,[t(v,{modelValue:s.form.fecha_vencimiento,"onUpdate:modelValue":o[3]||(o[3]=c=>s.form.fecha_vencimiento=c),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),i("div",Eo,[t(D,{modelValue:s.form.estado,"onUpdate:modelValue":o[4]||(o[4]=c=>s.form.estado=c),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),i("div",Po,[E(t(f,{flat:"",color:"grey",label:"Cancelar",disable:s.saving},null,8,["disable"]),[[P]]),t(f,{color:"primary",label:s.form.id?"Guardar cambios":"Crear",type:"submit",loading:s.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const qo=I(yo,[["render",No]]),So='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>',Uo=oo({name:"QSpinnerDots",props:eo,setup(e){const{cSize:o,classes:d}=to(e);return()=>so("svg",{class:d.value,fill:"currentColor",width:o.value,height:o.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:So})}}),Do={name:"ProductorAcopiosGestion",props:{productor:{type:Object,required:!0}},data(){return{loading:!1,loadingProductos:!1,loadingExcel:!1,gestionSeleccionada:H().year(),productoSeleccionado:1,gestiones:[],productos:[],datosProductor:null,meses:[],totalKg:0,totalEntregas:0,promedioEntrega:0,chartInstance:null}},computed:{datosDisponibles(){return this.meses.length>0&&this.totalKg>0}},mounted(){this.generarGestiones(),this.cargarProductos(),this.cargarAcopios()},beforeUnmount(){this.chartInstance&&this.chartInstance.destroy()},methods:{generarGestiones(){const e=H().year(),o=[];for(let d=e;d>=2020;d--)o.push(d);this.gestiones=o},async cargarProductos(){this.loadingProductos=!0;try{const{data:e}=await this.$axios.get("/productos/tipo/1");this.productos=e?.data||e||[],this.productos.length===0&&this.$alert?.warning?.("No se encontraron productos tipo miel")}catch(e){console.error("Error cargando productos:",e),this.$alert?.error?.("No se pudieron cargar los productos"),this.productos=[]}finally{this.loadingProductos=!1}},async cargarAcopios(){if(!this.productor?.id){console.error("No hay productor seleccionado");return}this.loading=!0;try{const{data:e}=await this.$axios.get(`/productores/${this.productor.id}/acopios-gestion`,{params:{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado}});this.datosProductor={productor:e.productor,runsa:e.runsa,municipio:e.municipio,organizacion:e.organizacion},this.meses=e.meses||[],this.totalKg=Number(e.total_kg||0),this.totalEntregas=Number(e.total_entregas||0),this.promedioEntrega=Number(e.promedio_entrega||0),this.$nextTick(()=>{this.renderChart()})}catch(e){console.error("Error cargando acopios:",e),this.$alert?.error?.(e.response?.data?.message||"Error al cargar acopios por gestión"),this.meses=[],this.totalKg=0,this.totalEntregas=0,this.promedioEntrega=0}finally{this.loading=!1}},renderChart(){if(!this.$refs.chartCanvas){console.warn("Canvas no está disponible");return}this.chartInstance&&this.chartInstance.destroy();const e=this.meses.map(m=>m.mes_nombre),o=this.meses.map(m=>Number(m.cantidad_kg)),d=this.meses.map(m=>Number(m.num_entregas));this.chartInstance=new bo(this.$refs.chartCanvas,{type:"bar",data:{labels:e,datasets:[{label:"Cantidad (kg)",data:o,backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,yAxisID:"y"},{label:"N° Entregas",data:d,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:1,type:"line",yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"},title:{display:!0,text:`Acopios Gestión ${this.gestionSeleccionada} (Julio-Junio)`},tooltip:{callbacks:{footer:m=>{const s=m[0].dataIndex,l=this.meses[s];return l&&l.num_entregas>0?`Promedio/entrega: ${(l.cantidad_kg/l.num_entregas).toFixed(2)} kg`:""}}}},scales:{y:{type:"linear",position:"left",beginAtZero:!0,title:{display:!0,text:"Kilogramos (kg)"}},y1:{type:"linear",position:"right",beginAtZero:!0,title:{display:!0,text:"Número de entregas"},grid:{drawOnChartArea:!1}}}}})},formatNumber(e){const o=Number(e);return isNaN(o)?"0.00":o.toFixed(2)},async exportarExcel(){if(!this.datosDisponibles){this.$alert?.warning?.("No hay datos para exportar");return}this.loadingExcel=!0;try{const e=await this.$axios.post(`/productores/${this.productor.id}/acopios-gestion-excel`,{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado},{responseType:"blob"}),o=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),d=window.URL.createObjectURL(o),m=document.createElement("a");m.href=d;const s=this.datosProductor?.productor?.replace(/\s+/g,"_")||"productor";m.setAttribute("download",`acopios_${s}_${this.gestionSeleccionada}.xlsx`),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(d),this.$alert?.success?.("Archivo Excel descargado correctamente")}catch(e){console.error("Error exportando a Excel:",e),this.$alert?.error?.(e.response?.data?.message||"No se pudo generar el archivo Excel")}finally{this.loadingExcel=!1}}}},Oo={class:"row items-center q-gutter-sm q-mb-md"},Mo={class:"row q-col-gutter-md"},Fo={class:"col-auto"},To={class:"text-weight-medium"},Ro={key:0,class:"col-auto"},Qo={class:"text-weight-medium"},Io={key:1,class:"col-auto"},zo={class:"text-weight-medium"},Go={key:2,class:"col-auto"},Bo={class:"text-weight-medium"},Lo={class:"text-left"},jo={class:"text-weight-medium"},Ko={key:0,class:"text-caption text-grey-7 q-ml-xs"},Yo={class:"text-right"},Jo={class:"text-right"},Ho={key:1,class:"text-grey-5"},Wo={class:"text-right"},Zo={key:0,class:"text-grey-8"},Xo={key:1,class:"text-grey-5"},$o={class:"bg-grey-3 text-weight-bold"},oe={class:"text-left text-uppercase"},ee={class:"text-right text-primary"},te={class:"text-right"},se={class:"text-right text-grey-8"},ie={class:"text-caption text-grey-5"},re={class:"text-subtitle2 q-mb-md"},ae={ref:"chartCanvas",height:"100"};function le(e,o,d,m,s,l){return u(),g(b,null,{default:r(()=>[i("div",Oo,[o[4]||(o[4]=i("div",{class:"text-subtitle1 text-weight-medium"},"Acopios por Gestión (Julio-Junio)",-1)),t(S),t(D,{modelValue:s.gestionSeleccionada,"onUpdate:modelValue":[o[0]||(o[0]=c=>s.gestionSeleccionada=c),l.cargarAcopios],options:s.gestiones,label:"Gestión",dense:"",outlined:"",style:{"min-width":"130px"},loading:s.loading},{prepend:r(()=>[t(C,{name:"event"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),t(D,{modelValue:s.productoSeleccionado,"onUpdate:modelValue":[o[1]||(o[1]=c=>s.productoSeleccionado=c),l.cargarAcopios],options:s.productos,"option-label":"nombre_producto","option-value":"id","emit-value":"","map-options":"",label:"Producto",dense:"",outlined:"",style:{"min-width":"200px"},loading:s.loadingProductos},{prepend:r(()=>[t(C,{name:"inventory"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),t(f,{color:"green",icon:"download",label:"Excel",dense:"","no-caps":"",onClick:l.exportarExcel,loading:s.loadingExcel,disable:!l.datosDisponibles},{default:r(()=>[l.datosDisponibles?h("",!0):(u(),g(w,{key:0},{default:r(()=>o[2]||(o[2]=[p(" No hay datos para exportar ")])),_:1}))]),_:1},8,["onClick","loading","disable"]),t(f,{color:"primary",icon:"refresh",dense:"",round:"",flat:"",onClick:l.cargarAcopios,loading:s.loading},{default:r(()=>[t(w,null,{default:r(()=>o[3]||(o[3]=[p("Recargar datos")])),_:1})]),_:1},8,["onClick","loading"])]),s.datosProductor?(u(),g(j,{key:0,dense:"",class:"bg-blue-1 q-mb-md",rounded:""},{avatar:r(()=>[t(C,{name:"person",color:"primary"})]),default:r(()=>[i("div",Mo,[i("div",Fo,[o[5]||(o[5]=i("div",{class:"text-caption text-grey-7"},"Productor",-1)),i("div",To,n(s.datosProductor.productor),1)]),s.datosProductor.runsa?(u(),_("div",Ro,[o[6]||(o[6]=i("div",{class:"text-caption text-grey-7"},"RUNSA",-1)),i("div",Qo,n(s.datosProductor.runsa),1)])):h("",!0),s.datosProductor.municipio?(u(),_("div",Io,[o[7]||(o[7]=i("div",{class:"text-caption text-grey-7"},"Municipio",-1)),i("div",zo,n(s.datosProductor.municipio),1)])):h("",!0),s.datosProductor.organizacion?(u(),_("div",Go,[o[8]||(o[8]=i("div",{class:"text-caption text-grey-7"},"Organización",-1)),i("div",Bo,n(s.datosProductor.organizacion),1)])):h("",!0)])]),_:1})):h("",!0),t(x,{flat:"",bordered:""},{default:r(()=>[t(b,{class:"q-pa-none"},{default:r(()=>[t(Q,{dense:"",flat:""},{default:r(()=>[o[9]||(o[9]=i("thead",null,[i("tr",{class:"bg-primary text-white"},[i("th",{class:"text-left",style:{width:"30%"}},"Mes"),i("th",{class:"text-right",style:{width:"25%"}},"Cantidad (kg)"),i("th",{class:"text-right",style:{width:"20%"}},"N° Entregas"),i("th",{class:"text-right",style:{width:"25%"}},"Promedio/Entrega")])],-1)),i("tbody",null,[(u(!0),_(M,null,F(s.meses,c=>(u(),_("tr",{key:c.offset_mes,class:L({"bg-grey-2":c.num_entregas===0})},[i("td",Lo,[i("span",jo,n(c.mes_nombre),1),c.anio_mes?(u(),_("span",Ko,n(c.anio_mes),1)):h("",!0)]),i("td",Yo,[i("span",{class:L({"text-weight-bold":c.num_entregas>0})},n(l.formatNumber(c.cantidad_kg)),3)]),i("td",Jo,[c.num_entregas>0?(u(),g(q,{key:0,dense:"",size:"sm",color:"blue-2","text-color":"blue-9"},{default:r(()=>[p(n(c.num_entregas),1)]),_:2},1024)):(u(),_("span",Ho,"-"))]),i("td",Wo,[c.num_entregas>0?(u(),_("span",Zo,n(l.formatNumber(c.cantidad_kg/c.num_entregas)),1)):(u(),_("span",Xo,"-"))])],2))),128)),i("tr",$o,[i("td",oe," Total Gestión "+n(s.gestionSeleccionada),1),i("td",ee,n(l.formatNumber(s.totalKg)),1),i("td",te,[t(q,{dense:"",color:"primary","text-color":"white"},{default:r(()=>[p(n(s.totalEntregas),1)]),_:1})]),i("td",se,n(l.formatNumber(s.promedioEntrega)),1)])])]),_:1})]),_:1}),!s.loading&&s.meses.length===0?(u(),g(b,{key:0,class:"text-center q-pa-lg"},{default:r(()=>[t(C,{name:"info_outline",size:"48px",color:"grey-5"}),o[10]||(o[10]=i("div",{class:"text-subtitle2 text-grey-6 q-mt-sm"}," Sin acopios registrados para esta gestión ",-1)),i("div",ie," Período: "+n(s.gestionSeleccionada)+"-07-01 a "+n(s.gestionSeleccionada+1)+"-06-30 ",1)]),_:1})):h("",!0),t(_o,{showing:s.loading},{default:r(()=>[t(Uo,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),l.datosDisponibles&&!s.loading?(u(),g(x,{key:1,flat:"",bordered:"",class:"q-mt-md"},{default:r(()=>[t(b,null,{default:r(()=>[i("div",re,[t(C,{name:"bar_chart",color:"primary",class:"q-mr-xs"}),p(" Gráfica de Acopios Mensuales - Gestión "+n(s.gestionSeleccionada),1)]),i("canvas",ae,null,512)]),_:1})]),_:1})):h("",!0)]),_:1})}const $=I(Do,[["render",le],["__scopeId","data-v-527d71aa"]]),ne={name:"ProductorAcopios",components:{PlagasFormulario:uo,LimpiezasFormulario:co,MedicamentosFormulario:no,ProductorAcopiosGestion:$},props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm(),acopioCosechas:[],tab:"detalle",formulariosDialog:{open:!1,cosecha:null,tab:"plagas"},dialogNuevoAcopio:!1,loadingGuardar:!1,loadingApiariosModal:!1,loadingProductos:!1,apiarioOptionsModal:[],productosOptions:[],formAcopio:{fecha_cosecha:null,num_acta:"",apiario_id:null,producto_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"BALDE",observaciones:"",estado:"BUENO"}}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},computed:{totals(){let e=0,o=0;return this.acopioCosechas.forEach(d=>{const m=parseFloat(d.cantidad_kg||0),s=parseFloat(d.precio_compra||0);e+=m,o+=m*s}),{totalKg:e,totalMonto:o}},monthlyAggregates(){const e={};return this.acopioCosechas.forEach(o=>{if(!o.fecha_cosecha)return;const d=H(o.fecha_cosecha);if(!d.isValid())return;const m=d.format("YYYY-MM"),s=d.format("MMM YYYY"),l=parseFloat(o.cantidad_kg||0),c=parseFloat(o.precio_compra||0),N=l*c;e[m]||(e[m]={key:m,label:s,totalKg:0,totalMonto:0}),e[m].totalKg+=l,e[m].totalMonto+=N}),Object.values(e).sort((o,d)=>o.key.localeCompare(d.key))},monthlyChartOptions(){return{chart:{id:"acopios-mensuales",toolbar:{show:!1}},xaxis:{categories:this.monthlyAggregates.map(e=>e.label)},dataLabels:{enabled:!0,enabledOnSeries:[0]},stroke:{width:[0,3]},yaxis:[{title:{text:"Kg"}},{opposite:!0,title:{text:"Bs"}}],legend:{position:"top"},tooltip:{shared:!0,intersect:!1}}},monthlyChartSeries(){const e=this.monthlyAggregates.map(d=>d.totalKg),o=this.monthlyAggregates.map(d=>d.totalMonto);return[{name:"Kg",type:"column",data:e},{name:"Monto (Bs)",type:"line",data:o}]}},methods:{async fetchAcopio(){if(this.productor?.id){this.loading=!0;try{const{data:e}=await this.$axios.post("/productorAcopios",{productor_id:this.productor.id});this.acopioCosechas=e}catch(e){console.log(e),this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar las cosechas")}finally{this.loading=!1}}},hydrateFromProductor(){this.fetchAcopio()},async fetchRunsas(){if(this.productor?.id){this.loading=!0;try{const{data:e}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});this.list=Array.isArray(e)?e:e?.data||[]}catch(e){console.log(e),this.list=[],this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(e){return e==="VIGENTE"?"green":e==="VENCIDO"?"red":e==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(e){this.form={id:e.id,productor_id:this.productor?.id||e.productor_id,codigo:e.codigo||null,subcodigo:e.subcodigo||"",fecha_registro:e.fecha_registro||null,fecha_vencimiento:e.fecha_vencimiento||null,estado:e.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const e={...this.form,productor_id:this.productor.id};e.id?await this.$axios.put(`runsas/${e.id}`,e):await this.$axios.post("runsas",e),this.$alert?.success?.(e.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(e){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${e.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(o){this.$alert?.error?.(o.response?.data?.message||"No se pudo eliminar")}})},async openFormulariosDialog(e){try{const{data:o}=await this.$axios.get(`/acopio-cosechas/${e.id}`);this.formulariosDialog.cosecha=o,this.formulariosDialog.tab="plagas",this.formulariosDialog.open=!0}catch{this.formulariosDialog.cosecha=e,this.formulariosDialog.tab="plagas",this.formulariosDialog.open=!0}},calcularCostoTotal(e){const o=parseFloat(e.cantidad_kg||0),d=parseFloat(e.precio_compra||0);return(o*d).toFixed(2)},obtenerColorEstado(e){return{BUENO:"green",EN_PROCESO:"orange",CANCELADO:"red"}[e]||"grey"},obtenerLabelEstado(e){return{BUENO:"Acopiado",EN_PROCESO:"En Revisión",CANCELADO:"Cancelado"}[e]||e},procesarAcopio(e){if(e.estado!=="BUENO"){this.$q.notify({type:"warning",message:"Solo se pueden procesar acopios en estado Acopiado"});return}this.$q.dialog({title:"Procesar Acopio",message:`¿Esta seguro de enviar a revision el acopio del ${e.fecha_cosecha}?`,cancel:{label:"Cancelar",flat:!0,color:"grey"},ok:{label:"Procesar",color:"purple"},persistent:!0}).onOk(async()=>{try{await this.$axios.put(`/acopio-cosechas/${e.id}`,{...e,estado:"EN_PROCESO"}),this.$q.notify({type:"positive",message:"Acopio enviado a revision correctamente"}),this.fetchAcopio()}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"No se pudo procesar el acopio"})}})},imprimirActaConformidad(e){this.$q.notify({type:"info",message:"Funcionalidad en desarrollo - Acta de Conformidad",caption:"Se implementara en la siguiente fase"})},imprimirActaEntrega(e){this.$q.notify({type:"info",message:"Funcionalidad en desarrollo - Acta de Entrega",caption:"Se implementara en la siguiente fase"})},imprimirRecibo(e){this.$q.notify({type:"info",message:"Funcionalidad en desarrollo - Recibo de Compra",caption:"Se implementara en la siguiente fase"})},async abrirModalNuevoAcopio(){if(!this.productor?.id){this.$q.notify({type:"warning",message:"No se pudo identificar el productor"});return}const e=new Date,o=e.getFullYear(),m=`${e.getTime().toString().slice(-6)}/${o}`;this.formAcopio={fecha_cosecha:e.toISOString().split("T")[0],num_acta:m,apiario_id:null,producto_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"BALDE",observaciones:"",estado:"BUENO"},await this.cargarApiariosModal(),await this.cargarProductos(),this.dialogNuevoAcopio=!0},async cargarApiariosModal(){if(this.productor?.id){this.loadingApiariosModal=!0;try{const{data:e}=await this.$axios.get("/apiarios",{params:{productor_id:this.productor.id,paginate:!1}});this.apiarioOptionsModal=(e||[]).map(o=>({value:o.id,label:o.nombre_cip?`${o.nombre_cip} — ${o?.municipio?.nombre_municipio??""}`:`Apiario #${o.id} — ${o?.municipio?.nombre_municipio??""}`})),this.apiarioOptionsModal.length===1&&(this.formAcopio.apiario_id=this.apiarioOptionsModal[0].value)}catch(e){console.error("Error cargando apiarios:",e),this.$q.notify({type:"negative",message:"No se pudieron cargar los apiarios del productor"})}finally{this.loadingApiariosModal=!1}}},async cargarProductos(){this.loadingProductos=!0;try{const{data:e}=await this.$axios.get("/productos/tipo/1");this.productosOptions=(e?.data||e||[]).map(d=>({value:d.id,label:d.nombre_producto}));const o=this.productosOptions.find(d=>d.label.toLowerCase().includes("miel"));o&&(this.formAcopio.producto_id=o.value)}catch(e){console.error("Error cargando productos:",e),this.$q.notify({type:"negative",message:"No se pudieron cargar los productos"})}finally{this.loadingProductos=!1}},async guardarAcopio(){if(!await this.$refs.formAcopioRef.validate())return;this.loadingGuardar=!0;const o=!!this.formAcopio.id;try{let d;o?d=(await this.$axios.put(`/acopio-cosechas/${this.formAcopio.id}`,this.formAcopio)).data:d=(await this.$axios.post("/acopio-cosechas",this.formAcopio)).data,this.dialogNuevoAcopio=!1,this.$q.notify({type:"positive",message:o?"Acopio actualizado exitosamente":"Acopio registrado exitosamente",caption:`Acta: ${d.num_acta||this.formAcopio.num_acta}`,timeout:3e3}),setTimeout(async()=>{try{await this.fetchAcopio()}catch(m){console.warn("Error recargando lista de acopios:",m),setTimeout(()=>{this.fetchAcopio()},1e3)}},500)}catch(d){console.error("Error guardando acopio:",d);const m=d.response?.data?.message||"";m.includes("num_acta")?this.$q.notify({type:"warning",message:"El número de acta ya existe",caption:"Por favor, modifique el número de acta e intente nuevamente",timeout:4e3}):this.$q.notify({type:"negative",message:o?"Error al actualizar el acopio":"Error al guardar el acopio",caption:m||"Intente nuevamente",timeout:3e3})}finally{this.loadingGuardar=!1}},async editarAcopio(e){if(!e?.id){this.$q.notify({type:"warning",message:"No se pudo identificar el acopio"});return}await this.cargarApiariosModal(),await this.cargarProductos(),this.formAcopio={id:e.id,fecha_cosecha:e.fecha_cosecha,num_acta:e.num_acta,apiario_id:e.apiario_id,producto_id:e.producto_id,cantidad_kg:e.cantidad_kg,precio_compra:e.precio_compra,humedad:e.humedad,temperatura_almacenaje:e.temperatura_almacenaje,procedencia:e.procedencia,tipo_envase:e.tipo_envase,observaciones:e.observaciones,estado:e.estado},this.dialogNuevoAcopio=!0},eliminarAcopio(e){if(!e?.id){this.$q.notify({type:"warning",message:"No se pudo identificar el acopio"});return}this.$q.dialog({title:"Confirmar eliminación",message:`¿Está seguro de eliminar el acopio con Acta ${e.num_acta}?`,html:!0,ok:{push:!0,color:"negative",label:"Eliminar"},cancel:{push:!0,color:"grey-7",label:"Cancelar"},persistent:!0}).onOk(async()=>{try{await this.$axios.delete(`/acopio-cosechas/${e.id}`),this.$q.notify({type:"positive",message:"Acopio eliminado exitosamente",caption:`Acta: ${e.num_acta}`,timeout:3e3}),await this.fetchAcopio()}catch(o){console.error("Error eliminando acopio:",o),this.$q.notify({type:"negative",message:"Error al eliminar el acopio",caption:o.response?.data?.message||"Intente nuevamente",timeout:3e3})}})}}},de={class:"row items-center q-gutter-sm q-mb-md"},ce={class:"row items-center q-gutter-sm q-mt-sm q-mb-sm"},ue={class:"text-center"},me={class:"text-center"},pe={class:"q-gutter-xs"},ge={class:"text-right"},fe={class:"text-right"},he={class:"text-right"},_e={class:"text-center"},be={class:"text-center"},ye={class:"q-gutter-xs"},ve={key:1,class:"text-center q-pa-md"},xe={key:0},Ae={class:"q-mt-md"},Ce={key:1,class:"text-center q-pa-md"},Ve={class:"text-h6"},ke={class:"row q-col-gutter-md"},we={class:"col-12 col-md-4"},Ee={class:"col-12 col-md-4"},Pe={class:"col-12 col-md-4"},Ne={class:"col-12 col-md-6"},qe={class:"col-12 col-md-3"},Se={class:"col-12 col-md-3"},Ue={class:"col-6 col-md-3"},De={class:"col-6 col-md-3"},Oe={class:"col-6 col-md-3"},Me={class:"col-6 col-md-3"},Fe={class:"col-12"},Te={class:"row q-gutter-sm q-mt-md justify-end"},Re={class:"text-h6"},Qe={class:"col-12 col-sm-4"},Ie={class:"col-12 col-sm-8"},ze={class:"col-6 col-sm-3"},Ge={class:"col-6 col-sm-3"},Be={class:"col-12 col-sm-3"},Le={class:"col-12 text-right q-gutter-sm q-mt-sm"},je={class:"row q-col-gutter-sm"},Ke={class:"col-12 col-md-3"},Ye={class:"text-body1"},Je={class:"col-12 col-md-3"},He={class:"text-body1"},We={class:"col-12 col-md-2"},Ze={class:"text-body1"},Xe={class:"col-12 col-md-2"},$e={class:"text-body1"},ot={class:"col-12 col-md-2"};function et(e,o,d,m,s,l){const c=V("apexchart"),N=V("ProductorAcopiosGestion"),O=V("PlagasFormulario"),z=V("LimpiezasFormulario"),G=V("MedicamentosFormulario");return u(),g(b,null,{default:r(()=>[i("div",de,[o[24]||(o[24]=i("div",{class:"text-subtitle1"}," Registro de Acopios del Proveedoor ",-1)),t(S),t(f,{color:"positive",icon:"add",label:"Nuevo Acopio",dense:"","no-caps":"",onClick:l.abrirModalNuevoAcopio},{default:r(()=>[t(w,null,{default:r(()=>o[23]||(o[23]=[p("Registrar nuevo acopio para este productor")])),_:1})]),_:1},8,["onClick"])]),t(K,{modelValue:s.tab,"onUpdate:modelValue":o[0]||(o[0]=a=>s.tab=a),dense:"",align:"left","active-color":"primary","indicator-color":"primary",class:"text-primary"},{default:r(()=>[t(k,{name:"detalle",label:"Lista de Acopios",icon:"table_view"}),t(k,{name:"resumen",label:"Proyección mensual",icon:"analytics"}),t(k,{name:"gestion",label:"Gestión anual",icon:"event_note"})]),_:1},8,["modelValue"]),i("div",ce,[t(q,{color:"primary","text-color":"white",dense:""},{default:r(()=>[p(" Total Kg: "+n(l.totals.totalKg.toFixed(2)),1)]),_:1}),t(q,{color:"amber-7","text-color":"black",dense:""},{default:r(()=>[p(" Total compra: "+n(l.totals.totalMonto.toFixed(2))+" Bs ",1)]),_:1}),t(q,{color:"grey-8","text-color":"white",dense:""},{default:r(()=>[p(" Nº cosechas: "+n(s.acopioCosechas.length),1)]),_:1})]),t(U,{class:"q-mb-md"}),t(Y,{modelValue:s.tab,"onUpdate:modelValue":o[1]||(o[1]=a=>s.tab=a),animated:""},{default:r(()=>[t(A,{name:"detalle"},{default:r(()=>[s.acopioCosechas.length>0?(u(),g(Q,{key:0,dense:"","wrap-cells":"",flat:"",bordered:""},{default:r(()=>[o[32]||(o[32]=i("thead",null,[i("tr",{class:"bg-primary text-white"},[i("th",{style:{width:"50px"}},"#"),i("th",{style:{width:"180px"}},"Opciones"),i("th",null,"Fecha Cosecha"),i("th",null,"Número Acta"),i("th",null,"Productor"),i("th",null,"Tipo Materia Prima"),i("th",{class:"text-right"},"Peso Total (Kg)"),i("th",{class:"text-right"},"Precio Bs."),i("th",{class:"text-right"},"Costo Total"),i("th",null,"Estado"),i("th",{style:{width:"120px"}},"Formularios de CONTROL"),i("th",{style:{width:"100px"}},"Acciones")])],-1)),i("tbody",null,[(u(!0),_(M,null,F(s.acopioCosechas,(a,B)=>(u(),_("tr",{key:a.id},[i("td",ue,n(B+1),1),i("td",me,[i("div",pe,[t(f,{flat:"",dense:"",round:"",color:"blue",icon:"description",size:"sm",onClick:y=>l.imprimirActaConformidad(a)},{default:r(()=>[t(w,null,{default:r(()=>o[25]||(o[25]=[p("Acta de Conformidad")])),_:1})]),_:2},1032,["onClick"]),t(f,{flat:"",dense:"",round:"",color:"green",icon:"local_shipping",size:"sm",onClick:y=>l.imprimirActaEntrega(a)},{default:r(()=>[t(w,null,{default:r(()=>o[26]||(o[26]=[p("Acta de Entrega")])),_:1})]),_:2},1032,["onClick"]),t(f,{flat:"",dense:"",round:"",color:"orange",icon:"receipt",size:"sm",onClick:y=>l.imprimirRecibo(a)},{default:r(()=>[t(w,null,{default:r(()=>o[27]||(o[27]=[p("Recibo")])),_:1})]),_:2},1032,["onClick"]),t(f,{flat:"",dense:"",round:"",color:"purple",icon:"sync",size:"sm",onClick:y=>l.procesarAcopio(a),disable:a.estado!=="BUENO"},{default:r(()=>[t(w,null,{default:r(()=>o[28]||(o[28]=[p("Procesar (Enviar a Revisión)")])),_:1})]),_:2},1032,["onClick","disable"])])]),i("td",null,n(a.fecha_cosecha),1),i("td",null,n(a.num_acta),1),i("td",null,n(a.apiario?.productor.nombre)+" "+n(a.apiario?.productor.apellidos),1),i("td",null,n(a.producto?.nombre_producto||"N/A"),1),i("td",ge,n(Number(a.cantidad_kg).toFixed(2)),1),i("td",fe,n(Number(a.precio_compra||0).toFixed(2)),1),i("td",he,n(l.calcularCostoTotal(a)),1),i("td",null,[t(q,{color:l.obtenerColorEstado(a.estado),"text-color":"white",dense:"",size:"10px"},{default:r(()=>[p(n(l.obtenerLabelEstado(a.estado)),1)]),_:2},1032,["color"])]),i("td",_e,[t(f,{flat:"",dense:"",color:"primary",icon:"description",size:"sm",onClick:y=>l.openFormulariosDialog(a)},{default:r(()=>[t(w,null,{default:r(()=>o[29]||(o[29]=[p("Ver Formularios de Control del SENASAG")])),_:1})]),_:2},1032,["onClick"])]),i("td",be,[i("div",ye,[t(f,{flat:"",dense:"",round:"",color:"primary",icon:"edit",size:"sm",onClick:y=>l.editarAcopio(a)},{default:r(()=>[t(w,null,{default:r(()=>o[30]||(o[30]=[p("Editar acopio")])),_:1})]),_:2},1032,["onClick"]),t(f,{flat:"",dense:"",round:"",color:"negative",icon:"delete",size:"sm",onClick:y=>l.eliminarAcopio(a)},{default:r(()=>[t(w,null,{default:r(()=>o[31]||(o[31]=[p("Eliminar acopio")])),_:1})]),_:2},1032,["onClick"])])])]))),128))])]),_:1})):(u(),_("div",ve,[t(C,{name:"info",size:"48px",color:"grey-5"}),o[33]||(o[33]=i("div",{class:"text-subtitle2 text-grey-5"},"No se encontraron cosechas.",-1))]))]),_:1}),t(A,{name:"resumen"},{default:r(()=>[l.monthlyAggregates.length?(u(),_("div",xe,[t(Q,{dense:"",flat:"",bordered:"",class:"q-mb-md"},{default:r(()=>[o[34]||(o[34]=i("thead",null,[i("tr",{class:"bg-primary text-white"},[i("th",null,"Mes"),i("th",null,"Total Kg"),i("th",null,"Total compra (Bs)")])],-1)),i("tbody",null,[(u(!0),_(M,null,F(l.monthlyAggregates,a=>(u(),_("tr",{key:a.key},[i("td",null,n(a.label),1),i("td",null,n(a.totalKg.toFixed(2)),1),i("td",null,n(a.totalMonto.toFixed(2)),1)]))),128))])]),_:1}),i("div",Ae,[t(c,{type:"line",height:"320",options:l.monthlyChartOptions,series:l.monthlyChartSeries},null,8,["options","series"])])])):(u(),_("div",Ce,[t(C,{name:"insert_chart_outlined",size:"48px",color:"grey-5"}),o[35]||(o[35]=i("div",{class:"text-subtitle2 text-grey-5"}," Aún no hay datos suficientes para el resumen mensual. ",-1))]))]),_:1}),t(A,{name:"gestion"},{default:r(()=>[d.productor?(u(),g(N,{key:0,productor:d.productor},null,8,["productor"])):h("",!0)]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:s.dialogNuevoAcopio,"onUpdate:modelValue":o[13]||(o[13]=a=>s.dialogNuevoAcopio=a),persistent:""},{default:r(()=>[t(x,{style:{"min-width":"700px","max-width":"90vw"}},{default:r(()=>[t(b,{class:"row items-center q-pb-none"},{default:r(()=>[i("div",Ve,n(s.formAcopio.id?"Editar":"Nuevo")+" Acopio - "+n(d.productor?.nombre)+" "+n(d.productor?.apellidos),1),t(S),E(t(f,{icon:"close",flat:"",round:"",dense:""},null,512),[[P]])]),_:1}),t(b,null,{default:r(()=>[t(J,{ref:"formAcopioRef",onSubmit:io(l.guardarAcopio,["prevent"])},{default:r(()=>[i("div",ke,[i("div",we,[t(v,{modelValue:s.formAcopio.fecha_cosecha,"onUpdate:modelValue":o[2]||(o[2]=a=>s.formAcopio.fecha_cosecha=a),type:"date",label:"Fecha de Cosecha",dense:"",outlined:"",rules:[a=>!!a||"Requerido"]},null,8,["modelValue","rules"])]),i("div",Ee,[t(v,{modelValue:s.formAcopio.num_acta,"onUpdate:modelValue":o[3]||(o[3]=a=>s.formAcopio.num_acta=a),label:"Número de Acta",dense:"",outlined:"",rules:[a=>!!a||"Requerido"]},null,8,["modelValue","rules"])]),i("div",Pe,[t(D,{modelValue:s.formAcopio.apiario_id,"onUpdate:modelValue":o[4]||(o[4]=a=>s.formAcopio.apiario_id=a),options:s.apiarioOptionsModal,"option-value":"value","option-label":"label","emit-value":"","map-options":"",label:"Apiario",dense:"",outlined:"",loading:s.loadingApiariosModal,rules:[a=>!!a||"Seleccione un apiario"]},null,8,["modelValue","options","loading","rules"])]),i("div",Ne,[t(D,{modelValue:s.formAcopio.producto_id,"onUpdate:modelValue":o[5]||(o[5]=a=>s.formAcopio.producto_id=a),options:s.productosOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",label:"Tipo de Materia Prima",dense:"",outlined:"",loading:s.loadingProductos,rules:[a=>!!a||"Requerido"]},null,8,["modelValue","options","loading","rules"])]),i("div",qe,[t(v,{modelValue:s.formAcopio.cantidad_kg,"onUpdate:modelValue":o[6]||(o[6]=a=>s.formAcopio.cantidad_kg=a),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Cantidad (kg)",dense:"",outlined:"",suffix:"kg",rules:[a=>a>0||"Mayor a 0"]},null,8,["modelValue","rules"])]),i("div",Se,[t(v,{modelValue:s.formAcopio.precio_compra,"onUpdate:modelValue":o[7]||(o[7]=a=>s.formAcopio.precio_compra=a),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Precio de compra",dense:"",outlined:"",prefix:"Bs ",rules:[a=>a>=0||"No negativo"]},null,8,["modelValue","rules"])]),i("div",Ue,[t(v,{modelValue:s.formAcopio.humedad,"onUpdate:modelValue":o[8]||(o[8]=a=>s.formAcopio.humedad=a),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Humedad (%)",dense:"",outlined:"",suffix:"%"},null,8,["modelValue"])]),i("div",De,[t(v,{modelValue:s.formAcopio.temperatura_almacenaje,"onUpdate:modelValue":o[9]||(o[9]=a=>s.formAcopio.temperatura_almacenaje=a),modelModifiers:{number:!0},type:"number",step:"0.01",label:"Temperatura (°C)",dense:"",outlined:"",suffix:"°C"},null,8,["modelValue"])]),i("div",Oe,[t(v,{modelValue:s.formAcopio.procedencia,"onUpdate:modelValue":o[10]||(o[10]=a=>s.formAcopio.procedencia=a),label:"Procedencia",dense:"",outlined:"",maxlength:"50"},null,8,["modelValue"])]),i("div",Me,[t(D,{modelValue:s.formAcopio.tipo_envase,"onUpdate:modelValue":o[11]||(o[11]=a=>s.formAcopio.tipo_envase=a),label:"Tipo de envase",dense:"",outlined:"",options:["BALDE","OTRO"]},null,8,["modelValue"])]),i("div",Fe,[t(v,{modelValue:s.formAcopio.observaciones,"onUpdate:modelValue":o[12]||(o[12]=a=>s.formAcopio.observaciones=a),label:"Observaciones",dense:"",outlined:"",autogrow:"",maxlength:"255"},null,8,["modelValue"])])]),i("div",Te,[E(t(f,{label:"Cancelar",color:"grey-7",flat:"","no-caps":""},null,512),[[P]]),t(f,{type:"submit",label:s.formAcopio.id?"Actualizar Acopio":"Guardar Acopio",color:"positive",icon:"save",loading:s.loadingGuardar,"no-caps":""},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:s.dlg.open,"onUpdate:modelValue":o[19]||(o[19]=a=>s.dlg.open=a),persistent:""},{default:r(()=>[t(x,{style:{"min-width":"720px","max-width":"95vw"}},{default:r(()=>[t(b,{class:"row items-center q-gutter-sm"},{default:r(()=>[i("div",Re,n(s.form.id?"Editar runsa":"Nueva runsa"),1),t(S),E(t(f,{flat:"",round:"",dense:"",icon:"close"},null,512),[[P]])]),_:1}),t(U),t(b,null,{default:r(()=>[t(J,{onSubmit:l.submit,class:"row q-col-gutter-sm"},{default:r(()=>[i("div",Qe,[t(v,{modelValue:s.form.codigo,"onUpdate:modelValue":o[14]||(o[14]=a=>s.form.codigo=a),dense:"",outlined:"",label:"Codigo",rules:[a=>!!a||"Requerido"]},null,8,["modelValue","rules"])]),i("div",Ie,[t(v,{modelValue:s.form.subcodigo,"onUpdate:modelValue":o[15]||(o[15]=a=>s.form.subcodigo=a),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),i("div",ze,[t(v,{modelValue:s.form.fecha_registro,"onUpdate:modelValue":o[16]||(o[16]=a=>s.form.fecha_registro=a),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),i("div",Ge,[t(v,{modelValue:s.form.fecha_vencimiento,"onUpdate:modelValue":o[17]||(o[17]=a=>s.form.fecha_vencimiento=a),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),i("div",Be,[t(D,{modelValue:s.form.estado,"onUpdate:modelValue":o[18]||(o[18]=a=>s.form.estado=a),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),i("div",Le,[E(t(f,{flat:"",color:"grey",label:"Cancelar",disable:s.saving},null,8,["disable"]),[[P]]),t(f,{color:"primary",label:s.form.id?"Guardar cambios":"Crear",type:"submit",loading:s.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:s.formulariosDialog.open,"onUpdate:modelValue":o[22]||(o[22]=a=>s.formulariosDialog.open=a),persistent:""},{default:r(()=>[t(x,{style:{width:"90vw","max-width":"1400px","max-height":"90vh"}},{default:r(()=>[t(b,{class:"row items-center q-pa-md bg-primary text-white"},{default:r(()=>[t(C,{name:"description",size:"sm",class:"q-mr-sm"}),o[36]||(o[36]=i("div",{class:"text-h6"},"Formularios de Control",-1)),t(S),E(t(f,{flat:"",round:"",dense:"",icon:"close",color:"white"},null,512),[[P]])]),_:1}),t(U),t(b,{class:"q-pa-md bg-grey-2"},{default:r(()=>[i("div",je,[i("div",Ke,[o[37]||(o[37]=i("div",{class:"text-caption text-grey-7"},"Fecha Cosecha",-1)),i("div",Ye,n(s.formulariosDialog.cosecha?.fecha_cosecha||"—"),1)]),i("div",Je,[o[38]||(o[38]=i("div",{class:"text-caption text-grey-7"},"Productor",-1)),i("div",He,n(s.formulariosDialog.cosecha?.apiario?.productor.nombre)+" "+n(s.formulariosDialog.cosecha?.apiario?.productor.apellidos),1)]),i("div",We,[o[39]||(o[39]=i("div",{class:"text-caption text-grey-7"},"Cantidad",-1)),i("div",Ze,n(s.formulariosDialog.cosecha?.cantidad_kg)+" kg",1)]),i("div",Xe,[o[40]||(o[40]=i("div",{class:"text-caption text-grey-7"},"Numero Acta",-1)),i("div",$e,n(s.formulariosDialog.cosecha?.num_acta||"0"),1)]),i("div",ot,[o[41]||(o[41]=i("div",{class:"text-caption text-grey-7"},"Estado",-1)),t(q,{color:s.formulariosDialog.cosecha?.estado==="BUENO"?"green":"red","text-color":"white",dense:""},{default:r(()=>[p(n(s.formulariosDialog.cosecha?.estado),1)]),_:1},8,["color"])])])]),_:1}),t(U),t(b,{class:"q-pa-md"},{default:r(()=>[t(K,{modelValue:s.formulariosDialog.tab,"onUpdate:modelValue":o[20]||(o[20]=a=>s.formulariosDialog.tab=a),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"left"},{default:r(()=>[t(k,{name:"plagas",icon:"bug_report",label:"Plagas","no-caps":""}),t(k,{name:"limpiezas",icon:"cleaning_services",label:"Limpiezas","no-caps":""}),t(k,{name:"medicamentos",icon:"medication",label:"Medicamentos","no-caps":""})]),_:1},8,["modelValue"]),t(U),t(Y,{modelValue:s.formulariosDialog.tab,"onUpdate:modelValue":o[21]||(o[21]=a=>s.formulariosDialog.tab=a),animated:"",style:{"max-height":"60vh","overflow-y":"auto"}},{default:r(()=>[t(A,{name:"plagas"},{default:r(()=>[s.formulariosDialog.cosecha?(u(),g(O,{key:0,cosecha:s.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1}),t(A,{name:"limpiezas"},{default:r(()=>[s.formulariosDialog.cosecha?(u(),g(z,{key:0,cosecha:s.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1}),t(A,{name:"medicamentos"},{default:r(()=>[s.formulariosDialog.cosecha?(u(),g(G,{key:0,cosecha:s.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const tt=I(ne,[["render",et]]),st={name:"ProductorShow",components:{ProductorAcopios:tt,ProductorMapa:go,ProductorApiarios:po,ProductorCertificaciones:mo,ProductorForm:lo,ProductorRunsa:qo,ProductorAcopiosGestion:$},data(){return{tab:"general",loading:!1,productor:null,certificacionesVencidas:0,runsasVencidos:0}},computed:{totalApiarios(){return this.productor?.apiarios?.length||0},totalColmenas(){return this.productor?.apiarios?this.productor.apiarios.reduce((e,o)=>e+(parseInt(o.numero_colmenas_prod)||0),0):0},totalCertificaciones(){return this.productor?.certificaciones?.length||0},estadoClass(){if(!this.productor?.estado)return"bg-grey text-white";const e=this.productor.estado.toUpperCase();return e==="VIGENTE"||e==="ACTIVO"?"bg-green text-white":e==="VENCIDO"||e==="INACTIVO"?"bg-red text-white":"bg-grey text-white"},checklistCompletitud(){if(!this.productor)return[];const e=!!(this.productor.nombre&&this.productor.apellidos&&this.productor.numcarnet&&this.productor.organizacion_id),o=this.productor.runsas?.some(l=>l.estado==="VIGENTE")||!1,d=this.productor.certificaciones?.some(l=>l.estado==="VIGENTE")||!1,m=(this.productor.apiarios?.length||0)>0,s=this.totalColmenas>0;return[{label:"Datos basicos completos",completo:e},{label:"Tiene RUNSA vigente",completo:o},{label:"Tiene certificacion vigente",completo:d},{label:"Tiene al menos un apiario",completo:m},{label:"Tiene colmenas registradas",completo:s}]},completitud(){const e=this.checklistCompletitud;if(e.length===0)return 0;const o=e.filter(d=>d.completo).length;return Math.round(o/e.length*100)}},mounted(){this.fetchProductor(),this.fetchVencimientos()},methods:{async fetchProductor(){this.loading=!0;try{const e=this.$route.params.id,{data:o}=await this.$axios.get(`productores/${e}`);this.productor=o}catch(e){this.productor=null,this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar el productor")}finally{this.loading=!1}},async fetchVencimientos(){try{const e=this.$route.params.id,{data:o}=await this.$axios.get(`productores/${e}/verificar-vencimientos`);this.certificacionesVencidas=o.certificaciones_por_vencer||0,this.runsasVencidos=o.runsas_por_vencer||0}catch{this.certificacionesVencidas=0,this.runsasVencidos=0}},navegarAcopios(){this.$router.push({path:"/acopios",query:{productor_id:this.productor.id}})},onSaved(e){this.productor=e,this.$alert?.success?.("Cambios guardados")}}},it={class:"row items-center q-gutter-sm q-mb-md"},rt={class:"text-h6"},at={key:0,class:"text-primary"},lt={class:"row q-col-gutter-md"},nt={class:"col-12 col-sm-6 col-md-3"},dt={class:"text-h4"},ct={class:"col-12 col-sm-6 col-md-3"},ut={class:"text-h4"},mt={class:"col-12 col-sm-6 col-md-3"},pt={class:"text-h4"},gt={class:"col-12 col-sm-6 col-md-3"},ft={class:"text-h6"},ht={class:"text-caption text-grey-7"};function _t(e,o,d,m,s,l){const c=V("ProductorForm"),N=V("ProductorCertificaciones"),O=V("ProductorRunsa"),z=V("ProductorApiarios"),G=V("ProductorMapa"),a=V("ProductorAcopiosGestion"),B=V("ProductorAcopios");return u(),g(ao,{class:"q-pa-md"},{default:r(()=>[i("div",it,[t(f,{flat:"",round:"",icon:"arrow_back",onClick:o[0]||(o[0]=y=>e.$router.push("/productores"))}),i("div",rt,[o[4]||(o[4]=p(" Detalles Productor ")),s.productor?(u(),_("span",at," — "+n(s.productor.nombre_completo),1)):h("",!0)]),t(S),s.productor?(u(),g(f,{key:0,flat:"",color:"primary",icon:"inventory_2",label:"Ver Acopios",onClick:l.navegarAcopios},null,8,["onClick"])):h("",!0),t(f,{flat:"",round:"",icon:"refresh",loading:s.loading,onClick:l.fetchProductor},null,8,["loading","onClick"])]),!s.loading&&s.productor?(u(),g(x,{key:0,flat:"",bordered:"",class:"q-mb-md"},{default:r(()=>[t(b,null,{default:r(()=>[i("div",lt,[i("div",nt,[t(x,{flat:"",class:"bg-primary text-white"},{default:r(()=>[t(b,{class:"text-center"},{default:r(()=>[o[5]||(o[5]=i("div",{class:"text-caption"},"Total Apiarios",-1)),i("div",dt,n(l.totalApiarios),1)]),_:1})]),_:1})]),i("div",ct,[t(x,{flat:"",class:"bg-green text-white"},{default:r(()=>[t(b,{class:"text-center"},{default:r(()=>[o[6]||(o[6]=i("div",{class:"text-caption"},"Total Colmenas",-1)),i("div",ut,n(l.totalColmenas),1)]),_:1})]),_:1})]),i("div",mt,[t(x,{flat:"",class:"bg-orange text-white"},{default:r(()=>[t(b,{class:"text-center"},{default:r(()=>[o[7]||(o[7]=i("div",{class:"text-caption"},"Certificaciones",-1)),i("div",pt,n(l.totalCertificaciones),1)]),_:1})]),_:1})]),i("div",gt,[t(x,{flat:"",class:L(l.estadoClass)},{default:r(()=>[t(b,{class:"text-center"},{default:r(()=>[o[8]||(o[8]=i("div",{class:"text-caption"},"Estado",-1)),i("div",ft,n(s.productor.estado||"N/A"),1)]),_:1})]),_:1},8,["class"])])]),s.certificacionesVencidas>0?(u(),g(j,{key:0,class:"bg-red-1 text-red-9 q-mt-md",rounded:""},{avatar:r(()=>[t(C,{name:"warning",color:"red"})]),default:r(()=>[p(" Tiene "+n(s.certificacionesVencidas)+" certificacion(es) por vencer en los proximos 30 dias ",1)]),_:1})):h("",!0),s.runsasVencidos>0?(u(),g(j,{key:1,class:"bg-orange-1 text-orange-9 q-mt-sm",rounded:""},{avatar:r(()=>[t(C,{name:"warning",color:"orange"})]),default:r(()=>[p(" Tiene "+n(s.runsasVencidos)+" RUNSA(s) por vencer en los proximos 30 dias ",1)]),_:1})):h("",!0)]),_:1})]),_:1})):h("",!0),!s.loading&&s.productor?(u(),g(x,{key:1,flat:"",bordered:"",class:"q-mb-md"},{default:r(()=>[t(b,null,{default:r(()=>[o[10]||(o[10]=i("div",{class:"text-subtitle2 q-mb-sm"},"Completitud del Perfil",-1)),t(ro,{value:l.completitud/100,size:"12px",color:l.completitud===100?"green":"orange",class:"q-mb-sm"},null,8,["value","color"]),i("div",ht,[p(" Perfil completo al "+n(l.completitud)+"% ",1),t(w,{"max-width":"300px"},{default:r(()=>[o[9]||(o[9]=i("div",{class:"text-weight-bold q-mb-xs"},"Checklist de Completitud:",-1)),(u(!0),_(M,null,F(l.checklistCompletitud,y=>(u(),_("div",{key:y.label,class:"q-my-xs"},[t(C,{name:y.completo?"check_circle":"radio_button_unchecked",color:y.completo?"green":"grey",size:"sm"},null,8,["name","color"]),p(" "+n(y.label),1)]))),128))]),_:1})])]),_:1})]),_:1})):h("",!0),t(x,{flat:"",bordered:""},{default:r(()=>[t(K,{modelValue:s.tab,"onUpdate:modelValue":o[1]||(o[1]=y=>s.tab=y),class:"text-primary",align:"left",dense:""},{default:r(()=>[t(k,{name:"general",icon:"badge",label:"1) Datos del Productor","no-caps":""}),t(k,{name:"runsa",icon:"assured_workload","no-caps":""},{default:r(()=>[o[11]||(o[11]=p(" 2) Runsa ")),s.runsasVencidos>0?(u(),g(Z,{key:0,color:"orange",floating:""},{default:r(()=>[p(n(s.runsasVencidos),1)]),_:1})):h("",!0)]),_:1}),t(k,{name:"certs",icon:"verified","no-caps":""},{default:r(()=>[o[12]||(o[12]=p(" 3) Certificaciones ")),s.certificacionesVencidas>0?(u(),g(Z,{key:0,color:"red",floating:""},{default:r(()=>[p(n(s.certificacionesVencidas),1)]),_:1})):h("",!0)]),_:1}),t(k,{name:"apiarios",icon:"hive",label:"4) Lugares de Acopio","no-caps":""}),t(k,{name:"mapa",icon:"map",label:"5) Mapa","no-caps":""}),t(k,{name:"acopio",icon:"send",label:"6) Manejo de Apiario","no-caps":""})]),_:1},8,["modelValue"]),t(U),t(Y,{modelValue:s.tab,"onUpdate:modelValue":o[3]||(o[3]=y=>s.tab=y),animated:""},{default:r(()=>[t(A,{name:"general",class:"q-pa-none"},{default:r(()=>[!s.loading&&s.productor?(u(),g(b,{key:0},{default:r(()=>[t(c,{productor:s.productor,"banner-msg":"Actualiza los datos y guarda los cambios",onSaved:l.onSaved,onCancel:o[2]||(o[2]=y=>e.$router.back())},null,8,["productor","onSaved"])]),_:1})):h("",!0)]),_:1}),t(A,{name:"certs",class:"q-pa-none"},{default:r(()=>[t(N,{productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(A,{name:"runsa",class:"q-pa-none"},{default:r(()=>[t(O,{productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(A,{name:"apiarios",class:"q-pa-none"},{default:r(()=>[t(z,{productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(A,{name:"mapa",class:"q-pa-none"},{default:r(()=>[t(G,{productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(A,{name:"acopios",class:"q-pa-none"},{default:r(()=>[!s.loading&&s.productor?(u(),g(a,{key:0,productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])):h("",!0)]),_:1}),t(A,{name:"acopio",class:"q-pa-none"},{default:r(()=>[t(B,{productor:s.productor,onUpdated:l.fetchProductor},null,8,["productor","onUpdated"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}const Jt=I(st,[["render",_t]]);export{Jt as default};
