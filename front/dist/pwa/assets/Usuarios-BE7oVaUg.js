import{Q as R,a as z,b as O,c as G}from"./QTabPanels-D7xa-5t0.js";import{_ as Z,c as u,o as i,w as a,a as e,O as F,b as g,aa as C,a9 as q,ab as _,ac as Q,a8 as p,t as b,ae as j,d as f,P as x,f as m,af as h,h as A,Q as T,e as v,ag as S,ah as H}from"./index-CsPwe_uT.js";import{d as I,Q as k,b as c,a as V}from"./format-JbVST7eE.js";import{Q as N}from"./QList-B5exae1P.js";import{Q as J}from"./QBtnDropdown-AJzFBta8.js";import{Q as y}from"./QTd-C5VzLGmX.js";import{Q as K}from"./QImg-C8JimjR4.js";import{Q as M}from"./QTooltip-CKFqvQlQ.js";import{Q as E}from"./QBadge-CBfEr-zc.js";import{Q as B}from"./QTable-XvYGiFGZ.js";import{Q as P}from"./QSpace-BBqxE_Ku.js";import{Q as W}from"./QSelect-CuMGQ_1B.js";import{Q as L}from"./QForm-DS3twIse.js";import{Q as X}from"./QPage-VYJU8VuA.js";import{C as U}from"./ClosePopup-B8f4exmK.js";import"./moment-C5S46NFB.js";import"./QResizeObserver-CodM45xS.js";import"./use-panel-B56PPcjv.js";import"./touch-BjYP5sR0.js";import"./selection-Dk_NlVMR.js";import"./QMarkupTable-Dt-xeK9O.js";import"./use-fullscreen-BZLx9rJs.js";const Y={name:"UsuariosPage",data(){return{tab:"internos",users:[],user:{},userDialog:!1,loading:!1,actionUser:"",gestiones:[],filter:"",roles:["Usuario","Gerente","Productor","Produccion","Administrativo"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"avatar",label:"Avatar",align:"left",field:o=>o.avatar},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:o=>(o.permissions||[]).map(s=>s.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1,docentes:[],permisosTargetType:null,permisosTargetId:null,bpUsers:[],loadingInternos:!1,filterInterno:"",bpColumns:[{name:"actions",label:"Acciones",align:"center"},{name:"usr_id",label:"ID",field:"usr_id",align:"left"},{name:"usr_usuario",label:"Usuario",field:"usr_usuario",align:"left"},{name:"traza",label:"TRAZA",field:"traza_activado",align:"center"},{name:"sistemas",label:"Sistemas",field:"usr_access_sistem",align:"left"}]}},async mounted(){this.usersGet(),this.bpUsersGet()},methods:{onFileChange(o){const s=o.target.files[0],d=new FormData;d.append("avatar",s),this.loading=!0,this.$axios.post(this.user.id+"/avatar",d,{headers:{"Content-Type":"multipart/form-data"}}).then(w=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(w=>{this.$alert.error(w.response.data.message)}).finally(()=>{this.loading=!1})},cambiarAvatar(o){this.cambioAvatarDialogo=!0,this.user={...o}},userNew(){this.user={name:"",email:"",password:"",area_id:1,username:"",cargo:"",role:"Usuario"},this.actionUser="Nuevo",this.userDialog=!0},usersGet(){this.loading=!0,this.users=[],this.$axios.get("users").then(o=>{this.users=o.data}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(o=>{this.userDialog=!1,this.$alert.success("User creado"),this.usersGet()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put("users/"+this.user.id,this.user).then(o=>{this.usersGet(),this.userDialog=!1,this.$alert.success("User actualizado")}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},async permisosShow(o){this.dialogPermisos=!0,this.loading=!0,o.id?(this.permisosTargetType="external",this.permisosTargetId=o.id,this.user={...o}):(this.permisosTargetType="internal",this.permisosTargetId=o.usr_id,this.user={username:o.usr_usuario});try{const s=await this.$axios.get("permissions").then(r=>r.data),d=this.permisosTargetType==="external"?`users/${this.permisosTargetId}/permissions`:`bp-usuarios/${this.permisosTargetId}/permissions`,w=await this.$axios.get(d).then(r=>r.data);this.permissions=s.map(r=>({...r,checked:w.includes(r.id)}))}catch(s){this.$alert.error(s.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const o=this.permissions.filter(d=>d.checked).map(d=>d.id),s=this.permisosTargetType==="external"?`users/${this.permisosTargetId}/permissions`:`bp-usuarios/${this.permisosTargetId}/permissions`;await this.$axios.put(s,{permissions:o}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.permisosTargetType==="external"?this.usersGet():this.bpUsersGet()}catch(o){this.$alert.error(o.response?.data?.message||"No se pudo guardar")}finally{this.loading=!1}},userEditPassword(o){this.user={...o},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(s=>{this.$axios.put("updatePassword/"+o.id,{password:s}).then(d=>{this.usersGet(),this.$alert.success("Contraseña actualizada de "+o.username)}).catch(d=>{this.$alert.error(d.response.data.message)})})},userEdit(o){this.user={...o},this.actionUser="Editar",this.userDialog=!0},userDelete(o){this.$alert.dialog("¿Desea eliminar el user?").onOk(()=>{this.loading=!0,this.$axios.delete("users/"+o).then(s=>{this.usersGet(),this.$alert.success("User eliminado")}).catch(s=>{this.$alert.error(s.response.data.message)}).finally(()=>{this.loading=!1})})},bpUsersGet(){this.loadingInternos=!0,this.$axios.get("bp-usuarios").then(o=>{this.bpUsers=o.data}).catch(o=>{this.$alert.error(o.response?.data?.message||"Error cargando usuarios internos")}).finally(()=>{this.loadingInternos=!1})},toggleTraza(o,s){this.$axios.put(`bp-usuarios/${o.usr_id}/traza`,{activado:s}).then(()=>{this.$alert.success(`TRAZA ${s?"activado":"desactivado"} para ${o.usr_usuario}`)}).catch(d=>{this.$alert.error(d.response?.data?.message||"No se pudo actualizar TRAZA"),o.traza_activado=!s})}},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const o=this.permFilter.toLowerCase();return this.permissions.filter(s=>s.name.toLowerCase().includes(o))},bpUsersFiltered(){if(!this.filterInterno)return this.bpUsers;const o=this.filterInterno.toLowerCase();return this.bpUsers.filter(s=>String(s.usr_usuario||"").toLowerCase().includes(o)||String(s.usr_id||"").includes(o))}}},$={class:"row items-center q-col-gutter-xs"},ee={class:"text-left"},se={class:"text-right q-mt-md"},le={style:{position:"relative",top:"0",left:"0"}},ae=["src"],re={class:"text-right q-mt-md"};function oe(o,s,d,w,r,n){return i(),u(X,{class:"q-pa-md"},{default:a(()=>[e(R,{modelValue:r.tab,"onUpdate:modelValue":s[0]||(s[0]=l=>r.tab=l),dense:"",class:"text-primary q-mb-md",align:"left","active-color":"primary","indicator-color":"primary"},{default:a(()=>[e(z,{name:"internos",label:"Usuarios internos",icon:"badge","no-caps":""}),e(z,{name:"externos",label:"Usuarios externos",icon:"person","no-caps":""})]),_:1},8,["modelValue"]),e(F,{class:"q-mb-md"}),e(O,{modelValue:r.tab,"onUpdate:modelValue":s[18]||(s[18]=l=>r.tab=l),animated:""},{default:a(()=>[e(G,{name:"externos"},{default:a(()=>[e(B,{rows:r.users,columns:r.columns,dense:"","wrap-cells":"",flat:"",bordered:"","rows-per-page-options":[0],title:"Usuarios externos",filter:r.filter},{"top-right":a(()=>[e(m,{color:"positive",label:"Nuevo",onClick:n.userNew,"no-caps":"",icon:"add_circle_outline",loading:r.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),e(m,{color:"primary",label:"Actualizar",onClick:n.usersGet,"no-caps":"",icon:"refresh",loading:r.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),e(h,{modelValue:r.filter,"onUpdate:modelValue":s[1]||(s[1]=l=>r.filter=l),label:"Buscar",dense:"",outlined:""},{append:a(()=>[e(f,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":a(l=>[e(y,{props:l},{default:a(()=>[e(J,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:a(()=>[e(N,null,{default:a(()=>[x((i(),u(k,{clickable:"",onClick:t=>n.userEdit(l.row)},{default:a(()=>[e(c,{avatar:""},{default:a(()=>[e(f,{name:"edit"})]),_:1}),e(c,null,{default:a(()=>[e(V,null,{default:a(()=>s[23]||(s[23]=[p("Editar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[U]]),x((i(),u(k,{clickable:"",onClick:t=>n.userDelete(l.row.id)},{default:a(()=>[e(c,{avatar:""},{default:a(()=>[e(f,{name:"delete"})]),_:1}),e(c,null,{default:a(()=>[e(V,null,{default:a(()=>s[24]||(s[24]=[p("Eliminar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[U]]),x((i(),u(k,{clickable:"",onClick:t=>n.userEditPassword(l.row)},{default:a(()=>[e(c,{avatar:""},{default:a(()=>[e(f,{name:"lock_reset"})]),_:1}),e(c,null,{default:a(()=>[e(V,null,{default:a(()=>s[25]||(s[25]=[p("Cambiar contraseña")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[U]]),x((i(),u(k,{clickable:"",onClick:t=>n.cambiarAvatar(l.row)},{default:a(()=>[e(c,{avatar:""},{default:a(()=>[e(f,{name:"image"})]),_:1}),e(c,null,{default:a(()=>[e(V,null,{default:a(()=>s[26]||(s[26]=[p("Cambiar avatar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[U]]),x((i(),u(k,{clickable:"",onClick:t=>n.permisosShow(l.row)},{default:a(()=>[e(c,{avatar:""},{default:a(()=>[e(f,{name:"lock"})]),_:1}),e(c,null,{default:a(()=>[e(V,null,{default:a(()=>s[27]||(s[27]=[p("Permisos")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[U]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":a(l=>[e(y,{props:l},{default:a(()=>[e(I,{label:l.row.role,color:o.$filters.color(l.row.role),"text-color":"white",dense:"",size:"14px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-avatar":a(l=>[e(y,{props:l},{default:a(()=>[e(j,{rounded:""},{default:a(()=>[l.row.avatar?(i(),u(K,{key:0,src:`${o.$url}/../images/${l.row.avatar}`,width:"40px",height:"40px"},null,8,["src"])):(i(),u(f,{key:1,name:"person",size:"40px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-permissions":a(l=>[e(y,{props:l},{default:a(()=>[g("div",$,[(i(!0),C(_,null,Q((l.row.permissions||[]).slice(0,3),(t,D)=>(i(),u(I,{key:t.id,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:a(()=>[p(b(t.name),1)]),_:2},1024))),128)),(l.row.permissions||[]).length>3?(i(),u(E,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:a(()=>[p(" +"+b((l.row.permissions||[]).length-3)+" ",1),e(M,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:a(()=>[g("div",ee,[(i(!0),C(_,null,Q(l.row.permissions,t=>(i(),C("div",{key:t.id},"• "+b(t.name),1))),128))])]),_:2},1024)]),_:2},1024)):q("",!0),(l.row.permissions||[]).length?q("",!0):(i(),u(E,{key:1,color:"grey-5","text-color":"white",outline:""},{default:a(()=>s[28]||(s[28]=[p(" Sin permisos ")])),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),e(A,{modelValue:r.userDialog,"onUpdate:modelValue":s[10]||(s[10]=l=>r.userDialog=l),persistent:""},{default:a(()=>[e(T,{style:{width:"400px"}},{default:a(()=>[e(v,{class:"q-pb-none row items-center"},{default:a(()=>[g("div",null,b(r.actionUser)+" user ",1),e(P),e(m,{icon:"close",flat:"",round:"",dense:"",onClick:s[2]||(s[2]=l=>r.userDialog=!1)})]),_:1}),e(v,{class:"q-pt-none"},{default:a(()=>[e(L,{onSubmit:s[9]||(s[9]=l=>r.user.id?n.userPut():n.userPost())},{default:a(()=>[e(h,{modelValue:r.user.name,"onUpdate:modelValue":s[3]||(s[3]=l=>r.user.name=l),label:"Nombre",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),e(h,{modelValue:r.user.username,"onUpdate:modelValue":s[4]||(s[4]=l=>r.user.username=l),label:"Usuario",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),e(h,{modelValue:r.user.email,"onUpdate:modelValue":s[5]||(s[5]=l=>r.user.email=l),label:"Email",dense:"",outlined:"",hint:""},null,8,["modelValue"]),r.user.id?q("",!0):(i(),u(h,{key:0,modelValue:r.user.password,"onUpdate:modelValue":s[6]||(s[6]=l=>r.user.password=l),label:"Contraseña",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"])),e(W,{modelValue:r.user.role,"onUpdate:modelValue":s[7]||(s[7]=l=>r.user.role=l),label:"Rol",dense:"",outlined:"",options:r.roles,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","rules"]),g("div",se,[e(m,{color:"negative",label:"Cancelar",onClick:s[8]||(s[8]=l=>r.userDialog=!1),"no-caps":"",loading:r.loading},null,8,["loading"]),e(m,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:r.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(A,{modelValue:r.cambioAvatarDialogo,"onUpdate:modelValue":s[16]||(s[16]=l=>r.cambioAvatarDialogo=l),persistent:""},{default:a(()=>[e(T,null,{default:a(()=>[e(v,{class:"q-pb-none row items-center text-bold"},{default:a(()=>[s[29]||(s[29]=p(" Cambiar avatar ")),e(P),e(m,{icon:"close",flat:"",round:"",dense:"",onClick:s[11]||(s[11]=l=>r.cambioAvatarDialogo=!1)})]),_:1}),e(v,{class:"q-pt-none"},{default:a(()=>[e(L,{onSubmit:s[15]||(s[15]=l=>n.userPut())},{default:a(()=>[g("div",null,[g("div",le,[e(m,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:s[12]||(s[12]=l=>o.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""})]),r.user.avatar?(i(),C("img",{key:0,src:`${o.$url}/../images/${r.user.avatar}`,width:"300px",height:"300px"},null,8,ae)):(i(),u(f,{key:1,name:"person",size:"100px"})),g("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:s[13]||(s[13]=(...l)=>n.onFileChange&&n.onFileChange(...l)),accept:"image/*"},null,544)]),g("div",re,[e(m,{color:"negative",label:"Cancelar",onClick:s[14]||(s[14]=l=>r.cambioAvatarDialogo=!1),"no-caps":"",loading:r.loading},null,8,["loading"]),e(m,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:r.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(G,{name:"internos"},{default:a(()=>[e(T,{flat:"",bordered:""},{default:a(()=>[e(v,{class:"row items-center q-col-gutter-sm"},{default:a(()=>[s[30]||(s[30]=g("div",{class:"text-h6"}," Usuarios internos ",-1)),e(P),e(m,{color:"primary",label:"Actualizar",icon:"refresh","no-caps":"",loading:r.loadingInternos,onClick:n.bpUsersGet},null,8,["loading","onClick"]),e(h,{modelValue:r.filterInterno,"onUpdate:modelValue":s[17]||(s[17]=l=>r.filterInterno=l),dense:"",outlined:"",placeholder:"Buscar usuario interno...",class:"q-ml-sm"},{append:a(()=>[e(f,{name:"search"})]),_:1},8,["modelValue"])]),_:1}),e(F),e(B,{rows:n.bpUsersFiltered,columns:r.bpColumns,"row-key":"usr_id",dense:"",flat:"","rows-per-page-options":[0]},{"body-cell-actions":a(l=>[e(y,{props:l},{default:a(()=>[e(m,{color:"primary",label:"Permisos","no-caps":"",size:"10px",onClick:t=>n.permisosShow(l.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-traza":a(l=>[e(y,{props:l},{default:a(()=>[e(S,{modelValue:l.row.traza_activado,"onUpdate:modelValue":[t=>l.row.traza_activado=t,t=>n.toggleTraza(l.row,t)],color:"primary",label:"TRAZA"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-sistemas":a(l=>[e(y,{props:l},{default:a(()=>[(i(!0),C(_,null,Q(l.row.usr_access_sistem||[],(t,D)=>(i(),u(I,{key:D,dense:"",outline:"",color:t.sistema==="TRAZA"?t.activado?"green-5":"red-5":"grey-4","text-color":"black",class:"q-mr-xs q-mb-xs",size:"11px"},{default:a(()=>[p(b(t.sistema)+" ("+b(t.activado?"ON":"OFF")+") ",1)]),_:2},1032,["color"]))),128))]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(A,{modelValue:r.dialogPermisos,"onUpdate:modelValue":s[22]||(s[22]=l=>r.dialogPermisos=l),persistent:""},{default:a(()=>[e(T,{style:{"min-width":"420px"}},{default:a(()=>[e(v,{class:"q-pb-none row items-center text-bold"},{default:a(()=>[p(" Permisos de "+b(r.user.username)+" ",1),e(P),e(m,{icon:"close",flat:"",round:"",dense:"",onClick:s[19]||(s[19]=l=>r.dialogPermisos=!1)})]),_:1}),e(v,{class:"q-pt-none"},{default:a(()=>[e(h,{modelValue:r.permFilter,"onUpdate:modelValue":s[20]||(s[20]=l=>r.permFilter=l),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:a(()=>[e(f,{name:"search"})]),_:1},8,["modelValue"]),e(N,{dense:"",bordered:""},{default:a(()=>[(i(!0),C(_,null,Q(n.filteredPermissions,l=>(i(),u(k,{key:l.id},{default:a(()=>[e(c,null,{default:a(()=>[p(b(l.name),1)]),_:2},1024),e(c,{side:""},{default:a(()=>[e(S,{modelValue:l.checked,"onUpdate:modelValue":t=>l.checked=t},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(H,{align:"right"},{default:a(()=>[e(m,{color:"negative",label:"Cancelar",onClick:s[21]||(s[21]=l=>r.dialogPermisos=!1),"no-caps":"",loading:r.loading},null,8,["loading"]),e(m,{color:"primary",label:"Guardar",onClick:n.permisosPost,"no-caps":"",loading:r.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Te=Z(Y,[["render",oe]]);export{Te as default};
