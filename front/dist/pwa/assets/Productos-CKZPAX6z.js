import{Q as C}from"./QSelect-BP9d8XbV.js";import{_ as S,c as d,o as m,w as a,a as l,J as g,d as c,a5 as b,aa as v,b as n,t as x,ab as I,ad as r,f as p,h as Q,Q as N,e as h,I as U,ax as T,af as q}from"./index-BCYwt6Gd.js";import{Q as P}from"./QImg-BDjaXO_G.js";import{Q as E,a as y}from"./QTable-BH6eob3B.js";import{Q as V,b as f}from"./format-Ca4haxbH.js";import{Q as A,a as D}from"./QList-Bo8m4SUF.js";import{Q as F}from"./QForm-Noz4fS4A.js";import{Q as B}from"./QPage-BMFBOxNs.js";import{C as _}from"./ClosePopup-CWzRC7aD.js";import"./QMarkupTable-BdmeakGS.js";import"./use-fullscreen-X3jFEiO5.js";import"./selection-CEaywXNI.js";const O={name:"ProductosPage",data(){return{loading:!1,rows:[],columns:[{name:"actions",label:"Acciones",align:"right"},{name:"imagen",label:"Imagen",align:"left",field:"imagen"},{name:"codigo_producto",label:"Código",align:"left",field:"codigo_producto"},{name:"nombre_producto",label:"Nombre",align:"left",field:"nombre_producto"},{name:"tipo",label:"Tipo",align:"left",field:"tipo_id"},{name:"presentacion",label:"Presentación",align:"left",field:"presentacion"},{name:"cantidad_kg",label:"Kg",align:"right",field:"cantidad_kg",format:o=>Number(o||0).toFixed(2)},{name:"costo",label:"Costo",align:"right",field:"costo",format:o=>Number(o||0).toFixed(2)},{name:"precio",label:"Precio",align:"right",field:"precio",format:o=>Number(o||0).toFixed(2)},{name:"fecha_vencimiento",label:"Vence",align:"left",field:"fecha_vencimiento"},{name:"nro_lote",label:"Nro lote",align:"left",field:"nro_lote"},{name:"codigo_barra",label:"Barras",align:"left",field:"codigo_barra"}],filter:"",tipo:null,tipoOptions:[],dlg:{open:!1,mode:"create",row:null},form:{tipo_id:null,codigo_producto:"",nombre_producto:"",presentacion:"PIEZA",cantidad_kg:0,costo:0,precio:0,fecha_vencimiento:"",nro_lote:"",codigo_barra:""},saving:!1,dlgImg:{open:!1,row:null},uploading:!1}},computed:{canSubmit(){const o=this.form;return!!(o.tipo_id&&o.codigo_producto&&o.nombre_producto)}},mounted(){this.fetchTipos(),this.fetch()},methods:{imgUrl(o){return o?.startsWith("http")?o:`${this.$url}/../storage/${o}`},findTipoNombre(o){const e=this.tipoOptions.find(u=>u.id===o);return e?e.nombre:o},async fetch(){this.loading=!0;try{const o={};this.filter&&(o.q=this.filter),this.tipo&&(o.tipo=this.tipo);const{data:e}=await this.$axios.get("/productos",{params:o});this.rows=Array.isArray(e)?e:e.data||[]}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"Error al listar productos"})}finally{this.loading=!1}},fetchDebounced:(()=>{let o;return function(){clearTimeout(o),o=setTimeout(()=>this.fetch(),350)}})(),async fetchTipos(){try{const{data:o}=await this.$axios.get("/tipo-productos");this.tipoOptions=o}catch{}},openCreate(){this.dlg={open:!0,mode:"create",row:null},this.form={tipo_id:null,codigo_producto:"",nombre_producto:"",presentacion:"PIEZA",cantidad_kg:0,costo:0,precio:0,fecha_vencimiento:"",nro_lote:"",codigo_barra:""}},openEdit(o){this.dlg={open:!0,mode:"edit",row:o},this.form={tipo_id:o.tipo_id,codigo_producto:o.codigo_producto,nombre_producto:o.nombre_producto,presentacion:o.presentacion||"PIEZA",cantidad_kg:Number(o.cantidad_kg||0),costo:Number(o.costo||0),precio:Number(o.precio||0),fecha_vencimiento:o.fecha_vencimiento||"",nro_lote:o.nro_lote||"",codigo_barra:o.codigo_barra||""}},async onSubmit(){if(this.canSubmit){this.saving=!0;try{this.dlg.mode==="create"?await this.$axios.post("/productos",this.form):await this.$axios.put(`/productos/${this.dlg.row.id}`,this.form),this.$q.notify({type:"positive",message:"Guardado"}),this.dlg.open=!1,await this.fetch()}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"No se pudo guardar"})}finally{this.saving=!1}}},async onDelete(o){this.$q.dialog({title:"Eliminar",message:`¿Eliminar el producto ${o.nombre_producto}?`,cancel:!0,persistent:!0}).onOk(async()=>{try{await this.$axios.delete(`/productos/${o.id}`),this.$q.notify({type:"positive",message:"Eliminado"}),await this.fetch()}catch(e){this.$q.notify({type:"negative",message:e.response?.data?.message||"No se pudo eliminar"})}})},openImagen(o){this.dlgImg={open:!0,row:o}},async onFileChange(o){const e=o.target.files?.[0];if(!(!e||!this.dlgImg.row)){this.uploading=!0;try{const u=new FormData;u.append("file",e);const{data:k}=await this.$axios.post(`/productos/${this.dlgImg.row.id}/imagen`,u,{headers:{"Content-Type":"multipart/form-data"}});this.$q.notify({type:"positive",message:"Imagen actualizada"}),this.dlgImg.row=k.producto,await this.fetch()}catch(u){this.$q.notify({type:"negative",message:u.response?.data?.message||"No se pudo subir"})}finally{this.uploading=!1}}}}},z={class:"row items-center q-gutter-sm"},M={class:"row q-col-gutter-md"},Z={class:"col-12 col-md-6"},G={class:"col-12 col-md-6"},R={class:"col-12"},J={class:"col-12 col-md-6"},K={class:"col-12 col-md-6"},L={class:"col-12 col-md-6"},W={class:"col-12 col-md-6"},j={class:"col-12 col-md-6"},H={class:"col-12 col-md-6"},X={class:"col-12 col-md-6"},Y={class:"row items-center q-col-gutter-md"},$={class:"col-auto"},ee={class:"col"};function oe(o,e,u,k,i,s){return m(),d(B,{class:"q-pa-md"},{default:a(()=>[l(E,{rows:i.rows,columns:i.columns,"row-key":"id",flat:"",bordered:"",dense:"","wrap-cells":"","rows-per-page-options":[0],title:"Productos",loading:i.loading,filter:i.filter},{"top-right":a(()=>[n("div",z,[l(C,{modelValue:i.tipo,"onUpdate:modelValue":[e[0]||(e[0]=t=>i.tipo=t),s.fetch],options:i.tipoOptions,"option-value":"id","option-label":"nombre_tipo","emit-value":"","map-options":"",dense:"",filled:"",clearable:"",label:"Tipo",style:{"min-width":"180px"}},null,8,["modelValue","options","onUpdate:modelValue"]),l(r,{modelValue:i.filter,"onUpdate:modelValue":[e[1]||(e[1]=t=>i.filter=t),s.fetchDebounced],dense:"",outlined:"",placeholder:"Buscar código / nombre / barra"},{append:a(()=>[l(c,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),l(p,{color:"positive",icon:"add_circle_outline",label:"Nuevo","no-caps":"",loading:i.loading,onClick:s.openCreate},null,8,["loading","onClick"]),l(p,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:i.loading,onClick:s.fetch},null,8,["loading","onClick"])])]),"body-cell-imagen":a(t=>[l(y,{props:t},{default:a(()=>[t.row.imagen?(m(),d(I,{key:0,square:"",size:"42px"},{default:a(()=>[l(P,{src:s.imgUrl(t.row.imagen),ratio:1},null,8,["src"])]),_:2},1024)):(m(),d(c,{key:1,name:"image_not_supported"}))]),_:2},1032,["props"])]),"body-cell-tipo":a(t=>[l(y,{props:t},{default:a(()=>[b(x(s.findTipoNombre(t.row.tipo_id)),1)]),_:2},1032,["props"])]),"body-cell-actions":a(t=>[l(y,{props:t,class:"text-right"},{default:a(()=>[l(A,{label:"Opciones",dense:"",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[l(D,null,{default:a(()=>[g((m(),d(V,{clickable:"",onClick:w=>s.openImagen(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(c,{name:"image"})]),_:1}),l(f,null,{default:a(()=>e[16]||(e[16]=[b("Imagen")])),_:1})]),_:2},1032,["onClick"])),[[v],[_]]),g((m(),d(V,{clickable:"",onClick:w=>s.openEdit(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(c,{name:"edit"})]),_:1}),l(f,null,{default:a(()=>e[17]||(e[17]=[b("Editar")])),_:1})]),_:2},1032,["onClick"])),[[v],[_]]),g((m(),d(V,{clickable:"",onClick:w=>s.onDelete(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(c,{name:"delete",color:"negative"})]),_:1}),l(f,null,{default:a(()=>e[18]||(e[18]=[n("span",{class:"text-negative"},"Eliminar",-1)])),_:1})]),_:2},1032,["onClick"])),[[v],[_]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","filter"]),l(Q,{modelValue:i.dlg.open,"onUpdate:modelValue":e[12]||(e[12]=t=>i.dlg.open=t),persistent:""},{default:a(()=>[l(N,{style:{"min-width":"520px","max-width":"760px"}},{default:a(()=>[l(h,{class:"text-h6"},{default:a(()=>[b(x(i.dlg.mode==="create"?"Nuevo Producto":"Editar Producto"),1)]),_:1}),l(U),l(h,null,{default:a(()=>[l(F,{onSubmit:T(s.onSubmit,["prevent"]),ref:"formRef"},{default:a(()=>[n("div",M,[n("div",Z,[l(C,{modelValue:i.form.tipo_id,"onUpdate:modelValue":e[2]||(e[2]=t=>i.form.tipo_id=t),options:i.tipoOptions,"option-value":"id","option-label":"nombre_tipo","emit-value":"","map-options":"",dense:"",filled:"",label:"Tipo"},null,8,["modelValue","options"])]),n("div",G,[l(r,{modelValue:i.form.codigo_producto,"onUpdate:modelValue":e[3]||(e[3]=t=>i.form.codigo_producto=t),dense:"",filled:"",label:"Código"},null,8,["modelValue"])]),n("div",R,[l(r,{modelValue:i.form.nombre_producto,"onUpdate:modelValue":e[4]||(e[4]=t=>i.form.nombre_producto=t),dense:"",filled:"",label:"Nombre"},null,8,["modelValue"])]),n("div",J,[l(r,{modelValue:i.form.presentacion,"onUpdate:modelValue":e[5]||(e[5]=t=>i.form.presentacion=t),dense:"",filled:"",label:"Presentación"},null,8,["modelValue"])]),n("div",K,[l(r,{modelValue:i.form.cantidad_kg,"onUpdate:modelValue":e[6]||(e[6]=t=>i.form.cantidad_kg=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Cantidad (kg)"},null,8,["modelValue"])]),n("div",L,[l(r,{modelValue:i.form.costo,"onUpdate:modelValue":e[7]||(e[7]=t=>i.form.costo=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Costo"},null,8,["modelValue"])]),n("div",W,[l(r,{modelValue:i.form.precio,"onUpdate:modelValue":e[8]||(e[8]=t=>i.form.precio=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Precio"},null,8,["modelValue"])]),n("div",j,[l(r,{modelValue:i.form.fecha_vencimiento,"onUpdate:modelValue":e[9]||(e[9]=t=>i.form.fecha_vencimiento=t),type:"date",dense:"",filled:"",label:"Fecha venc."},null,8,["modelValue"])]),n("div",H,[l(r,{modelValue:i.form.nro_lote,"onUpdate:modelValue":e[10]||(e[10]=t=>i.form.nro_lote=t),dense:"",filled:"",label:"Nro lote"},null,8,["modelValue"])]),n("div",X,[l(r,{modelValue:i.form.codigo_barra,"onUpdate:modelValue":e[11]||(e[11]=t=>i.form.codigo_barra=t),dense:"",filled:"",label:"Código de barras"},null,8,["modelValue"])])])]),_:1},8,["onSubmit"])]),_:1}),l(U),l(q,{align:"right"},{default:a(()=>[g(l(p,{flat:"",label:"Cancelar"},null,512),[[_]]),l(p,{color:"primary",loading:i.saving,disable:!s.canSubmit,label:"Guardar",onClick:s.onSubmit},null,8,["loading","disable","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Q,{modelValue:i.dlgImg.open,"onUpdate:modelValue":e[15]||(e[15]=t=>i.dlgImg.open=t),persistent:""},{default:a(()=>[l(N,{style:{"min-width":"420px"}},{default:a(()=>[l(h,{class:"text-h6"},{default:a(()=>e[19]||(e[19]=[b("Imagen de producto")])),_:1}),l(h,null,{default:a(()=>[n("div",Y,[n("div",$,[l(I,{square:"",size:"140px"},{default:a(()=>[i.dlgImg.row?.imagen?(m(),d(P,{key:0,src:s.imgUrl(i.dlgImg.row.imagen),ratio:1},null,8,["src"])):(m(),d(c,{key:1,name:"image",size:"80px"}))]),_:1})]),n("div",ee,[n("input",{ref:"fileInput",type:"file",accept:"image/*",onChange:e[13]||(e[13]=(...t)=>s.onFileChange&&s.onFileChange(...t)),style:{display:"none"}},null,544),l(p,{outline:"","no-caps":"",color:"primary",icon:"upload",label:"Subir imagen",onClick:e[14]||(e[14]=t=>o.$refs.fileInput.click()),loading:i.uploading},null,8,["loading"])])])]),_:1}),l(q,{align:"right"},{default:a(()=>[g(l(p,{flat:"",label:"Cerrar"},null,512),[[_]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const fe=S(O,[["render",oe],["__scopeId","data-v-d2a38ad5"]]);export{fe as default};
