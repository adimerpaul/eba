import{Q as x}from"./QBadge-V5K5-eb6.js";import{_ as O,c as v,o as c,w as d,a,e as y,b as r,a6 as h,t as _,a5 as m,I as A,aB as k,a7 as p,as as n,d as V,f as b,Q as q}from"./index-C-DNnXi2.js";import{Q as N,b as w}from"./format-DRFXSdcQ.js";import{Q as f}from"./QSelect-Dvh5Y2tt.js";import{Q as U}from"./QForm-C-86A5JZ.js";import{h as g}from"./moment-C5S46NFB.js";const B={name:"AcopioFormulario",props:{estado:{type:String,required:!0,validator:t=>["crear","editar"].indexOf(t)!==-1},cosecha:{type:Object,default:null}},data(){return{loading:!1,productos:[],productorOptions:[],apiarioOptions:[],loadingProductores:!1,loadingApiarios:!1,form:{fecha_cosecha:g().format("YYYY-MM-DD"),productor_id:null,apiario_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"",observaciones:"",estado:"BUENO"},estados:[{label:"BUENO",value:"BUENO"},{label:"EN PROCESO",value:"EN PROCESO"},{label:"CANCELADO",value:"CANCELADO"}]}},mounted(){this.productoGet(),this.estado==="editar"&&this.cosecha&&(this.form={fecha_cosecha:this.cosecha.fecha_cosecha||g().format("YYYY-MM-DD"),producto_id:this.cosecha.producto_id||null,cantidad_kg:this.cosecha.cantidad_kg||null,precio_compra:this.cosecha.precio_compra||32,humedad:this.cosecha.humedad||null,temperatura_almacenaje:this.cosecha.temperatura_almacenaje||null,procedencia:this.cosecha.procedencia||"",tipo_envase:this.cosecha.tipo_envase||"",observaciones:this.cosecha.observaciones||"",estado:this.cosecha.estado||"BUENO"},this.form.productor_id=this.cosecha.apiario?.productor_id||null,this.filterProductores("",t=>{this.form.productor_id&&!this.productorOptions.find(e=>e.value===this.form.productor_id)&&this.$axios.get(`/productores/${this.form.productor_id}`).then(({data:e})=>{const s=e,u={value:s.id,label:`${s.nombre??""} ${s.apellidos??""} — ${s.municipio?.nombre_municipio??""}`.trim(),raw:s};this.productorOptions.push(u),this.form.apiario_id=this.cosecha.apiario_id||null,this.loadApiariosByProductor(this.form.productor_id)})}))},computed:{productorDetalle(){return this.form.productor_id&&this.productorOptions.find(t=>t.value===this.form.productor_id)||null},apiarioDetalle(){return this.form.apiario_id&&this.apiarioOptions.find(t=>t.value===this.form.apiario_id)?.raw||null}},watch:{"form.productor_id"(t){this.form.apiario_id=null,this.apiarioOptions=[],t&&this.loadApiariosByProductor(t)}},methods:{async productoGet(){this.$axios.get("/productos").then(({data:t})=>{this.productos=t?.data||t||[]}).catch(()=>{this.$q.notify({type:"negative",message:"No se pudieron cargar los productos"})})},onReset(){this.$refs.formRef.resetValidation(),this.form=Object.assign({},this.form,{fecha_cosecha:g().format("YYYY-MM-DD"),productor_id:null,apiario_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"",observaciones:"",estado:"BUENO"})},filterProductores(t,e,s){if(!t||t.length<2){e(()=>{this.productorOptions=[]});return}e(async()=>{this.loadingProductores=!0;try{const{data:u}=await this.$axios.get("/productores",{params:{search:t,per_page:20}}),i=(u?.data||u||[]).map(l=>({value:l.id,label:`${l.nombre??""} ${l.apellidos??""} — ${l.municipio?.nombre_municipio??""}`.trim(),raw:l}));this.productorOptions=i}catch{this.$q.notify({type:"negative",message:"No se pudo cargar productores"})}finally{this.loadingProductores=!1}})},async loadApiariosByProductor(t){this.loadingApiarios=!0;try{const{data:e}=await this.$axios.get("/apiarios",{params:{productor_id:t,paginate:!1}});this.apiarioOptions=(e||[]).map(s=>({value:s.id,label:s.nombre_cip?`${s.nombre_cip} — ${s?.municipio?.nombre_municipio??""}`:`Apiario #${s.id} — ${s?.municipio?.nombre_municipio??""}`,raw:{municipio:s?.municipio?.nombre_municipio||"—"}}))}catch{this.$q.notify({type:"negative",message:"No se pudieron cargar apiarios"})}finally{this.loadingApiarios=!1}},async onSubmit(){try{if(this.loading=!0,this.estado==="crear"){const{data:t}=await this.$axios.post("/acopio-cosechas",this.form);this.$q.notify({type:"positive",message:"Acopio guardado"}),this.$emit("saved",t),this.$router.push(`/acopio/cosechas/${t.id}`)}else{const{data:t}=await this.$axios.put(`/acopio-cosechas/${this.cosecha.id}`,this.form);this.$q.notify({type:"positive",message:"Acopio actualizado"}),this.$emit("saved",t)}}catch{this.$q.notify({type:"negative",message:"Error al guardar"})}finally{this.loading=!1}}}},C={class:"text-h6"},E={class:"row q-col-gutter-md"},P={class:"col-12 col-md-3"},Q={class:"col-12 col-md-9"},D={key:0,class:"text-caption text-grey-7 q-mt-xs"},S={class:"col-12 col-md-6"},M={key:0,class:"text-caption text-grey-7 q-mt-xs"},Y={class:"col-6 col-md-3"},j={class:"col-6 col-md-3"},R={class:"col-6 col-md-3"},F={class:"col-6 col-md-3"},I={class:"col-6 col-md-3"},z={class:"col-6 col-md-3"},G={class:"col-6 col-md-3"},L={class:"col-12 col-md-6"},T={class:"col-12 col-md-3"},H={key:0,class:"row q-gutter-sm q-mt-md"},J={key:1,class:"row q-gutter-sm q-mt-md"};function K(t,e,s,u,i,l){return c(),v(q,{flat:"",bordered:""},{default:d(()=>[a(y,{class:"row items-center justify-between"},{default:d(()=>[r("div",C,_(s.estado==="crear"?"Nuevo Acopio":"Editar Acopio"),1),s.estado==="crear"?(c(),v(x,{key:0,color:"primary",outline:""},{default:d(()=>e[12]||(e[12]=[m("Nuevo")])),_:1})):h("",!0)]),_:1}),a(A),a(y,null,{default:d(()=>[a(U,{ref:"formRef",onSubmit:k(l.onSubmit,["prevent"])},{default:d(()=>[r("div",E,[r("div",P,[a(n,{modelValue:i.form.fecha_cosecha,"onUpdate:modelValue":e[0]||(e[0]=o=>i.form.fecha_cosecha=o),type:"date",label:"Fecha de Cosecha",dense:"",outlined:"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","rules"])]),r("div",Q,[a(f,{modelValue:i.form.productor_id,"onUpdate:modelValue":e[1]||(e[1]=o=>i.form.productor_id=o),options:i.productorOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"","use-input":"","input-debounce":"400",onFilter:l.filterProductores,label:"Productor",dense:"",outlined:"",loading:i.loadingProductores,clearable:"",rules:[o=>!!o||"Seleccione un productor"]},{"no-option":d(()=>[a(N,null,{default:d(()=>[a(w,{class:"text-grey"},{default:d(()=>e[13]||(e[13]=[m("Escriba al menos 2 caracteres…")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","loading","rules"]),l.productorDetalle?(c(),p("div",D,[a(V,{name:"badge",size:"16px",class:"q-mr-xs"}),m(" "+_(l.productorDetalle?.label),1)])):h("",!0)]),r("div",S,[a(f,{modelValue:i.form.apiario_id,"onUpdate:modelValue":e[2]||(e[2]=o=>i.form.apiario_id=o),options:i.apiarioOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",label:"Apiario",dense:"",outlined:"",loading:i.loadingApiarios,disable:!i.form.productor_id,clearable:"",rules:[o=>!!o||"Seleccione un apiario"]},null,8,["modelValue","options","loading","disable","rules"]),l.apiarioDetalle?(c(),p("div",M,[a(V,{name:"place",size:"16px",class:"q-mr-xs"}),m(" "+_(l.apiarioDetalle?.municipio||"—"),1)])):h("",!0)]),r("div",Y,[a(n,{modelValue:i.form.cantidad_kg,"onUpdate:modelValue":e[3]||(e[3]=o=>i.form.cantidad_kg=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Cantidad (kg)",dense:"",outlined:"",suffix:"kg",rules:[o=>o>0||"Mayor a 0"]},null,8,["modelValue","rules"])]),r("div",j,[a(f,{modelValue:i.form.producto_id,"onUpdate:modelValue":e[4]||(e[4]=o=>i.form.producto_id=o),options:i.productos.map(o=>({label:o.nombre_producto,value:o.id})),label:"Producto",dense:"",outlined:"","emit-value":"","map-options":"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","options","rules"])]),r("div",R,[a(n,{modelValue:i.form.precio_compra,"onUpdate:modelValue":e[5]||(e[5]=o=>i.form.precio_compra=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Precio de compra",dense:"",outlined:"",prefix:"Bs ",rules:[o=>o>=0||"No negativo"]},null,8,["modelValue","rules"])]),r("div",F,[a(n,{modelValue:i.form.humedad,"onUpdate:modelValue":e[6]||(e[6]=o=>i.form.humedad=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Humedad (%)",dense:"",outlined:"",suffix:"%"},null,8,["modelValue"])]),r("div",I,[a(n,{modelValue:i.form.temperatura_almacenaje,"onUpdate:modelValue":e[7]||(e[7]=o=>i.form.temperatura_almacenaje=o),modelModifiers:{number:!0},type:"number",min:"-50",step:"0.01",label:"Temperatura Almacenaje (°C)",dense:"",outlined:"",suffix:"°C"},null,8,["modelValue"])]),r("div",z,[a(n,{modelValue:i.form.procedencia,"onUpdate:modelValue":e[8]||(e[8]=o=>i.form.procedencia=o),label:"Procedencia",dense:"",outlined:"",maxlength:"50"},null,8,["modelValue"])]),r("div",G,[a(n,{modelValue:i.form.tipo_envase,"onUpdate:modelValue":e[9]||(e[9]=o=>i.form.tipo_envase=o),label:"Tipo de envase",dense:"",outlined:"",maxlength:"100"},null,8,["modelValue"])]),r("div",L,[a(n,{modelValue:i.form.observaciones,"onUpdate:modelValue":e[10]||(e[10]=o=>i.form.observaciones=o),label:"Observaciones",dense:"",outlined:"",autogrow:"",maxlength:"255"},null,8,["modelValue"])]),r("div",T,[a(f,{modelValue:i.form.estado,"onUpdate:modelValue":e[11]||(e[11]=o=>i.form.estado=o),options:i.estados,"emit-value":"","map-options":"",label:"Estado",dense:"",outlined:"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","options","rules"])])]),s.estado==="crear"?(c(),p("div",H,[a(b,{type:"submit",color:"primary",icon:"save",loading:i.loading,"no-caps":"",label:"Guardar"},null,8,["loading"]),a(b,{type:"reset",color:"grey-7",flat:"",icon:"history","no-caps":"",label:"Limpiar",onClick:l.onReset},null,8,["onClick"])])):(c(),p("div",J,[a(b,{type:"submit",color:"primary",icon:"save",loading:i.loading,"no-caps":"",label:"Actualizar"},null,8,["loading"])]))]),_:1},8,["onSubmit"])]),_:1})]),_:1})}const io=O(B,[["render",K]]);export{io as A};
