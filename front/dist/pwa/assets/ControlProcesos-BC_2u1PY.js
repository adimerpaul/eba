import{Q as p}from"./QSpace-CWkkK__K.js";import{_ as x,c as f,o as g,w as s,b as r,a,f as n,Q as b,e as u,ag as d,a8 as V,a7 as m,t as q,h as v,P as C}from"./index-BlKDBvQ5.js";import{Q as c}from"./QSelect-CrufDZ1L.js";import{Q as P}from"./QBadge-DjxiqQnk.js";import{Q as k}from"./QTd-CZruX_-d.js";import{Q as _}from"./QTooltip-CQgyPbEx.js";import{Q as z}from"./QTable-Cev_6FcY.js";import{Q as w}from"./QForm-CPNmOC2s.js";import{Q as N}from"./QPage-9F4PkkBC.js";import{C as F}from"./ClosePopup-jQ9viJ4_.js";import"./QChip-CsUcH7aQ.js";import"./position-engine-C6RYylQK.js";import"./selection-D8rj6CQm.js";import"./format-Zk9it-h-.js";import"./QList-CtW7EQxk.js";import"./QMarkupTable-Dr0zNr-8.js";import"./QLinearProgress-Bu1X8STu.js";import"./use-fullscreen-D3o4GhfS.js";const Q={name:"ControlProcesos",data(){return{procesos:[],loading:!1,pagination:{page:1,rowsPerPage:20,rowsNumber:0},filtros:{estado:null,fecha_inicio:null,fecha_fin:null},estadosOptions:["EN_PROCESO","FINALIZADO"],dialogoNuevo:!1,dialogoFinalizar:!1,guardando:!1,form:{acopio_ids:[],tanque_id:null,producto_id:null,temperatura_proceso:null,tiempo_proceso_horas:null,metodo_proceso:null,observaciones:null},formFinalizar:{cantidad_salida_kg:null,humedad_final:null},procesoActual:null,acopiosDisponibles:[],tanques:[],productos:[],columns:[{name:"id",label:"ID",field:"id",align:"left",sortable:!0},{name:"fecha_proceso",label:"Fecha",field:"fecha_proceso",align:"left",format:i=>i?new Date(i).toLocaleDateString():""},{name:"tanque",label:"Tanque",field:i=>i.tanque?.nombre_tanque||"",align:"left"},{name:"cantidad_entrada",label:"Entrada (kg)",field:"cantidad_entrada_kg",align:"right",format:i=>i?Number(i).toFixed(2):"0.00"},{name:"cantidad_salida",label:"Salida (kg)",field:"cantidad_salida_kg",align:"right",format:i=>i?Number(i).toFixed(2):"0.00"},{name:"merma",label:"Merma (%)",field:"merma_porcentaje",align:"right",format:i=>i?Number(i).toFixed(2):"0.00"},{name:"estado",label:"Estado",field:"estado",align:"center"},{name:"acciones",label:"Acciones",field:"acciones",align:"center"}]}},mounted(){this.buscar(),this.cargarCatalogos()},methods:{async buscar(){this.loading=!0;try{const i={page:this.pagination.page,per_page:this.pagination.rowsPerPage,...this.filtros},{data:o}=await this.$axios.get("/control-procesos",{params:i});this.procesos=o.data,this.pagination.rowsNumber=o.total}catch(i){this.$q.notify({type:"negative",message:i.response?.data?.message||"Error al cargar procesos"})}finally{this.loading=!1}},async onRequest(i){this.pagination=i.pagination,await this.buscar()},async cargarCatalogos(){try{const[i,o,h]=await Promise.all([this.$axios.get("/acopios-disponibles-proceso"),this.$axios.get("/tanques"),this.$axios.get("/productos")]);this.acopiosDisponibles=i.data,this.tanques=o.data,this.productos=h.data}catch{this.$q.notify({type:"negative",message:"Error al cargar catalogos"})}},filterAcopios(i,o){o(()=>{i===""&&this.cargarCatalogos()})},abrirDialogoNuevo(){this.form={acopio_ids:[],tanque_id:null,producto_id:null,temperatura_proceso:null,tiempo_proceso_horas:null,metodo_proceso:null,observaciones:null},this.dialogoNuevo=!0},async guardarProceso(){this.guardando=!0;try{const i={...this.form,acopio_ids:this.form.acopio_ids.map(o=>o.id)};await this.$axios.post("/control-procesos",i),this.$q.notify({type:"positive",message:"Proceso creado exitosamente"}),this.dialogoNuevo=!1,this.buscar(),this.cargarCatalogos()}catch(i){this.$q.notify({type:"negative",message:i.response?.data?.message||"Error al crear proceso"})}finally{this.guardando=!1}},abrirDialogoFinalizar(i){this.procesoActual=i,this.formFinalizar={cantidad_salida_kg:i.cantidad_entrada_kg,humedad_final:null},this.dialogoFinalizar=!0},async finalizarProceso(){this.guardando=!0;try{await this.$axios.put(`/control-procesos/${this.procesoActual.id}/finalizar`,this.formFinalizar),this.$q.notify({type:"positive",message:"Proceso finalizado exitosamente"}),this.dialogoFinalizar=!1,this.buscar()}catch(i){this.$q.notify({type:"negative",message:i.response?.data?.message||"Error al finalizar proceso"})}finally{this.guardando=!1}},verDetalle(i){this.$router.push(`/control-procesos/${i.id}`)},async eliminar(i){this.$q.dialog({title:"Confirmar",message:"Esta seguro de eliminar este proceso?",cancel:!0,persistent:!0}).onOk(async()=>{try{await this.$axios.delete(`/control-procesos/${i.id}`),this.$q.notify({type:"positive",message:"Proceso eliminado"}),this.buscar()}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"Error al eliminar"})}})},getColorEstado(i){return i==="EN_PROCESO"?"warning":"positive"}}},E={class:"row items-center q-mb-md"},D={class:"row q-gutter-md"},U={class:"row q-col-gutter-md q-mt-sm"},S={class:"col-6"},O={class:"col-6"},A={class:"q-mt-md text-right"},R={class:"text-body2 q-mb-md"},T={class:"q-mt-md text-right"};function B(i,o,h,I,l,t){return g(),f(N,{class:"q-pa-md"},{default:s(()=>[r("div",E,[o[16]||(o[16]=r("div",{class:"text-h5"},"Control de Procesos",-1)),a(p),a(n,{color:"primary",label:"Nuevo Proceso",icon:"add",onClick:t.abrirDialogoNuevo},null,8,["onClick"])]),a(b,{flat:"",bordered:""},{default:s(()=>[a(u,null,{default:s(()=>[r("div",D,[a(c,{modelValue:l.filtros.estado,"onUpdate:modelValue":[o[0]||(o[0]=e=>l.filtros.estado=e),t.buscar],options:l.estadosOptions,label:"Estado",clearable:"",dense:"",style:{"min-width":"200px"}},null,8,["modelValue","options","onUpdate:modelValue"]),a(d,{modelValue:l.filtros.fecha_inicio,"onUpdate:modelValue":[o[1]||(o[1]=e=>l.filtros.fecha_inicio=e),t.buscar],type:"date",label:"Fecha Inicio",dense:"",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),a(d,{modelValue:l.filtros.fecha_fin,"onUpdate:modelValue":[o[2]||(o[2]=e=>l.filtros.fecha_fin=e),t.buscar],type:"date",label:"Fecha Fin",dense:"",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),a(n,{color:"primary",label:"Buscar",icon:"search",onClick:t.buscar},null,8,["onClick"])])]),_:1}),a(z,{rows:l.procesos,columns:l.columns,"row-key":"id",loading:l.loading,flat:"",pagination:l.pagination,onRequest:t.onRequest},{"body-cell-estado":s(e=>[a(k,{props:e},{default:s(()=>[a(P,{color:t.getColorEstado(e.row.estado)},{default:s(()=>[m(q(e.row.estado),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-acciones":s(e=>[a(k,{props:e},{default:s(()=>[a(n,{flat:"",dense:"",icon:"visibility",color:"primary",onClick:y=>t.verDetalle(e.row),size:"sm"},{default:s(()=>[a(_,null,{default:s(()=>o[17]||(o[17]=[m("Ver detalle")])),_:1})]),_:2},1032,["onClick"]),e.row.estado==="EN_PROCESO"?(g(),f(n,{key:0,flat:"",dense:"",icon:"check_circle",color:"positive",onClick:y=>t.abrirDialogoFinalizar(e.row),size:"sm"},{default:s(()=>[a(_,null,{default:s(()=>o[18]||(o[18]=[m("Finalizar proceso")])),_:1})]),_:2},1032,["onClick"])):V("",!0),e.row.estado==="EN_PROCESO"?(g(),f(n,{key:1,flat:"",dense:"",icon:"delete",color:"negative",onClick:y=>t.eliminar(e.row),size:"sm"},{default:s(()=>[a(_,null,{default:s(()=>o[19]||(o[19]=[m("Eliminar")])),_:1})]),_:2},1032,["onClick"])):V("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","pagination","onRequest"])]),_:1}),a(v,{modelValue:l.dialogoNuevo,"onUpdate:modelValue":o[11]||(o[11]=e=>l.dialogoNuevo=e),persistent:""},{default:s(()=>[a(b,{style:{"min-width":"600px"}},{default:s(()=>[a(u,{class:"row items-center"},{default:s(()=>[o[20]||(o[20]=r("div",{class:"text-h6"},"Nuevo Proceso Productivo",-1)),a(p),C(a(n,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),a(u,null,{default:s(()=>[a(w,{onSubmit:t.guardarProceso},{default:s(()=>[a(c,{modelValue:l.form.acopio_ids,"onUpdate:modelValue":o[3]||(o[3]=e=>l.form.acopio_ids=e),options:l.acopiosDisponibles,"option-value":"id","option-label":e=>`${e.apiario?.productor?.nombre_completo||"N/A"} - ${e.cantidad_kg} kg - ${e.fecha_cosecha}`,label:"Acopios a procesar",multiple:"","use-chips":"",rules:[e=>e&&e.length>0||"Seleccione al menos un acopio"],onFilter:t.filterAcopios},null,8,["modelValue","options","option-label","rules","onFilter"]),a(c,{modelValue:l.form.tanque_id,"onUpdate:modelValue":o[4]||(o[4]=e=>l.form.tanque_id=e),options:l.tanques,"option-value":"id","option-label":e=>`${e.nombre_tanque} - ${e.planta?.nombre_planta||""}`,label:"Tanque de destino",rules:[e=>!!e||"Requerido"],class:"q-mt-md"},null,8,["modelValue","options","option-label","rules"]),a(c,{modelValue:l.form.producto_id,"onUpdate:modelValue":o[5]||(o[5]=e=>l.form.producto_id=e),options:l.productos,"option-value":"id","option-label":"nombre_producto",label:"Producto",rules:[e=>!!e||"Requerido"],class:"q-mt-md"},null,8,["modelValue","options","rules"]),r("div",U,[r("div",S,[a(d,{modelValue:l.form.temperatura_proceso,"onUpdate:modelValue":o[6]||(o[6]=e=>l.form.temperatura_proceso=e),type:"number",label:"Temperatura de proceso (C)",step:"0.1"},null,8,["modelValue"])]),r("div",O,[a(d,{modelValue:l.form.tiempo_proceso_horas,"onUpdate:modelValue":o[7]||(o[7]=e=>l.form.tiempo_proceso_horas=e),type:"number",label:"Tiempo estimado (horas)",step:"0.5"},null,8,["modelValue"])])]),a(d,{modelValue:l.form.metodo_proceso,"onUpdate:modelValue":o[8]||(o[8]=e=>l.form.metodo_proceso=e),label:"Metodo de proceso",class:"q-mt-md"},null,8,["modelValue"]),a(d,{modelValue:l.form.observaciones,"onUpdate:modelValue":o[9]||(o[9]=e=>l.form.observaciones=e),label:"Observaciones",type:"textarea",rows:"2",class:"q-mt-md"},null,8,["modelValue"]),r("div",A,[a(n,{label:"Cancelar",flat:"",onClick:o[10]||(o[10]=e=>l.dialogoNuevo=!1),class:"q-mr-sm"}),a(n,{label:"Guardar",type:"submit",color:"primary",loading:l.guardando},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(v,{modelValue:l.dialogoFinalizar,"onUpdate:modelValue":o[15]||(o[15]=e=>l.dialogoFinalizar=e),persistent:""},{default:s(()=>[a(b,{style:{"min-width":"500px"}},{default:s(()=>[a(u,{class:"row items-center"},{default:s(()=>[o[21]||(o[21]=r("div",{class:"text-h6"},"Finalizar Proceso",-1)),a(p),C(a(n,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),a(u,null,{default:s(()=>[a(w,{onSubmit:t.finalizarProceso},{default:s(()=>[r("div",R,[o[22]||(o[22]=m(" Cantidad de entrada: ")),r("strong",null,q(l.procesoActual?.cantidad_entrada_kg)+" kg",1)]),a(d,{modelValue:l.formFinalizar.cantidad_salida_kg,"onUpdate:modelValue":o[12]||(o[12]=e=>l.formFinalizar.cantidad_salida_kg=e),type:"number",label:"Cantidad de salida (kg)",step:"0.01",rules:[e=>!!e||"Requerido",e=>e>0||"Debe ser mayor a 0",e=>e<=(l.procesoActual?.cantidad_entrada_kg||0)||"No puede exceder la entrada"]},null,8,["modelValue","rules"]),a(d,{modelValue:l.formFinalizar.humedad_final,"onUpdate:modelValue":o[13]||(o[13]=e=>l.formFinalizar.humedad_final=e),type:"number",label:"Humedad final (%)",step:"0.1",class:"q-mt-md"},null,8,["modelValue"]),r("div",T,[a(n,{label:"Cancelar",flat:"",onClick:o[14]||(o[14]=e=>l.dialogoFinalizar=!1),class:"q-mr-sm"}),a(n,{label:"Finalizar",type:"submit",color:"primary",loading:l.guardando},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const te=x(Q,[["render",B]]);export{te as default};
