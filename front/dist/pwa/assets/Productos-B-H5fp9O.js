import{Q as N}from"./QSelect-CVwKlU7h.js";import{_ as T,c as m,o as u,w as a,a as l,J as g,d as b,b as n,aa as y,a5 as _,t as w,ab as k,ad as d,f as p,h as C,Q,e as v,I as E,ax as D,af as U}from"./index-COL4Txdp.js";import{Q as q}from"./QImg-CioSFuo8.js";import{Q as I}from"./QTd-Cfy5u_Or.js";import{Q as V,b as f}from"./format-CiAWHUTU.js";import{Q as A}from"./QList-cUBbeuFf.js";import{Q as K}from"./QBtnDropdown-kMKgQR8U.js";import{Q as S}from"./QTable-DGiK0-WC.js";import{Q as F}from"./QForm-CaIbsMiC.js";import{Q as O}from"./QPage-Ci1OIIwx.js";import{C as h}from"./ClosePopup-rr47tVA8.js";import{h as P}from"./moment-C5S46NFB.js";import"./selection-qXZ_tgwM.js";import"./QMarkupTable-DOnMlwFr.js";import"./use-fullscreen-CCDXb-TB.js";const B={name:"ProductosPage",data(){return{inicio:P().format("YYYY-MM-DD"),fin:P().format("YYYY-MM-DD"),dialogKardex:!1,kardex:[],loading:!1,rows:[],columns:[{name:"actions",label:"Acciones",align:"right"},{name:"imagen",label:"Imagen",align:"left",field:"imagen"},{name:"codigo_producto",label:"Código",align:"left",field:"codigo_producto"},{name:"nombre_producto",label:"Nombre",align:"left",field:"nombre_producto"},{name:"tipo",label:"Tipo",align:"left",field:"tipo_id"},{name:"presentacion",label:"Presentación",align:"left",field:"presentacion"},{name:"cantidad",label:"Kg",align:"right",field:"cantidad",format:o=>Number(o||0).toFixed(2)},{name:"costo",label:"Costo",align:"right",field:"costo",format:o=>Number(o||0).toFixed(2)},{name:"precio",label:"Precio",align:"right",field:"precio",format:o=>Number(o||0).toFixed(2)},{name:"fecha_vencimiento",label:"Vence",align:"left",field:"fecha_vencimiento"},{name:"nro_lote",label:"Nro lote",align:"left",field:"nro_lote"},{name:"codigo_barra",label:"Barras",align:"left",field:"codigo_barra"}],filter:"",tipo:null,tipoOptions:[],dlg:{open:!1,mode:"create",row:null},form:{tipo_id:null,codigo_producto:"",nombre_producto:"",presentacion:"PIEZA",cantidad:0,costo:0,precio:0,fecha_vencimiento:"",nro_lote:"",codigo_barra:""},saving:!1,dlgImg:{open:!1,row:null},uploading:!1,colkardex:[{name:"fecha_registro",label:"Fecha",align:"left",field:"fecha_registro"},{name:"tipo_movimiento",label:"Tipo_mov",align:"left",field:"tipo_movimiento"},{name:"entrada",label:"Entrada",align:"left",field:"entrada"},{name:"salida",label:"Salida",align:"left",field:"salida"},{name:"saldo",label:"Saldo",align:"left",field:"saldo"}]}},computed:{canSubmit(){const o=this.form;return!!(o.tipo_id&&o.codigo_producto&&o.nombre_producto)}},mounted(){this.fetchTipos()},methods:{generarExcel(){this.loading=!0,this.$axios.post("productoExcel",{tipo_id:this.tipo.id??0,search:this.filter},{responseType:"blob"}).then(o=>{const e=new Blob([o.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=window.URL.createObjectURL(e),c=document.createElement("a");c.href=s,c.setAttribute("download","productos.xlsx"),document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(s)}).catch(o=>{this.$alert?.error?.(o.response?.data?.message||"No se pudo generar el reporte.")}).finally(()=>{this.loading=!1})},verkardex(o){this.producto=o,this.dialogKardex=!0,this.generarKardex()},generarKardex(){if(!this.inicio||!this.fin||!this.producto||this.inicio>this.fin){this.$q.notify({type:"negative",message:"Seleccione el rango de fechas"});return}this.loading=!0,this.$axios.post("getKardex",{inicio:this.inicio,fin:this.fin,producto_id:this.producto.id}).then(o=>{console.log(o.data),this.kardex=o.data}).catch(o=>{this.$q.notify({type:"negative",message:o.response?.data?.message||"No se pudo generar el reporte."})}).finally(()=>{this.loading=!1})},imgUrl(o){return o?.startsWith("http")?o:`${this.$url}/../storage/${o}`},findTipoNombre(o){const e=this.tipoOptions.find(s=>s.id===o);return e?e.nombre:o},async fetch(){this.loading=!0;try{const o={};this.filter&&(o.q=this.filter),this.tipo&&(o.tipo=this.tipo);const{data:e}=await this.$axios.get("/productos",{params:o});this.rows=Array.isArray(e)?e:e.data||[],console.log(e)}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"Error al listar productos"})}finally{this.loading=!1}},fetchDebounced:(()=>{let o;return function(){clearTimeout(o),o=setTimeout(()=>this.fetch(),350)}})(),async fetchTipos(){try{const{data:o}=await this.$axios.get("/tipo-productos");this.tipoOptions=o,this.tipo=this.tipoOptions.find(e=>e.nombre_tipo==="Producto Terminado")??null,this.fetch()}catch{}},openCreate(){this.dlg={open:!0,mode:"create",row:null},this.form={tipo_id:null,codigo_producto:"",nombre_producto:"",presentacion:"PIEZA",cantidad:0,costo:0,precio:0,fecha_vencimiento:"",nro_lote:"",codigo_barra:""}},openEdit(o){this.dlg={open:!0,mode:"edit",row:o},this.form={id:o.id,tipo_id:o.tipo_id,codigo_producto:o.codigo_producto,nombre_producto:o.nombre_producto,presentacion:o.presentacion||"PIEZA",cantidad:Number(o.cantidad||0),costo:Number(o.costo||0),precio:Number(o.precio||0),fecha_vencimiento:o.fecha_vencimiento||"",nro_lote:o.nro_lote||"",codigo_barra:o.codigo_barra||""}},async onSubmit(){if(this.canSubmit){this.saving=!0;try{this.dlg.mode==="create"?await this.$axios.post("/productos",this.form):(this.form.id=this.dlg.row.id,await this.$axios.put(`/productos/${this.dlg.row.id}`,this.form)),this.$q.notify({type:"positive",message:"Guardado"}),this.dlg.open=!1,await this.fetch()}catch(o){this.$q.notify({type:"negative",message:o.response?.data?.message||"No se pudo guardar"})}finally{this.saving=!1}}},async onDelete(o){this.$q.dialog({title:"Eliminar",message:`¿Eliminar el producto ${o.nombre_producto}?`,cancel:!0,persistent:!0}).onOk(async()=>{try{await this.$axios.delete(`/productos/${o.id}`),this.$q.notify({type:"positive",message:"Eliminado"}),await this.fetch()}catch(e){this.$q.notify({type:"negative",message:e.response?.data?.message||"No se pudo eliminar"})}})},openImagen(o){this.dlgImg={open:!0,row:o}},async onFileChange(o){const e=o.target.files?.[0];if(!(!e||!this.dlgImg.row)){this.uploading=!0;try{const s=new FormData;s.append("file",e);const{data:c}=await this.$axios.post(`/productos/${this.dlgImg.row.id}/imagen`,s,{headers:{"Content-Type":"multipart/form-data"}});this.$q.notify({type:"positive",message:"Imagen actualizada"}),this.dlgImg.row=c.producto,await this.fetch()}catch(s){this.$q.notify({type:"negative",message:s.response?.data?.message||"No se pudo subir"})}finally{this.uploading=!1}}}}},M={class:"row items-center q-gutter-sm"},Y={class:"row q-col-gutter-md"},z={class:"col-12 col-md-6"},L={class:"col-12 col-md-6"},R={class:"col-12"},Z={class:"col-12 col-md-6"},j={class:"col-12 col-md-6"},G={class:"col-12 col-md-6"},H={class:"col-12 col-md-6"},J={class:"col-12 col-md-6"},W={class:"col-12 col-md-6"},X={class:"col-12 col-md-6"},$={class:"row items-center q-col-gutter-md"},ee={class:"col-auto"},oe={class:"col"},le={class:"q-ml-sm"},ie={class:"row"},te={class:"col-6"},ae={class:"col-6"};function ne(o,e,s,c,i,r){return u(),m(O,{class:"q-pa-md"},{default:a(()=>[l(S,{rows:i.rows,columns:i.columns,"row-key":"id",flat:"",bordered:"",dense:"","wrap-cells":"","rows-per-page-options":[0],title:"Almacen de Productos",loading:i.loading,filter:i.filter},{"top-right":a(()=>[n("div",M,[l(N,{modelValue:i.tipo,"onUpdate:modelValue":[e[0]||(e[0]=t=>i.tipo=t),r.fetch],options:i.tipoOptions,"option-value":"id","option-label":"nombre_tipo","emit-value":"","map-options":"",dense:"",filled:"",clearable:"",label:"Tipo",style:{"min-width":"180px"}},null,8,["modelValue","options","onUpdate:modelValue"]),l(d,{modelValue:i.filter,"onUpdate:modelValue":[e[1]||(e[1]=t=>i.filter=t),r.fetchDebounced],dense:"",outlined:"",placeholder:"Buscar código / nombre / barra"},{append:a(()=>[l(b,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),l(p,{color:"positive",icon:"add_circle_outline",label:"Nuevo","no-caps":"",loading:i.loading,onClick:r.openCreate},null,8,["loading","onClick"]),l(p,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:i.loading,onClick:r.fetch},null,8,["loading","onClick"]),l(p,{color:"green",label:"EXCEL",loading:i.loading,onClick:r.generarExcel},null,8,["loading","onClick"])])]),"body-cell-imagen":a(t=>[l(I,{props:t},{default:a(()=>[t.row.imagen?(u(),m(k,{key:0,square:"",size:"42px"},{default:a(()=>[l(q,{src:r.imgUrl(t.row.imagen),ratio:1},null,8,["src"])]),_:2},1024)):(u(),m(b,{key:1,name:"image_not_supported"}))]),_:2},1032,["props"])]),"body-cell-tipo":a(t=>[l(I,{props:t},{default:a(()=>[_(w(r.findTipoNombre(t.row.tipo_id)),1)]),_:2},1032,["props"])]),"body-cell-actions":a(t=>[l(I,{props:t,class:"text-right"},{default:a(()=>[l(K,{label:"Opciones",dense:"",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[l(A,null,{default:a(()=>[g((u(),m(V,{clickable:"",onClick:x=>r.verkardex(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(b,{name:"article"})]),_:1}),l(f,null,{default:a(()=>e[19]||(e[19]=[n("span",null,"Kardex",-1)])),_:1})]),_:2},1032,["onClick"])),[[y],[h]]),g((u(),m(V,{clickable:"",onClick:x=>r.openImagen(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(b,{name:"image"})]),_:1}),l(f,null,{default:a(()=>e[20]||(e[20]=[_("Imagen")])),_:1})]),_:2},1032,["onClick"])),[[y],[h]]),g((u(),m(V,{clickable:"",onClick:x=>r.openEdit(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(b,{name:"edit"})]),_:1}),l(f,null,{default:a(()=>e[21]||(e[21]=[_("Editar")])),_:1})]),_:2},1032,["onClick"])),[[y],[h]]),g((u(),m(V,{clickable:"",onClick:x=>r.onDelete(t.row)},{default:a(()=>[l(f,{avatar:""},{default:a(()=>[l(b,{name:"delete",color:"negative"})]),_:1}),l(f,null,{default:a(()=>e[22]||(e[22]=[n("span",{class:"text-negative"},"Eliminar",-1)])),_:1})]),_:2},1032,["onClick"])),[[y],[h]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","filter"]),l(C,{modelValue:i.dlg.open,"onUpdate:modelValue":e[12]||(e[12]=t=>i.dlg.open=t),persistent:""},{default:a(()=>[l(Q,{style:{"min-width":"520px","max-width":"760px"}},{default:a(()=>[l(v,{class:"text-h6"},{default:a(()=>[_(w(i.dlg.mode==="create"?"Nuevo Producto":"Editar Producto"),1)]),_:1}),l(E),l(v,null,{default:a(()=>[l(F,{onSubmit:D(r.onSubmit,["prevent"]),ref:"formRef"},{default:a(()=>[n("div",Y,[n("div",z,[l(N,{modelValue:i.form.tipo_id,"onUpdate:modelValue":e[2]||(e[2]=t=>i.form.tipo_id=t),options:i.tipoOptions,"option-value":"id","option-label":"nombre_tipo","emit-value":"","map-options":"",dense:"",filled:"",label:"Tipo"},null,8,["modelValue","options"])]),n("div",L,[l(d,{modelValue:i.form.codigo_producto,"onUpdate:modelValue":e[3]||(e[3]=t=>i.form.codigo_producto=t),dense:"",filled:"",label:"Código"},null,8,["modelValue"])]),n("div",R,[l(d,{modelValue:i.form.nombre_producto,"onUpdate:modelValue":e[4]||(e[4]=t=>i.form.nombre_producto=t),dense:"",filled:"",label:"Nombre"},null,8,["modelValue"])]),n("div",Z,[l(d,{modelValue:i.form.presentacion,"onUpdate:modelValue":e[5]||(e[5]=t=>i.form.presentacion=t),dense:"",filled:"",label:"Presentación"},null,8,["modelValue"])]),n("div",j,[l(d,{modelValue:i.form.cantidad,"onUpdate:modelValue":e[6]||(e[6]=t=>i.form.cantidad=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Cantidad (kg)"},null,8,["modelValue"])]),n("div",G,[l(d,{modelValue:i.form.costo,"onUpdate:modelValue":e[7]||(e[7]=t=>i.form.costo=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Costo"},null,8,["modelValue"])]),n("div",H,[l(d,{modelValue:i.form.precio,"onUpdate:modelValue":e[8]||(e[8]=t=>i.form.precio=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",label:"Precio"},null,8,["modelValue"])]),n("div",J,[l(d,{modelValue:i.form.fecha_vencimiento,"onUpdate:modelValue":e[9]||(e[9]=t=>i.form.fecha_vencimiento=t),type:"date",dense:"",filled:"",label:"Fecha venc."},null,8,["modelValue"])]),n("div",W,[l(d,{modelValue:i.form.nro_lote,"onUpdate:modelValue":e[10]||(e[10]=t=>i.form.nro_lote=t),dense:"",filled:"",label:"Nro lote"},null,8,["modelValue"])]),n("div",X,[l(d,{modelValue:i.form.codigo_barra,"onUpdate:modelValue":e[11]||(e[11]=t=>i.form.codigo_barra=t),dense:"",filled:"",label:"Código de barras"},null,8,["modelValue"])])])]),_:1},8,["onSubmit"])]),_:1}),l(E),l(U,{align:"right"},{default:a(()=>[g(l(p,{flat:"",label:"Cancelar"},null,512),[[h]]),l(p,{color:"primary",loading:i.saving,disable:!r.canSubmit,label:"Guardar",onClick:r.onSubmit},null,8,["loading","disable","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(C,{modelValue:i.dlgImg.open,"onUpdate:modelValue":e[15]||(e[15]=t=>i.dlgImg.open=t),persistent:""},{default:a(()=>[l(Q,{style:{"min-width":"420px"}},{default:a(()=>[l(v,{class:"text-h6"},{default:a(()=>e[23]||(e[23]=[_("Imagen de producto")])),_:1}),l(v,null,{default:a(()=>[n("div",$,[n("div",ee,[l(k,{square:"",size:"140px"},{default:a(()=>[i.dlgImg.row?.imagen?(u(),m(q,{key:0,src:r.imgUrl(i.dlgImg.row.imagen),ratio:1},null,8,["src"])):(u(),m(b,{key:1,name:"image",size:"80px"}))]),_:1})]),n("div",oe,[n("input",{ref:"fileInput",type:"file",accept:"image/*",onChange:e[13]||(e[13]=(...t)=>r.onFileChange&&r.onFileChange(...t)),style:{display:"none"}},null,544),l(p,{outline:"","no-caps":"",color:"primary",icon:"upload",label:"Subir imagen",onClick:e[14]||(e[14]=t=>o.$refs.fileInput.click()),loading:i.uploading},null,8,["loading"])])])]),_:1}),l(U,{align:"right"},{default:a(()=>[g(l(p,{flat:"",label:"Cerrar"},null,512),[[h]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(C,{modelValue:i.dialogKardex,"onUpdate:modelValue":e[18]||(e[18]=t=>i.dialogKardex=t)},{default:a(()=>[l(Q,{style:{"min-width":"400px","max-width":"90vw"}},{default:a(()=>[l(v,{class:"row items-center"},{default:a(()=>[l(k,{icon:"article",color:"primary","text-color":"white",size:"lg"}),n("span",le,[e[24]||(e[24]=_("Seleccione el rango de fechas producto ")),n("b",null,w(o.producto.nombre_producto),1)])]),_:1}),l(v,null,{default:a(()=>[n("div",ie,[n("div",te,[l(d,{dense:"",modelValue:i.inicio,"onUpdate:modelValue":[e[16]||(e[16]=t=>i.inicio=t),r.generarKardex],label:"Desde",type:"date",filled:""},null,8,["modelValue","onUpdate:modelValue"])]),n("div",ae,[l(d,{dense:"",modelValue:i.fin,"onUpdate:modelValue":[e[17]||(e[17]=t=>i.fin=t),r.generarKardex],label:"Hasta",type:"date",filled:""},null,8,["modelValue","onUpdate:modelValue"])])]),e[25]||(e[25]=n("br",null,null,-1)),l(S,{rows:i.kardex,columns:i.colkardex,"row-key":"name",dense:""},null,8,["rows","columns"])]),_:1}),l(U,{align:"right"},{default:a(()=>[g(l(p,{flat:"",label:"Cancel",color:"primary"},null,512),[[h]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const xe=T(B,[["render",ne],["__scopeId","data-v-1f043377"]]);export{xe as default};
