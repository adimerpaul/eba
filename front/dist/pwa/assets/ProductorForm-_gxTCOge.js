import{Q as b}from"./QBanner-NxRyNOh3.js";import{_,c as p,o as f,w as a,a8 as v,b as r,a7 as d,t as m,a as s,ag as t,f as g}from"./index-CAulUK1l.js";import{Q as u}from"./QSelect-Db_8UKnU.js";import{Q as V,b as x}from"./position-engine-CzBd1S9u.js";import{Q as y}from"./QForm-BvqvUmRs.js";const U={name:"ProductorForm",props:{productor:{type:Object,default:null},tree:{type:Array,default:()=>[]},autoLoadTree:{type:Boolean,default:!0},bannerMsg:{type:String,default:""}},emits:["saved","cancel","error"],data(){return{tipos:["Pequeño Productor","Productor Individual","Organizacion de Productores","Asociacion"],dept:["LPZ","CBB","SCZ","ORU","POT","PND","BEN","TAR","SUC","OTRO"],localTree:[],saving:!1,banner:this.bannerMsg,orgOptions:[],orgLoading:!1,form:this.emptyForm(),sexoOptions:[{label:"Masculino",value:1},{label:"Femenino",value:2}]}},computed:{treeToUse(){return this.tree&&this.tree.length?this.tree:this.localTree},depOptions(){return(this.treeToUse||[]).map(e=>({label:e.nombre_departamento,value:e.id}))},provOptions(){const e=this.form.departamento_id;return e?((this.treeToUse||[]).find(n=>n.id===e)?.provincias||[]).map(n=>({label:n.nombre_provincia,value:n.id})):[]},munOptions(){const e=this.form.departamento_id,o=this.form.provincia_id;return!e||!o?[]:(((this.treeToUse||[]).find(i=>i.id===e)?.provincias||[]).find(i=>i.id===o)?.municipios||[]).map(i=>({label:i.nombre_municipio,value:i.id}))}},watch:{productor:{handler(){this.initFromProp()},immediate:!0}},mounted(){!this.tree?.length&&this.autoLoadTree&&this.loadTree()},methods:{emptyForm(){return{id:null,municipio_id:null,runsa:"0",sub_codigo:"",nombre:"",apellidos:"",numcarnet:"",expedido:"",fec_nacimiento:null,sexo:null,direccion:"",comunidad:"",proveedor:"",cip_acopio:"",num_celular:"",ocupacion:"",otros:"",seleccion:0,organizacion_id:null,fecha_registro:new Date().toISOString().slice(0,10),fecha_expiracion:null,estado:"VIGENTE",departamento_id:null,provincia_id:null}},async loadTree(){try{const{data:e}=await this.$axios.get("geo/tree");this.localTree=e}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar el árbol geográfico")}},initFromProp(){const e=this.productor;if(console.log(e),!e){this.form=this.emptyForm();return}this.form={id:e.id??null,runsa:e.runsa??"0",sub_codigo:e.sub_codigo??"",nombre:e.nombre??"",apellidos:e.apellidos??"",numcarnet:e.numcarnet??"",expedido:e.expedido??"",fec_nacimiento:e.fec_nacimiento??null,sexo:e.sexo??null,direccion:e.direccion??"",comunidad:e.comunidad??"",proveedor:e.proveedor??"",cip_acopio:e.cip_acopio??"",num_celular:e.num_celular??"",ocupacion:e.ocupacion??"",otros:e.otros??"",seleccion:e.seleccion??0,organizacion_id:e.organizacion?.id||e.organizacion_id||null,organizacion:e.organizacion||null,fecha_registro:e.fecha_registro??new Date().toISOString().slice(0,10),fecha_expiracion:e.fecha_expiracion??null,estado:e.estado??"VIGENTE",provincia_id:e.municipio?.provincia_id||null}},onDepChange(){this.form.provincia_id=null,this.form.municipio_id=null},onProvChange(){this.form.municipio_id=null},async filterOrganizaciones(e,o){o(async()=>{this.orgLoading=!0;try{const{data:n}=await this.$axios.get("organizaciones",{params:{search:e||void 0,paginate:!1}});console.log(n),this.orgOptions=Array.isArray(n)?n:n?.data||[]}catch{this.orgOptions=[]}finally{this.orgLoading=!1}})},async verificarDuplicados(){try{const e={};if(this.form.numcarnet&&(e.numcarnet=this.form.numcarnet),this.form.runsa&&this.form.runsa!=="0"&&(e.runsa=this.form.runsa),!e.numcarnet&&!e.runsa)return!1;const{data:o}=await this.$axios.get("productores-verificar-duplicado",{params:e});return o.existe?new Promise(n=>{this.$q.dialog({title:"Posible duplicado",message:`Ya existe un productor registrado:
                Nombre: ${o.datos.nombre_completo}
                CI: ${o.datos.numcarnet}
                RUNSA: ${o.datos.runsa}
                Estado: ${o.datos.estado}
                
                Desea ver el registro existente?`,cancel:{label:"Cancelar",flat:!0,color:"negative"},ok:{label:"Ver registro",color:"primary"},persistent:!0}).onOk(()=>{this.$router.push(`/productores/editar/${o.productor_id}`),n(!0)}).onCancel(()=>{n(!0)})}):!1}catch{return!1}},async submit(){if(!(!this.form.id&&await this.verificarDuplicados())){this.saving=!0;try{const e={runsa:this.form.runsa,sub_codigo:this.form.sub_codigo,nombre:this.form.nombre,apellidos:this.form.apellidos,numcarnet:this.form.numcarnet,expedido:this.form.expedido,fec_nacimiento:this.form.fec_nacimiento,sexo:this.form.sexo,direccion:this.form.direccion,comunidad:this.form.comunidad,proveedor:this.form.proveedor,cip_acopio:this.form.cip_acopio,num_celular:this.form.num_celular,ocupacion:this.form.ocupacion,otros:this.form.otros,seleccion:this.form.seleccion,organizacion_id:this.form.organizacion.id,fecha_registro:this.form.fecha_registro,fecha_expiracion:this.form.fecha_expiracion,estado:this.form.estado};let o;this.form.id?o=await this.$axios.put(`productores/${this.form.id}`,e):o=await this.$axios.post("productores",e);const n=o.data;this.form.id||this.$router.push("/productores/editar/"+n.id),this.$alert?.success?.(this.form.id?"Productor actualizado":"Productor creado")}catch(e){const o=e.response?.data?.message||"No se pudo guardar";this.$alert?.error?.(o),this.$emit("error",e)}finally{this.saving=!1}}}}},O={class:"row q-col-gutter-sm"},C={class:"col-6 col-sm-2"},I={class:"col-6 col-sm-2"},P={class:"col-12 col-sm-4"},T={class:"col-12 col-sm-4"},N={class:"col-6 col-sm-3"},z={class:"col-6 col-sm-2"},S={class:"col-12 col-sm-3"},w={class:"col-12 col-sm-4"},A={class:"col-12"},E={class:"col-12 col-sm-4"},F={class:"col-12 col-sm-4"},D={class:"col-12 col-sm-4"},B={class:"col-12 col-sm-4"},Q={class:"col-12 col-sm-4"},R={class:"col-12 col-sm-4"},q={class:"col-12 col-sm-4"},L={class:"col-12 col-sm-4"},k={class:"col-12 col-sm-4"},M={class:"col-12 col-sm-4"},G={class:"col-12 col-sm-4"},Z={class:"col-12"},j={class:"text-right q-gutter-sm"};function Y(e,o,n,h,i,c){return f(),p(y,{onSubmit:c.submit,class:"q-gutter-md"},{default:a(()=>[i.banner?(f(),p(b,{key:0,class:"bg-yellow-1 text-yellow-10"},{default:a(()=>[d(m(i.banner),1)]),_:1})):v("",!0),r("div",O,[r("div",C,[s(t,{modelValue:i.form.runsa,"onUpdate:modelValue":o[0]||(o[0]=l=>i.form.runsa=l),label:"RUNSA",dense:"",outlined:""},null,8,["modelValue"])]),r("div",I,[s(t,{modelValue:i.form.sub_codigo,"onUpdate:modelValue":o[1]||(o[1]=l=>i.form.sub_codigo=l),label:"Sub Código",dense:"",outlined:""},null,8,["modelValue"])]),r("div",P,[s(t,{modelValue:i.form.nombre,"onUpdate:modelValue":o[2]||(o[2]=l=>i.form.nombre=l),label:"Nombre",dense:"",outlined:"",rules:[l=>!!l||"Requerido"]},null,8,["modelValue","rules"])]),r("div",T,[s(t,{modelValue:i.form.apellidos,"onUpdate:modelValue":o[3]||(o[3]=l=>i.form.apellidos=l),label:"Apellidos",dense:"",outlined:"",rules:[l=>!!l||"Requerido"]},null,8,["modelValue","rules"])]),r("div",N,[s(t,{modelValue:i.form.numcarnet,"onUpdate:modelValue":o[4]||(o[4]=l=>i.form.numcarnet=l),label:"N° Carnet",dense:"",outlined:"",rules:[l=>!!l||"Requerido"]},null,8,["modelValue","rules"])]),r("div",z,[s(u,{modelValue:i.form.expedido,"onUpdate:modelValue":o[5]||(o[5]=l=>i.form.expedido=l),label:"Expedido",dense:"",outlined:"",options:i.dept},null,8,["modelValue","options"])]),r("div",S,[s(t,{modelValue:i.form.fec_nacimiento,"onUpdate:modelValue":o[6]||(o[6]=l=>i.form.fec_nacimiento=l),type:"date",label:"Nacimiento",dense:"",outlined:""},null,8,["modelValue"])]),r("div",w,[s(u,{modelValue:i.form.sexo,"onUpdate:modelValue":o[7]||(o[7]=l=>i.form.sexo=l),options:i.sexoOptions,label:"Sexo",dense:"",outlined:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),r("div",A,[s(t,{modelValue:i.form.direccion,"onUpdate:modelValue":o[8]||(o[8]=l=>i.form.direccion=l),type:"textarea",label:"Dirección",dense:"",outlined:"",autogrow:""},null,8,["modelValue"])]),r("div",E,[s(t,{modelValue:i.form.comunidad,"onUpdate:modelValue":o[9]||(o[9]=l=>i.form.comunidad=l),label:"Comunidad",dense:"",outlined:""},null,8,["modelValue"])]),r("div",F,[s(u,{modelValue:i.form.cip_acopio,"onUpdate:modelValue":o[10]||(o[10]=l=>i.form.cip_acopio=l),label:"CIP Acopio",options:["CIP MONTEAGUDO","CIP IRUPANA","CIP ZABUZABETI"],dense:"",outlined:""},null,8,["modelValue"])]),r("div",D,[s(t,{modelValue:i.form.num_celular,"onUpdate:modelValue":o[11]||(o[11]=l=>i.form.num_celular=l),label:"Celular",dense:"",outlined:""},null,8,["modelValue"])]),r("div",B,[s(t,{modelValue:i.form.seleccion,"onUpdate:modelValue":o[12]||(o[12]=l=>i.form.seleccion=l),modelModifiers:{number:!0},type:"number",label:"Selección",dense:"",outlined:""},null,8,["modelValue"])]),r("div",Q,[s(u,{modelValue:i.form.organizacion,"onUpdate:modelValue":o[13]||(o[13]=l=>i.form.organizacion=l),label:"Organización",dense:"",outlined:"","use-input":"","fill-input":"","input-debounce":"300",options:i.orgOptions,"option-label":"nombre_organiza","emit-value":"","map-options":"",clearable:"",onFilter:c.filterOrganizaciones,loading:i.orgLoading,hint:"Escribe para buscar"},{"no-option":a(()=>[s(V,null,{default:a(()=>[s(x,{class:"text-grey"},{default:a(()=>o[19]||(o[19]=[d("Sin resultados")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","loading"])]),r("div",R,[o[20]||(o[20]=r("b",null,"DEPT:",-1)),d(" "+m(i.form.organizacion?.departamento.nombre_departamento),1)]),r("div",q,[o[21]||(o[21]=r("b",null,"Mun:",-1)),d(" "+m(i.form.organizacion?.municipio.nombre_municipio),1)]),r("div",L,[o[22]||(o[22]=r("b",null,"Prov:",-1)),d(" "+m(i.form.organizacion?.provincia.nombre_provincia),1)]),r("div",k,[s(t,{modelValue:i.form.fecha_registro,"onUpdate:modelValue":o[14]||(o[14]=l=>i.form.fecha_registro=l),type:"date",label:"Fecha Registro",dense:"",outlined:""},null,8,["modelValue"])]),r("div",M,[s(t,{modelValue:i.form.fecha_expiracion,"onUpdate:modelValue":o[15]||(o[15]=l=>i.form.fecha_expiracion=l),type:"date",label:"Fecha Expiración",dense:"",outlined:""},null,8,["modelValue"])]),r("div",G,[s(u,{modelValue:i.form.estado,"onUpdate:modelValue":o[16]||(o[16]=l=>i.form.estado=l),options:["VIGENTE","VENCIDO","ACTIVO","INACTIVO"],label:"Estado",dense:"",outlined:""},null,8,["modelValue"])]),r("div",Z,[s(t,{modelValue:i.form.otros,"onUpdate:modelValue":o[17]||(o[17]=l=>i.form.otros=l),type:"textarea",label:"Otros",dense:"",outlined:"",autogrow:""},null,8,["modelValue"])])]),r("div",j,[s(g,{flat:"",color:"negative",label:"Cancelar",disable:i.saving,onClick:o[18]||(o[18]=l=>e.$emit("cancel"))},null,8,["disable"]),s(g,{color:"primary",label:i.form.id?"Guardar cambios":"Crear productor",type:"submit",loading:i.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])}const $=_(U,[["render",Y],["__scopeId","data-v-02a119e3"]]);export{$ as P};
