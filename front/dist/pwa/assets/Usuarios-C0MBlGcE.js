import{Q as F,a as P,b as G,c as _}from"./QTabPanels-Mb8SkNXY.js";import{_ as S,c as g,o as d,w as o,a,O as A,aa as v,ab as x,ac as w,a8 as y,t as m,af as T,f as u,h as k,Q as V,e as p,b as c,a9 as N,ag as f,d as Q,ah as R}from"./index-7y1xTPo0.js";import{Q as q,a as h}from"./QTable-B1wpqvb1.js";import{d as z,Q as E,b as I}from"./format-DML4119o.js";import{Q as U}from"./QSpace-BL4iU9Lh.js";import{Q as O}from"./QSelect-DyaU-PEd.js";import{Q as D}from"./QForm-DbcSivmX.js";import{Q as Z}from"./QList-De_fUt_D.js";import{Q as B}from"./QPage-BsPoimEa.js";import"./moment-C5S46NFB.js";import"./QResizeObserver-BDZdvI0v.js";import"./use-panel-BtgOCEjP.js";import"./touch-BjYP5sR0.js";import"./selection-DMQW0dhV.js";import"./QMarkupTable-DKld9FxK.js";import"./use-fullscreen-CxVTVmKE.js";const L={name:"UsuariosPage",data(){return{tab:"internos",users:[],user:{},userDialog:!1,loading:!1,actionUser:"",gestiones:[],filter:"",roles:["Usuario","Gerente","Productor","Produccion","Administrativo"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"avatar",label:"Avatar",align:"left",field:r=>r.avatar},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:r=>(r.permissions||[]).map(e=>e.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1,docentes:[],permisosTargetType:null,permisosTargetId:null,bpUsers:[],loadingInternos:!1,filterInterno:"",bpColumns:[{name:"actions",label:"Acciones",align:"center"},{name:"usr_id",label:"ID",field:"usr_id",align:"left"},{name:"usr_usuario",label:"Usuario",field:"usr_usuario",align:"left"},{name:"traza",label:"TRAZA",field:"traza_activado",align:"center"},{name:"sistemas",label:"Sistemas",field:"usr_access_sistem",align:"left"}]}},async mounted(){this.usersGet(),this.bpUsersGet()},methods:{onFileChange(r){const e=r.target.files[0],i=new FormData;i.append("avatar",e),this.loading=!0,this.$axios.post(this.user.id+"/avatar",i,{headers:{"Content-Type":"multipart/form-data"}}).then(b=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(b=>{this.$alert.error(b.response.data.message)}).finally(()=>{this.loading=!1})},cambiarAvatar(r){this.cambioAvatarDialogo=!0,this.user={...r}},userNew(){this.user={name:"",email:"",password:"",area_id:1,username:"",cargo:"",role:"Usuario"},this.actionUser="Nuevo",this.userDialog=!0},usersGet(){this.loading=!0,this.users=[],this.$axios.get("users").then(r=>{this.users=r.data}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(r=>{this.userDialog=!1,this.$alert.success("User creado"),this.usersGet()}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put("users/"+this.user.id,this.user).then(r=>{this.usersGet(),this.userDialog=!1,this.$alert.success("User actualizado")}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},async permisosShow(r){this.dialogPermisos=!0,this.loading=!0,r.id?(this.permisosTargetType="external",this.permisosTargetId=r.id,this.user={...r}):(this.permisosTargetType="internal",this.permisosTargetId=r.usr_id,this.user={username:r.usr_usuario});try{const e=await this.$axios.get("permissions").then(l=>l.data),i=this.permisosTargetType==="external"?`users/${this.permisosTargetId}/permissions`:`bp-usuarios/${this.permisosTargetId}/permissions`,b=await this.$axios.get(i).then(l=>l.data);this.permissions=e.map(l=>({...l,checked:b.includes(l.id)}))}catch(e){this.$alert.error(e.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const r=this.permissions.filter(i=>i.checked).map(i=>i.id),e=this.permisosTargetType==="external"?`users/${this.permisosTargetId}/permissions`:`bp-usuarios/${this.permisosTargetId}/permissions`;await this.$axios.put(e,{permissions:r}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.permisosTargetType==="external"?this.usersGet():this.bpUsersGet()}catch(r){this.$alert.error(r.response?.data?.message||"No se pudo guardar")}finally{this.loading=!1}},userEditPassword(r){this.user={...r},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(e=>{this.$axios.put("updatePassword/"+r.id,{password:e}).then(i=>{this.usersGet(),this.$alert.success("Contraseña actualizada de "+r.username)}).catch(i=>{this.$alert.error(i.response.data.message)})})},userEdit(r){this.user={...r},this.actionUser="Editar",this.userDialog=!0},userDelete(r){this.$alert.dialog("¿Desea eliminar el user?").onOk(()=>{this.loading=!0,this.$axios.delete("users/"+r).then(e=>{this.usersGet(),this.$alert.success("User eliminado")}).catch(e=>{this.$alert.error(e.response.data.message)}).finally(()=>{this.loading=!1})})},bpUsersGet(){this.loadingInternos=!0,this.$axios.get("bp-usuarios").then(r=>{this.bpUsers=r.data}).catch(r=>{this.$alert.error(r.response?.data?.message||"Error cargando usuarios internos")}).finally(()=>{this.loadingInternos=!1})},toggleTraza(r,e){this.$axios.put(`bp-usuarios/${r.usr_id}/traza`,{activado:e}).then(()=>{this.$alert.success(`TRAZA ${e?"activado":"desactivado"} para ${r.usr_usuario}`)}).catch(i=>{this.$alert.error(i.response?.data?.message||"No se pudo actualizar TRAZA"),r.traza_activado=!e})}},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const r=this.permFilter.toLowerCase();return this.permissions.filter(e=>e.name.toLowerCase().includes(r))},bpUsersFiltered(){if(!this.filterInterno)return this.bpUsers;const r=this.filterInterno.toLowerCase();return this.bpUsers.filter(e=>String(e.usr_usuario||"").toLowerCase().includes(r)||String(e.usr_id||"").includes(r))}}},j={class:"text-right q-mt-md"},H={style:{position:"relative",top:"0",left:"0"}},J=["src"],K={class:"text-right q-mt-md"};function M(r,e,i,b,l,n){return d(),g(B,{class:"q-pa-md"},{default:o(()=>[a(F,{modelValue:l.tab,"onUpdate:modelValue":e[0]||(e[0]=s=>l.tab=s),dense:"",class:"text-primary q-mb-md",align:"left","active-color":"primary","indicator-color":"primary"},{default:o(()=>[a(P,{name:"internos",label:"Usuarios internos",icon:"badge","no-caps":""}),a(P,{name:"externos",label:"Usuarios externos",icon:"person","no-caps":""})]),_:1},8,["modelValue"]),a(A,{class:"q-mb-md"}),a(G,{modelValue:l.tab,"onUpdate:modelValue":e[17]||(e[17]=s=>l.tab=s),animated:""},{default:o(()=>[a(_,{name:"externos"},{default:o(()=>[a(q,{rows:n.bpUsersFiltered,columns:l.bpColumns,"row-key":"usr_id",dense:"",flat:"","rows-per-page-options":[0]},{"body-cell-actions":o(s=>[a(h,{props:s},{default:o(()=>[a(u,{color:"primary",label:"Permisos","no-caps":"",size:"10px",onClick:t=>n.permisosShow(s.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-traza":o(s=>[a(h,{props:s},{default:o(()=>[a(T,{modelValue:s.row.traza_activado,"onUpdate:modelValue":[t=>s.row.traza_activado=t,t=>n.toggleTraza(s.row,t)],color:"primary",label:"TRAZA"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-sistemas":o(s=>[a(h,{props:s},{default:o(()=>[(d(!0),v(x,null,w(s.row.usr_access_sistem||[],(t,C)=>(d(),g(z,{key:C,dense:"",outline:"",color:t.sistema==="TRAZA"?t.activado?"green-5":"red-5":"grey-4","text-color":"black",class:"q-mr-xs q-mb-xs",size:"11px"},{default:o(()=>[y(m(t.sistema)+" ("+m(t.activado?"ON":"OFF")+") ",1)]),_:2},1032,["color"]))),128))]),_:2},1032,["props"])]),_:1},8,["rows","columns"]),a(k,{modelValue:l.userDialog,"onUpdate:modelValue":e[9]||(e[9]=s=>l.userDialog=s),persistent:""},{default:o(()=>[a(V,{style:{width:"400px"}},{default:o(()=>[a(p,{class:"q-pb-none row items-center"},{default:o(()=>[c("div",null,m(l.actionUser)+" user ",1),a(U),a(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=s=>l.userDialog=!1)})]),_:1}),a(p,{class:"q-pt-none"},{default:o(()=>[a(D,{onSubmit:e[8]||(e[8]=s=>l.user.id?n.userPut():n.userPost())},{default:o(()=>[a(f,{modelValue:l.user.name,"onUpdate:modelValue":e[2]||(e[2]=s=>l.user.name=s),label:"Nombre",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"]),a(f,{modelValue:l.user.username,"onUpdate:modelValue":e[3]||(e[3]=s=>l.user.username=s),label:"Usuario",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"]),a(f,{modelValue:l.user.email,"onUpdate:modelValue":e[4]||(e[4]=s=>l.user.email=s),label:"Email",dense:"",outlined:"",hint:""},null,8,["modelValue"]),l.user.id?N("",!0):(d(),g(f,{key:0,modelValue:l.user.password,"onUpdate:modelValue":e[5]||(e[5]=s=>l.user.password=s),label:"Contraseña",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"])),a(O,{modelValue:l.user.role,"onUpdate:modelValue":e[6]||(e[6]=s=>l.user.role=s),label:"Rol",dense:"",outlined:"",options:l.roles,rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","options","rules"]),c("div",j,[a(u,{color:"negative",label:"Cancelar",onClick:e[7]||(e[7]=s=>l.userDialog=!1),"no-caps":"",loading:l.loading},null,8,["loading"]),a(u,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:l.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(k,{modelValue:l.cambioAvatarDialogo,"onUpdate:modelValue":e[15]||(e[15]=s=>l.cambioAvatarDialogo=s),persistent:""},{default:o(()=>[a(V,null,{default:o(()=>[a(p,{class:"q-pb-none row items-center text-bold"},{default:o(()=>[e[22]||(e[22]=y(" Cambiar avatar ")),a(U),a(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[10]||(e[10]=s=>l.cambioAvatarDialogo=!1)})]),_:1}),a(p,{class:"q-pt-none"},{default:o(()=>[a(D,{onSubmit:e[14]||(e[14]=s=>n.userPut())},{default:o(()=>[c("div",null,[c("div",H,[a(u,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:e[11]||(e[11]=s=>r.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""})]),l.user.avatar?(d(),v("img",{key:0,src:`${r.$url}/../images/${l.user.avatar}`,width:"300px",height:"300px"},null,8,J)):(d(),g(Q,{key:1,name:"person",size:"100px"})),c("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:e[12]||(e[12]=(...s)=>n.onFileChange&&n.onFileChange(...s)),accept:"image/*"},null,544)]),c("div",K,[a(u,{color:"negative",label:"Cancelar",onClick:e[13]||(e[13]=s=>l.cambioAvatarDialogo=!1),"no-caps":"",loading:l.loading},null,8,["loading"]),a(u,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:l.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(_,{name:"internos"},{default:o(()=>[a(V,{flat:"",bordered:""},{default:o(()=>[a(p,{class:"row items-center q-col-gutter-sm"},{default:o(()=>[e[23]||(e[23]=c("div",{class:"text-h6"}," Usuarios internos ",-1)),a(U),a(u,{color:"primary",label:"Actualizar",icon:"refresh","no-caps":"",loading:l.loadingInternos,onClick:n.bpUsersGet},null,8,["loading","onClick"]),a(f,{modelValue:l.filterInterno,"onUpdate:modelValue":e[16]||(e[16]=s=>l.filterInterno=s),dense:"",outlined:"",placeholder:"Buscar usuario interno...",class:"q-ml-sm"},{append:o(()=>[a(Q,{name:"search"})]),_:1},8,["modelValue"])]),_:1}),a(A),a(q,{rows:n.bpUsersFiltered,columns:l.bpColumns,"row-key":"usr_id",dense:"",flat:"","rows-per-page-options":[0]},{"body-cell-actions":o(s=>[a(h,{props:s},{default:o(()=>[a(u,{color:"primary",label:"Permisos","no-caps":"",size:"10px",onClick:t=>n.permisosShow(s.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-traza":o(s=>[a(h,{props:s},{default:o(()=>[a(T,{modelValue:s.row.traza_activado,"onUpdate:modelValue":[t=>s.row.traza_activado=t,t=>n.toggleTraza(s.row,t)],color:"primary",label:"TRAZA"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-sistemas":o(s=>[a(h,{props:s},{default:o(()=>[(d(!0),v(x,null,w(s.row.usr_access_sistem||[],(t,C)=>(d(),g(z,{key:C,dense:"",outline:"",color:t.sistema==="TRAZA"?t.activado?"green-5":"red-5":"grey-4","text-color":"black",class:"q-mr-xs q-mb-xs",size:"11px"},{default:o(()=>[y(m(t.sistema)+" ("+m(t.activado?"ON":"OFF")+") ",1)]),_:2},1032,["color"]))),128))]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(k,{modelValue:l.dialogPermisos,"onUpdate:modelValue":e[21]||(e[21]=s=>l.dialogPermisos=s),persistent:""},{default:o(()=>[a(V,{style:{"min-width":"420px"}},{default:o(()=>[a(p,{class:"q-pb-none row items-center text-bold"},{default:o(()=>[y(" Permisos de "+m(l.user.username)+" ",1),a(U),a(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[18]||(e[18]=s=>l.dialogPermisos=!1)})]),_:1}),a(p,{class:"q-pt-none"},{default:o(()=>[a(f,{modelValue:l.permFilter,"onUpdate:modelValue":e[19]||(e[19]=s=>l.permFilter=s),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:o(()=>[a(Q,{name:"search"})]),_:1},8,["modelValue"]),a(Z,{dense:"",bordered:""},{default:o(()=>[(d(!0),v(x,null,w(n.filteredPermissions,s=>(d(),g(E,{key:s.id},{default:o(()=>[a(I,null,{default:o(()=>[y(m(s.name),1)]),_:2},1024),a(I,{side:""},{default:o(()=>[a(T,{modelValue:s.checked,"onUpdate:modelValue":t=>s.checked=t},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),a(R,{align:"right"},{default:o(()=>[a(u,{color:"negative",label:"Cancelar",onClick:e[20]||(e[20]=s=>l.dialogPermisos=!1),"no-caps":"",loading:l.loading},null,8,["loading"]),a(u,{color:"primary",label:"Guardar",onClick:n.permisosPost,"no-caps":"",loading:l.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const pe=S(L,[["render",M]]);export{pe as default};
