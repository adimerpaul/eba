import{_ as G,c as g,o as c,w as a,b as s,a as t,f as y,aa as p,a9 as h,ab as M,ac as z,t as i,P as N,d as k,a8 as f,ad as J,h as R,Q as q,e as b,O as E,af as V,v as X,aA as oe,aB as te,j as Q,aC as se,G as re,J as ae,g as le,aD as ie,x as H,T as ne,aE as de,az as W,a7 as x}from"./index-D1veR3Bv.js";import{Q as D}from"./QSpace-BakFp9oR.js";import{Q as B,a as v,b as K,c as _}from"./QTabPanels-XC0VXoy4.js";import{Q as ce}from"./QPage-pL9SuAMk.js";import{P as ue}from"./ProductorForm-Be6LJ8Hh.js";import{M as me,L as pe,P as ge,a as he,b as fe,c as be}from"./MedicamentosFormulario-BNesKO0L.js";import{Q as Z,b as I,d as P}from"./format-awEb2v4z.js";import{Q as _e}from"./QList-swL56IPN.js";import{Q as ye}from"./QBtnDropdown-DZUy5qDE.js";import{Q as O}from"./QMarkupTable-ipDBAlFy.js";import{Q as T}from"./QSelect-6prwkjNH.js";import{Q as $}from"./QForm-D9M1quzy.js";import{C as S}from"./ClosePopup-CbG92mso.js";import{Q as L}from"./QTooltip-C1q2JXQQ.js";import{Q as xe}from"./QBanner-BXSO-vxu.js";import{C as ve}from"./auto-DHENdVy-.js";import{h as j}from"./moment-C5S46NFB.js";import"./QResizeObserver-fcYpRwZc.js";import"./use-panel-BrNsS0dh.js";import"./touch-BjYP5sR0.js";import"./selection-D0_96xKN.js";import"./marker-shadow-G3KGTzTB.js";import"./QBadge-Bied9Mu-.js";const Ce={name:"ProductorRunsas",props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm()}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},methods:{hydrateFromProductor(){this.productor?.runsas?this.list=this.productor.runsas:this.fetchRunsas()},async fetchRunsas(){console.log(this.productor),this.loading=!0;try{const{data:o}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});console.log(o),this.list=Array.isArray(o)?o:o?.data||[]}catch(o){console.log(o),this.list=[],this.$alert?.error?.(o.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(o){return o==="VIGENTE"?"green":o==="VENCIDO"?"red":o==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(o){this.form={id:o.id,productor_id:this.productor?.id||o.productor_id,codigo:o.codigo||null,subcodigo:o.subcodigo||"",fecha_registro:o.fecha_registro||null,fecha_vencimiento:o.fecha_vencimiento||null,estado:o.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const o={...this.form,productor_id:this.productor.id};o.id?await this.$axios.put(`runsas/${o.id}`,o):await this.$axios.post("runsas",o),this.$alert?.success?.(o.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(o){this.$alert?.error?.(o.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(o){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${o.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo eliminar")}})}}},ke={class:"row items-center q-gutter-sm q-mb-sm"},Pe={key:0},Ve={class:"text-h6"},we={class:"col-12 col-sm-4"},Ee={class:"col-12 col-sm-8"},Ne={class:"col-6 col-sm-3"},Se={class:"col-6 col-sm-3"},De={class:"col-12 col-sm-3"},Ae={class:"col-12 text-right q-gutter-sm q-mt-sm"};function qe(o,e,u,m,r,n){return c(),g(b,null,{default:a(()=>[s("div",ke,[e[6]||(e[6]=s("div",{class:"text-subtitle1"},"Certificaciones Runsa",-1)),t(D),t(y,{dense:"",color:"primary",icon:"add_circle",label:"Nueva",onClick:n.startCreate,disable:r.saving,"no-caps":""},null,8,["onClick","disable"])]),t(O,{dense:""},{default:a(()=>[e[10]||(e[10]=s("thead",null,[s("tr",{class:"bg-grey-3"},[s("th",{class:"text-left"},"#"),s("th",{class:"text-left",style:{width:"120px"}},"Opciones"),s("th",{class:"text-left"},"Codigo"),s("th",{class:"text-left"},"Subcodigo"),s("th",{class:"text-left"},"Registro"),s("th",{class:"text-left"},"Vencimiento"),s("th",{class:"text-left"},"Estado")])],-1)),s("tbody",null,[(c(!0),p(M,null,z(r.list||[],(l,C)=>(c(),p("tr",{key:l.id||C},[s("td",null,i(C+1),1),s("td",null,[t(ye,{dense:"",label:"Opciones",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[t(_e,null,{default:a(()=>[N((c(),g(Z,{clickable:"",onClick:w=>n.startEdit(l)},{default:a(()=>[t(I,{avatar:""},{default:a(()=>[t(k,{name:"edit"})]),_:1}),t(I,null,{default:a(()=>e[7]||(e[7]=[f("Editar")])),_:1})]),_:2},1032,["onClick"])),[[J],[S]]),N((c(),g(Z,{clickable:"",onClick:w=>n.remove(l)},{default:a(()=>[t(I,{avatar:""},{default:a(()=>[t(k,{name:"delete",class:"text-negative"})]),_:1}),t(I,{class:"text-negative"},{default:a(()=>e[8]||(e[8]=[f("Eliminar")])),_:1})]),_:2},1032,["onClick"])),[[J],[S]])]),_:2},1024)]),_:2},1024)]),s("td",null,i(l.codigo||"-"),1),s("td",null,i(l.subcodigo||"-"),1),s("td",null,i(l.fecha_registro||"-"),1),s("td",null,i(l.fecha_vencimiento||"-"),1),s("td",null,[t(P,{color:n.chip(l.estado),"text-color":"white",size:"xs",class:"text-bold"},{default:a(()=>[f(i(l.estado),1)]),_:2},1032,["color"])])]))),128)),!r.loading&&(u.productor?.runsas?.length||0)===0?(c(),p("tr",Pe,e[9]||(e[9]=[s("td",{colspan:"8",class:"text-center text-grey"},"Sin registros",-1)]))):h("",!0)])]),_:1}),t(R,{modelValue:r.dlg.open,"onUpdate:modelValue":e[5]||(e[5]=l=>r.dlg.open=l),persistent:""},{default:a(()=>[t(q,{style:{"min-width":"720px","max-width":"95vw"}},{default:a(()=>[t(b,{class:"row items-center q-gutter-sm"},{default:a(()=>[s("div",Ve,i(r.form.id?"Editar runsa":"Nueva runsa"),1),t(D),N(t(y,{flat:"",round:"",dense:"",icon:"close"},null,512),[[S]])]),_:1}),t(E),t(b,null,{default:a(()=>[t($,{onSubmit:n.submit,class:"row q-col-gutter-sm"},{default:a(()=>[s("div",we,[t(V,{modelValue:r.form.codigo,"onUpdate:modelValue":e[0]||(e[0]=l=>r.form.codigo=l),dense:"",outlined:"",label:"Codigo",rules:[l=>!!l||"Requerido"]},null,8,["modelValue","rules"])]),s("div",Ee,[t(V,{modelValue:r.form.subcodigo,"onUpdate:modelValue":e[1]||(e[1]=l=>r.form.subcodigo=l),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),s("div",Ne,[t(V,{modelValue:r.form.fecha_registro,"onUpdate:modelValue":e[2]||(e[2]=l=>r.form.fecha_registro=l),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),s("div",Se,[t(V,{modelValue:r.form.fecha_vencimiento,"onUpdate:modelValue":e[3]||(e[3]=l=>r.form.fecha_vencimiento=l),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),s("div",De,[t(T,{modelValue:r.form.estado,"onUpdate:modelValue":e[4]||(e[4]=l=>r.form.estado=l),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),s("div",Ae,[N(t(y,{flat:"",color:"grey",label:"Cancelar",disable:r.saving},null,8,["disable"]),[[S]]),t(y,{color:"primary",label:r.form.id?"Guardar cambios":"Crear",type:"submit",loading:r.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Fe=G(Ce,[["render",qe]]),Ue='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>',Qe=X({name:"QSpinnerDots",props:oe,setup(o){const{cSize:e,classes:u}=te(o);return()=>Q("svg",{class:u.value,fill:"currentColor",width:e.value,height:e.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:Ue})}}),Ie=X({name:"QInnerLoading",props:{...re,...se,showing:Boolean,color:String,size:{type:[String,Number],default:"42px"},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(o,{slots:e}){const u=le(),m=ae(o,u.proxy.$q),{transitionProps:r,transitionStyle:n}=ie(o),l=H(()=>"q-inner-loading q--avoid-card-border absolute-full column flex-center"+(m.value===!0?" q-inner-loading--dark":"")),C=H(()=>"q-inner-loading__label"+(o.labelClass!==void 0?` ${o.labelClass}`:""));function w(){const A=[Q(de,{size:o.size,color:o.color})];return o.label!==void 0&&A.push(Q("div",{class:C.value,style:o.labelStyle},[o.label])),A}function F(){return o.showing===!0?Q("div",{class:l.value,style:n.value},e.default!==void 0?e.default():w()):null}return()=>Q(ne,r.value,F)}}),Me={name:"ProductorAcopiosGestion",props:{productor:{type:Object,required:!0}},data(){return{loading:!1,loadingProductos:!1,loadingExcel:!1,gestionSeleccionada:j().year(),productoSeleccionado:1,gestiones:[],productos:[],datosProductor:null,meses:[],totalKg:0,totalEntregas:0,promedioEntrega:0,chartInstance:null}},computed:{datosDisponibles(){return this.meses.length>0&&this.totalKg>0}},mounted(){this.generarGestiones(),this.cargarProductos(),this.cargarAcopios()},beforeUnmount(){this.chartInstance&&this.chartInstance.destroy()},methods:{generarGestiones(){const o=j().year(),e=[];for(let u=o;u>=2020;u--)e.push(u);this.gestiones=e},async cargarProductos(){this.loadingProductos=!0;try{const{data:o}=await this.$axios.get("/productos/tipo/1");this.productos=o?.data||o||[],this.productos.length===0&&this.$alert?.warning?.("No se encontraron productos tipo miel")}catch(o){console.error("Error cargando productos:",o),this.$alert?.error?.("No se pudieron cargar los productos"),this.productos=[]}finally{this.loadingProductos=!1}},async cargarAcopios(){if(!this.productor?.id){console.error("No hay productor seleccionado");return}this.loading=!0;try{const{data:o}=await this.$axios.get(`/productores/${this.productor.id}/acopios-gestion`,{params:{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado}});this.datosProductor={productor:o.productor,runsa:o.runsa,municipio:o.municipio,organizacion:o.organizacion},this.meses=o.meses||[],this.totalKg=Number(o.total_kg||0),this.totalEntregas=Number(o.total_entregas||0),this.promedioEntrega=Number(o.promedio_entrega||0),this.$nextTick(()=>{this.renderChart()})}catch(o){console.error("Error cargando acopios:",o),this.$alert?.error?.(o.response?.data?.message||"Error al cargar acopios por gestión"),this.meses=[],this.totalKg=0,this.totalEntregas=0,this.promedioEntrega=0}finally{this.loading=!1}},renderChart(){if(!this.$refs.chartCanvas){console.warn("Canvas no está disponible");return}this.chartInstance&&this.chartInstance.destroy();const o=this.meses.map(m=>m.mes_nombre),e=this.meses.map(m=>Number(m.cantidad_kg)),u=this.meses.map(m=>Number(m.num_entregas));this.chartInstance=new ve(this.$refs.chartCanvas,{type:"bar",data:{labels:o,datasets:[{label:"Cantidad (kg)",data:e,backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,yAxisID:"y"},{label:"N° Entregas",data:u,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:1,type:"line",yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"},title:{display:!0,text:`Acopios Gestión ${this.gestionSeleccionada} (Julio-Junio)`},tooltip:{callbacks:{footer:m=>{const r=m[0].dataIndex,n=this.meses[r];return n&&n.num_entregas>0?`Promedio/entrega: ${(n.cantidad_kg/n.num_entregas).toFixed(2)} kg`:""}}}},scales:{y:{type:"linear",position:"left",beginAtZero:!0,title:{display:!0,text:"Kilogramos (kg)"}},y1:{type:"linear",position:"right",beginAtZero:!0,title:{display:!0,text:"Número de entregas"},grid:{drawOnChartArea:!1}}}}})},formatNumber(o){const e=Number(o);return isNaN(e)?"0.00":e.toFixed(2)},async exportarExcel(){if(!this.datosDisponibles){this.$alert?.warning?.("No hay datos para exportar");return}this.loadingExcel=!0;try{const o=await this.$axios.post(`/productores/${this.productor.id}/acopios-gestion-excel`,{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado},{responseType:"blob"}),e=new Blob([o.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),u=window.URL.createObjectURL(e),m=document.createElement("a");m.href=u;const r=this.datosProductor?.productor?.replace(/\s+/g,"_")||"productor";m.setAttribute("download",`acopios_${r}_${this.gestionSeleccionada}.xlsx`),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(u),this.$alert?.success?.("Archivo Excel descargado correctamente")}catch(o){console.error("Error exportando a Excel:",o),this.$alert?.error?.(o.response?.data?.message||"No se pudo generar el archivo Excel")}finally{this.loadingExcel=!1}}}},ze={class:"row items-center q-gutter-sm q-mb-md"},Oe={class:"row q-col-gutter-md"},Te={class:"col-auto"},Ge={class:"text-weight-medium"},Re={key:0,class:"col-auto"},Be={class:"text-weight-medium"},Ke={key:1,class:"col-auto"},Le={class:"text-weight-medium"},je={key:2,class:"col-auto"},Ye={class:"text-weight-medium"},Je={class:"text-left"},He={class:"text-weight-medium"},We={key:0,class:"text-caption text-grey-7 q-ml-xs"},Ze={class:"text-right"},Xe={class:"text-right"},$e={key:1,class:"text-grey-5"},eo={class:"text-right"},oo={key:0,class:"text-grey-8"},to={key:1,class:"text-grey-5"},so={class:"bg-grey-3 text-weight-bold"},ro={class:"text-left text-uppercase"},ao={class:"text-right text-primary"},lo={class:"text-right"},io={class:"text-right text-grey-8"},no={class:"text-caption text-grey-5"},co={class:"text-subtitle2 q-mb-md"},uo={ref:"chartCanvas",height:"100"};function mo(o,e,u,m,r,n){return c(),g(b,null,{default:a(()=>[s("div",ze,[e[4]||(e[4]=s("div",{class:"text-subtitle1 text-weight-medium"},"Acopios por Gestión (Julio-Junio)",-1)),t(D),t(T,{modelValue:r.gestionSeleccionada,"onUpdate:modelValue":[e[0]||(e[0]=l=>r.gestionSeleccionada=l),n.cargarAcopios],options:r.gestiones,label:"Gestión",dense:"",outlined:"",style:{"min-width":"130px"},loading:r.loading},{prepend:a(()=>[t(k,{name:"event"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),t(T,{modelValue:r.productoSeleccionado,"onUpdate:modelValue":[e[1]||(e[1]=l=>r.productoSeleccionado=l),n.cargarAcopios],options:r.productos,"option-label":"nombre_producto","option-value":"id","emit-value":"","map-options":"",label:"Producto",dense:"",outlined:"",style:{"min-width":"200px"},loading:r.loadingProductos},{prepend:a(()=>[t(k,{name:"inventory"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),t(y,{color:"green",icon:"download",label:"Excel",dense:"","no-caps":"",onClick:n.exportarExcel,loading:r.loadingExcel,disable:!n.datosDisponibles},{default:a(()=>[n.datosDisponibles?h("",!0):(c(),g(L,{key:0},{default:a(()=>e[2]||(e[2]=[f(" No hay datos para exportar ")])),_:1}))]),_:1},8,["onClick","loading","disable"]),t(y,{color:"primary",icon:"refresh",dense:"",round:"",flat:"",onClick:n.cargarAcopios,loading:r.loading},{default:a(()=>[t(L,null,{default:a(()=>e[3]||(e[3]=[f("Recargar datos")])),_:1})]),_:1},8,["onClick","loading"])]),r.datosProductor?(c(),g(xe,{key:0,dense:"",class:"bg-blue-1 q-mb-md",rounded:""},{avatar:a(()=>[t(k,{name:"person",color:"primary"})]),default:a(()=>[s("div",Oe,[s("div",Te,[e[5]||(e[5]=s("div",{class:"text-caption text-grey-7"},"Productor",-1)),s("div",Ge,i(r.datosProductor.productor),1)]),r.datosProductor.runsa?(c(),p("div",Re,[e[6]||(e[6]=s("div",{class:"text-caption text-grey-7"},"RUNSA",-1)),s("div",Be,i(r.datosProductor.runsa),1)])):h("",!0),r.datosProductor.municipio?(c(),p("div",Ke,[e[7]||(e[7]=s("div",{class:"text-caption text-grey-7"},"Municipio",-1)),s("div",Le,i(r.datosProductor.municipio),1)])):h("",!0),r.datosProductor.organizacion?(c(),p("div",je,[e[8]||(e[8]=s("div",{class:"text-caption text-grey-7"},"Organización",-1)),s("div",Ye,i(r.datosProductor.organizacion),1)])):h("",!0)])]),_:1})):h("",!0),t(q,{flat:"",bordered:""},{default:a(()=>[t(b,{class:"q-pa-none"},{default:a(()=>[t(O,{dense:"",flat:""},{default:a(()=>[e[9]||(e[9]=s("thead",null,[s("tr",{class:"bg-primary text-white"},[s("th",{class:"text-left",style:{width:"30%"}},"Mes"),s("th",{class:"text-right",style:{width:"25%"}},"Cantidad (kg)"),s("th",{class:"text-right",style:{width:"20%"}},"N° Entregas"),s("th",{class:"text-right",style:{width:"25%"}},"Promedio/Entrega")])],-1)),s("tbody",null,[(c(!0),p(M,null,z(r.meses,l=>(c(),p("tr",{key:l.offset_mes,class:W({"bg-grey-2":l.num_entregas===0})},[s("td",Je,[s("span",He,i(l.mes_nombre),1),l.anio_mes?(c(),p("span",We,i(l.anio_mes),1)):h("",!0)]),s("td",Ze,[s("span",{class:W({"text-weight-bold":l.num_entregas>0})},i(n.formatNumber(l.cantidad_kg)),3)]),s("td",Xe,[l.num_entregas>0?(c(),g(P,{key:0,dense:"",size:"sm",color:"blue-2","text-color":"blue-9"},{default:a(()=>[f(i(l.num_entregas),1)]),_:2},1024)):(c(),p("span",$e,"-"))]),s("td",eo,[l.num_entregas>0?(c(),p("span",oo,i(n.formatNumber(l.cantidad_kg/l.num_entregas)),1)):(c(),p("span",to,"-"))])],2))),128)),s("tr",so,[s("td",ro," Total Gestión "+i(r.gestionSeleccionada),1),s("td",ao,i(n.formatNumber(r.totalKg)),1),s("td",lo,[t(P,{dense:"",color:"primary","text-color":"white"},{default:a(()=>[f(i(r.totalEntregas),1)]),_:1})]),s("td",io,i(n.formatNumber(r.promedioEntrega)),1)])])]),_:1})]),_:1}),!r.loading&&r.meses.length===0?(c(),g(b,{key:0,class:"text-center q-pa-lg"},{default:a(()=>[t(k,{name:"info_outline",size:"48px",color:"grey-5"}),e[10]||(e[10]=s("div",{class:"text-subtitle2 text-grey-6 q-mt-sm"}," Sin acopios registrados para esta gestión ",-1)),s("div",no," Período: "+i(r.gestionSeleccionada)+"-07-01 a "+i(r.gestionSeleccionada+1)+"-06-30 ",1)]),_:1})):h("",!0),t(Ie,{showing:r.loading},{default:a(()=>[t(Qe,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),n.datosDisponibles&&!r.loading?(c(),g(q,{key:1,flat:"",bordered:"",class:"q-mt-md"},{default:a(()=>[t(b,null,{default:a(()=>[s("div",co,[t(k,{name:"bar_chart",color:"primary",class:"q-mr-xs"}),f(" Gráfica de Acopios Mensuales - Gestión "+i(r.gestionSeleccionada),1)]),s("canvas",uo,null,512)]),_:1})]),_:1})):h("",!0)]),_:1})}const ee=G(Me,[["render",mo],["__scopeId","data-v-c470f742"]]),po={name:"ProductorAcopios",components:{PlagasFormulario:ge,LimpiezasFormulario:pe,MedicamentosFormulario:me,ProductorAcopiosGestion:ee},props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm(),acopioCosechas:[],tab:"detalle",formulariosDialog:{open:!1,cosecha:null,tab:"plagas"}}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},computed:{totals(){let o=0,e=0;return this.acopioCosechas.forEach(u=>{const m=parseFloat(u.cantidad_kg||0),r=parseFloat(u.precio_compra||0);o+=m,e+=m*r}),{totalKg:o,totalMonto:e}},monthlyAggregates(){const o={};return this.acopioCosechas.forEach(e=>{if(!e.fecha_cosecha)return;const u=j(e.fecha_cosecha);if(!u.isValid())return;const m=u.format("YYYY-MM"),r=u.format("MMM YYYY"),n=parseFloat(e.cantidad_kg||0),l=parseFloat(e.precio_compra||0),C=n*l;o[m]||(o[m]={key:m,label:r,totalKg:0,totalMonto:0}),o[m].totalKg+=n,o[m].totalMonto+=C}),Object.values(o).sort((e,u)=>e.key.localeCompare(u.key))},monthlyChartOptions(){return{chart:{id:"acopios-mensuales",toolbar:{show:!1}},xaxis:{categories:this.monthlyAggregates.map(o=>o.label)},dataLabels:{enabled:!0,enabledOnSeries:[0]},stroke:{width:[0,3]},yaxis:[{title:{text:"Kg"}},{opposite:!0,title:{text:"Bs"}}],legend:{position:"top"},tooltip:{shared:!0,intersect:!1}}},monthlyChartSeries(){const o=this.monthlyAggregates.map(u=>u.totalKg),e=this.monthlyAggregates.map(u=>u.totalMonto);return[{name:"Kg",type:"column",data:o},{name:"Monto (Bs)",type:"line",data:e}]}},methods:{async fetchAcopio(){if(this.productor?.id){this.loading=!0;try{const{data:o}=await this.$axios.post("/productorAcopios",{productor_id:this.productor.id});this.acopioCosechas=o}catch(o){console.log(o),this.$alert?.error?.(o.response?.data?.message||"No se pudo cargar las cosechas")}finally{this.loading=!1}}},hydrateFromProductor(){this.fetchAcopio()},async fetchRunsas(){if(this.productor?.id){this.loading=!0;try{const{data:o}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});this.list=Array.isArray(o)?o:o?.data||[]}catch(o){console.log(o),this.list=[],this.$alert?.error?.(o.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(o){return o==="VIGENTE"?"green":o==="VENCIDO"?"red":o==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(o){this.form={id:o.id,productor_id:this.productor?.id||o.productor_id,codigo:o.codigo||null,subcodigo:o.subcodigo||"",fecha_registro:o.fecha_registro||null,fecha_vencimiento:o.fecha_vencimiento||null,estado:o.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const o={...this.form,productor_id:this.productor.id};o.id?await this.$axios.put(`runsas/${o.id}`,o):await this.$axios.post("runsas",o),this.$alert?.success?.(o.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(o){this.$alert?.error?.(o.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(o){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${o.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo eliminar")}})},async openFormulariosDialog(o){try{const{data:e}=await this.$axios.get(`/acopio-cosechas/${o.id}`);this.formulariosDialog.cosecha=e,this.formulariosDialog.tab="plagas",this.formulariosDialog.open=!0}catch{this.formulariosDialog.cosecha=o,this.formulariosDialog.tab="plagas",this.formulariosDialog.open=!0}}}},go={class:"row items-center q-gutter-sm q-mb-sm"},ho={class:"text-subtitle1"},fo={key:0},bo={class:"text-center"},_o={key:1,class:"text-center q-pa-md"},yo={key:0},xo={class:"q-mt-md"},vo={key:1,class:"text-center q-pa-md"},Co={class:"text-h6"},ko={class:"col-12 col-sm-4"},Po={class:"col-12 col-sm-8"},Vo={class:"col-6 col-sm-3"},wo={class:"col-6 col-sm-3"},Eo={class:"col-12 col-sm-3"},No={class:"col-12 text-right q-gutter-sm q-mt-sm"},So={class:"row q-col-gutter-sm"},Do={class:"col-12 col-md-3"},Ao={class:"text-body1"},qo={class:"col-12 col-md-3"},Fo={class:"text-body1"},Uo={class:"col-12 col-md-2"},Qo={class:"text-body1"},Io={class:"col-12 col-md-2"},Mo={class:"text-body1"},zo={class:"col-12 col-md-2"};function Oo(o,e,u,m,r,n){const l=x("apexchart"),C=x("ProductorAcopiosGestion"),w=x("PlagasFormulario"),F=x("LimpiezasFormulario"),A=x("MedicamentosFormulario");return c(),g(b,null,{default:a(()=>[s("div",go,[s("div",ho,[e[11]||(e[11]=f(" Acopios proveedor ")),u.productor?(c(),p("span",fo," — "+i(u.productor.nombre_completo||u.productor.nombre+" "+u.productor.apellidos),1)):h("",!0)]),t(D),t(P,{color:"primary","text-color":"white",dense:""},{default:a(()=>[f(" Total Kg: "+i(n.totals.totalKg.toFixed(2)),1)]),_:1}),t(P,{color:"amber-7","text-color":"black",dense:""},{default:a(()=>[f(" Total compra: "+i(n.totals.totalMonto.toFixed(2))+" Bs ",1)]),_:1}),t(P,{color:"grey-8","text-color":"white",dense:""},{default:a(()=>[f(" Nº cosechas: "+i(r.acopioCosechas.length),1)]),_:1})]),t(B,{modelValue:r.tab,"onUpdate:modelValue":e[0]||(e[0]=d=>r.tab=d),dense:"",align:"left","active-color":"primary","indicator-color":"primary",class:"text-primary q-mb-sm"},{default:a(()=>[t(v,{name:"detalle",label:"Detalle",icon:"table_view"}),t(v,{name:"resumen",label:"Proyección mensual",icon:"analytics"}),t(v,{name:"gestion",label:"Gestión anual",icon:"event_note"})]),_:1},8,["modelValue"]),t(E,{class:"q-mb-md"}),t(K,{modelValue:r.tab,"onUpdate:modelValue":e[1]||(e[1]=d=>r.tab=d),animated:""},{default:a(()=>[t(_,{name:"detalle"},{default:a(()=>[r.acopioCosechas.length>0?(c(),g(O,{key:0,dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[e[13]||(e[13]=s("thead",null,[s("tr",{class:"bg-primary text-white"},[s("th",null,"Fecha Cosecha"),s("th",null,"Productor"),s("th",null,"Cantidad (kg)"),s("th",null,"Humedad (%)"),s("th",null,"Temperatura Almacenaje (°C)"),s("th",null,"Número Acta"),s("th",null,"Condiciones Almacenaje"),s("th",null,"Estado"),s("th",{style:{width:"120px"}},"Formularios de CONTROL")])],-1)),s("tbody",null,[(c(!0),p(M,null,z(r.acopioCosechas,d=>(c(),p("tr",{key:d.id},[s("td",null,i(d.fecha_cosecha),1),s("td",null,i(d.apiario?.productor.nombre)+" "+i(d.apiario?.productor.apellidos),1),s("td",null,i(Number(d.cantidad_kg).toFixed(2)),1),s("td",null,i(d.humedad),1),s("td",null,i(d.temperatura_almacenaje),1),s("td",null,i(d.num_acta),1),s("td",null,i(d.condiciones_almacenaje),1),s("td",null,[t(P,{color:d.estado==="BUENO"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:a(()=>[f(i(d.estado.replace("_"," ")),1)]),_:2},1032,["color"])]),s("td",bo,[t(y,{flat:"",dense:"",color:"primary",icon:"description",size:"sm",onClick:Y=>n.openFormulariosDialog(d)},{default:a(()=>[t(L,null,{default:a(()=>e[12]||(e[12]=[f("Ver Formularios de Control del SENASAG")])),_:1})]),_:2},1032,["onClick"])])]))),128))])]),_:1})):(c(),p("div",_o,[t(k,{name:"info",size:"48px",color:"grey-5"}),e[14]||(e[14]=s("div",{class:"text-subtitle2 text-grey-5"},"No se encontraron cosechas.",-1))]))]),_:1}),t(_,{name:"resumen"},{default:a(()=>[n.monthlyAggregates.length?(c(),p("div",yo,[t(O,{dense:"",flat:"",bordered:"",class:"q-mb-md"},{default:a(()=>[e[15]||(e[15]=s("thead",null,[s("tr",{class:"bg-primary text-white"},[s("th",null,"Mes"),s("th",null,"Total Kg"),s("th",null,"Total compra (Bs)")])],-1)),s("tbody",null,[(c(!0),p(M,null,z(n.monthlyAggregates,d=>(c(),p("tr",{key:d.key},[s("td",null,i(d.label),1),s("td",null,i(d.totalKg.toFixed(2)),1),s("td",null,i(d.totalMonto.toFixed(2)),1)]))),128))])]),_:1}),s("div",xo,[t(l,{type:"line",height:"320",options:n.monthlyChartOptions,series:n.monthlyChartSeries},null,8,["options","series"])])])):(c(),p("div",vo,[t(k,{name:"insert_chart_outlined",size:"48px",color:"grey-5"}),e[16]||(e[16]=s("div",{class:"text-subtitle2 text-grey-5"}," Aún no hay datos suficientes para el resumen mensual. ",-1))]))]),_:1}),t(_,{name:"gestion"},{default:a(()=>[u.productor?(c(),g(C,{key:0,productor:u.productor},null,8,["productor"])):h("",!0)]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:r.dlg.open,"onUpdate:modelValue":e[7]||(e[7]=d=>r.dlg.open=d),persistent:""},{default:a(()=>[t(q,{style:{"min-width":"720px","max-width":"95vw"}},{default:a(()=>[t(b,{class:"row items-center q-gutter-sm"},{default:a(()=>[s("div",Co,i(r.form.id?"Editar runsa":"Nueva runsa"),1),t(D),N(t(y,{flat:"",round:"",dense:"",icon:"close"},null,512),[[S]])]),_:1}),t(E),t(b,null,{default:a(()=>[t($,{onSubmit:n.submit,class:"row q-col-gutter-sm"},{default:a(()=>[s("div",ko,[t(V,{modelValue:r.form.codigo,"onUpdate:modelValue":e[2]||(e[2]=d=>r.form.codigo=d),dense:"",outlined:"",label:"Codigo",rules:[d=>!!d||"Requerido"]},null,8,["modelValue","rules"])]),s("div",Po,[t(V,{modelValue:r.form.subcodigo,"onUpdate:modelValue":e[3]||(e[3]=d=>r.form.subcodigo=d),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),s("div",Vo,[t(V,{modelValue:r.form.fecha_registro,"onUpdate:modelValue":e[4]||(e[4]=d=>r.form.fecha_registro=d),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),s("div",wo,[t(V,{modelValue:r.form.fecha_vencimiento,"onUpdate:modelValue":e[5]||(e[5]=d=>r.form.fecha_vencimiento=d),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),s("div",Eo,[t(T,{modelValue:r.form.estado,"onUpdate:modelValue":e[6]||(e[6]=d=>r.form.estado=d),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),s("div",No,[N(t(y,{flat:"",color:"grey",label:"Cancelar",disable:r.saving},null,8,["disable"]),[[S]]),t(y,{color:"primary",label:r.form.id?"Guardar cambios":"Crear",type:"submit",loading:r.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:r.formulariosDialog.open,"onUpdate:modelValue":e[10]||(e[10]=d=>r.formulariosDialog.open=d),persistent:""},{default:a(()=>[t(q,{style:{width:"90vw","max-width":"1400px","max-height":"90vh"}},{default:a(()=>[t(b,{class:"row items-center q-pa-md bg-primary text-white"},{default:a(()=>[t(k,{name:"description",size:"sm",class:"q-mr-sm"}),e[17]||(e[17]=s("div",{class:"text-h6"},"Formularios de Control",-1)),t(D),N(t(y,{flat:"",round:"",dense:"",icon:"close",color:"white"},null,512),[[S]])]),_:1}),t(E),t(b,{class:"q-pa-md bg-grey-2"},{default:a(()=>[s("div",So,[s("div",Do,[e[18]||(e[18]=s("div",{class:"text-caption text-grey-7"},"Fecha Cosecha",-1)),s("div",Ao,i(r.formulariosDialog.cosecha?.fecha_cosecha||"—"),1)]),s("div",qo,[e[19]||(e[19]=s("div",{class:"text-caption text-grey-7"},"Productor",-1)),s("div",Fo,i(r.formulariosDialog.cosecha?.apiario?.productor.nombre)+" "+i(r.formulariosDialog.cosecha?.apiario?.productor.apellidos),1)]),s("div",Uo,[e[20]||(e[20]=s("div",{class:"text-caption text-grey-7"},"Cantidad",-1)),s("div",Qo,i(r.formulariosDialog.cosecha?.cantidad_kg)+" kg",1)]),s("div",Io,[e[21]||(e[21]=s("div",{class:"text-caption text-grey-7"},"Numero Acta",-1)),s("div",Mo,i(r.formulariosDialog.cosecha?.num_acta||"0"),1)]),s("div",zo,[e[22]||(e[22]=s("div",{class:"text-caption text-grey-7"},"Estado",-1)),t(P,{color:r.formulariosDialog.cosecha?.estado==="BUENO"?"green":"red","text-color":"white",dense:""},{default:a(()=>[f(i(r.formulariosDialog.cosecha?.estado),1)]),_:1},8,["color"])])])]),_:1}),t(E),t(b,{class:"q-pa-md"},{default:a(()=>[t(B,{modelValue:r.formulariosDialog.tab,"onUpdate:modelValue":e[8]||(e[8]=d=>r.formulariosDialog.tab=d),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"left"},{default:a(()=>[t(v,{name:"plagas",icon:"bug_report",label:"Plagas","no-caps":""}),t(v,{name:"limpiezas",icon:"cleaning_services",label:"Limpiezas","no-caps":""}),t(v,{name:"medicamentos",icon:"medication",label:"Medicamentos","no-caps":""})]),_:1},8,["modelValue"]),t(E),t(K,{modelValue:r.formulariosDialog.tab,"onUpdate:modelValue":e[9]||(e[9]=d=>r.formulariosDialog.tab=d),animated:"",style:{"max-height":"60vh","overflow-y":"auto"}},{default:a(()=>[t(_,{name:"plagas"},{default:a(()=>[r.formulariosDialog.cosecha?(c(),g(w,{key:0,cosecha:r.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1}),t(_,{name:"limpiezas"},{default:a(()=>[r.formulariosDialog.cosecha?(c(),g(F,{key:0,cosecha:r.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1}),t(_,{name:"medicamentos"},{default:a(()=>[r.formulariosDialog.cosecha?(c(),g(A,{key:0,cosecha:r.formulariosDialog.cosecha},null,8,["cosecha"])):h("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const To=G(po,[["render",Oo]]),Go={name:"ProductorShow",components:{ProductorAcopios:To,ProductorMapa:be,ProductorApiarios:fe,ProductorCertificaciones:he,ProductorForm:ue,ProductorRunsa:Fe,ProductorAcopiosGestion:ee},data(){return{tab:"general",loading:!1,productor:null}},mounted(){this.fetchProductor()},methods:{async fetchProductor(){this.loading=!0;try{const o=this.$route.params.id,{data:e}=await this.$axios.get(`productores/${o}`);this.productor=e}catch(o){this.productor=null,this.$alert?.error?.(o.response?.data?.message||"No se pudo cargar el productor")}finally{this.loading=!1}},onSaved(o){this.productor=o,this.$alert?.success?.("Cambios guardados")}}},Ro={class:"row items-center q-gutter-sm q-mb-md"};function Bo(o,e,u,m,r,n){const l=x("ProductorForm"),C=x("ProductorCertificaciones"),w=x("ProductorRunsa"),F=x("ProductorApiarios"),A=x("ProductorMapa"),d=x("ProductorAcopiosGestion"),Y=x("ProductorAcopios");return c(),g(ce,{class:"q-pa-md"},{default:a(()=>[s("div",Ro,[t(y,{flat:"",round:"",icon:"arrow_back",onClick:e[0]||(e[0]=U=>o.$router.push("/productores"))}),e[4]||(e[4]=s("div",{class:"text-h6"},"Editar Productor",-1)),t(D),t(y,{flat:"",round:"",icon:"refresh",loading:r.loading,onClick:n.fetchProductor},null,8,["loading","onClick"])]),t(q,{flat:"",bordered:""},{default:a(()=>[t(B,{modelValue:r.tab,"onUpdate:modelValue":e[1]||(e[1]=U=>r.tab=U),class:"text-primary",align:"left",dense:""},{default:a(()=>[t(v,{name:"general",icon:"badge",label:"1) Información general","no-caps":""}),t(v,{name:"runsa",icon:"assured_workload",label:"2) Runsa","no-caps":""}),t(v,{name:"certs",icon:"verified",label:"3) Certificaciones","no-caps":""}),t(v,{name:"apiarios",icon:"hive",label:"4) Apiarios","no-caps":""}),t(v,{name:"mapa",icon:"map",label:"5) Mapa","no-caps":""}),t(v,{name:"acopio",icon:"send",label:"6) Manejo de Apiario","no-caps":""})]),_:1},8,["modelValue"]),t(E),t(K,{modelValue:r.tab,"onUpdate:modelValue":e[3]||(e[3]=U=>r.tab=U),animated:""},{default:a(()=>[t(_,{name:"general",class:"q-pa-none"},{default:a(()=>[!r.loading&&r.productor?(c(),g(b,{key:0},{default:a(()=>[t(l,{productor:r.productor,"banner-msg":"Actualiza los datos y guarda los cambios",onSaved:n.onSaved,onCancel:e[2]||(e[2]=U=>o.$router.back())},null,8,["productor","onSaved"])]),_:1})):h("",!0)]),_:1}),t(_,{name:"certs",class:"q-pa-none"},{default:a(()=>[t(C,{productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(_,{name:"runsa",class:"q-pa-none"},{default:a(()=>[t(w,{productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(_,{name:"apiarios",class:"q-pa-none"},{default:a(()=>[t(F,{productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(_,{name:"mapa",class:"q-pa-none"},{default:a(()=>[t(A,{productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),t(_,{name:"acopios",class:"q-pa-none"},{default:a(()=>[!r.loading&&r.productor?(c(),g(d,{key:0,productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])):h("",!0)]),_:1}),t(_,{name:"acopio",class:"q-pa-none"},{default:a(()=>[t(Y,{productor:r.productor,onUpdated:n.fetchProductor},null,8,["productor","onUpdated"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}const pt=G(Go,[["render",Bo]]);export{pt as default};
