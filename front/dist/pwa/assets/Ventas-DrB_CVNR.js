import{Q as q}from"./QSpace-H8dxUSgz.js";import{_ as A,c as f,o as c,w as a,a as l,Q,e as v,b as n,af as w,d as g,f as m,O as E,a8 as d,t as s,a9 as h,P as b,ad as V,h as I,aa as D,ab as U,ac as B,ah as O}from"./index-FiRxq5PK.js";import{Q as k,b as u}from"./format-DcXfN4c_.js";import{Q as S}from"./QList-BYR_FHbT.js";import{Q as T}from"./QBtnDropdown-DncA2P0f.js";import{Q as p}from"./QTd-o_npuJkC.js";import{Q as N}from"./QBadge-DEBj-7sB.js";import{Q as Y}from"./QTable-D3XUJWOX.js";import{Q as F}from"./QMarkupTable-BZZhU-Bw.js";import{Q as M}from"./QPage-B80xAG9B.js";import{C as y}from"./ClosePopup-D5ltvDTP.js";import{h as L}from"./moment-C5S46NFB.js";import"./selection-BhVSMPD1.js";import"./QSelect-Bvaewxtt.js";import"./use-fullscreen-DmWxVEAC.js";const P={name:"VentasList",data(){return{inicio:L().format("YYYY-MM-DD"),fin:L().format("YYYY-MM-DD"),loading:!1,rows:[],filter:"",columns:[{name:"actions",label:"Acciones",align:"right"},{name:"id",label:"#",align:"left",field:"id"},{name:"fecha_venta",label:"Fecha",align:"left",field:"fecha_venta"},{name:"cliente",label:"Cliente",align:"left",field:"cliente"},{name:"num_factura",label:"Factura",align:"left",field:"num_factura"},{name:"estado",label:"Estado",align:"left",field:"estado"},{name:"guia_remision",label:"Guía",align:"left",field:"guia_remision"},{name:"precio_total",label:"Total (Bs)",align:"right",field:"precio_total"}],dlg:{open:!1,row:null,detalles:[]}}},mounted(){this.fetch()},methods:{generarExcel(){if(!this.inicio||!this.fin||this.inicio>this.fin){this.$q.notify({type:"negative",message:"Seleccione el rango de fechas"});return}const i={inicio:this.inicio,fin:this.fin,q:this.filter};this.loading=!0,this.$axios.post("ventaExcel",i,{responseType:"blob"}).then(e=>{const x=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),_=window.URL.createObjectURL(x),o=document.createElement("a");o.href=_,o.setAttribute("download","ventas.xlsx"),document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(_)}).catch(e=>{this.$alert?.error?.(e.response?.data?.message||"No se pudo generar el reporte.")}).finally(()=>{this.loading=!1})},fmt(i){return Number(i||0).toFixed(2)},fmtDate(i){return i?new Date(i).toLocaleString():"-"},async fetch(){if(!this.inicio||!this.fin||this.inicio>this.fin){this.$q.notify({type:"negative",message:"Seleccione el rango de fechas"});return}this.loading=!0;try{const i={inicio:this.inicio,fin:this.fin};this.filter&&(i.q=this.filter);const{data:e}=await this.$axios.get("/ventas",{params:i});this.rows=Array.isArray(e)?e:e.data||[],console.log(e)}catch(i){this.$q.notify({type:"negative",message:i.response?.data?.message||"Error al listar ventas"})}finally{this.loading=!1}},fetchDebounced:(()=>{let i;return function(){clearTimeout(i),i=setTimeout(()=>this.fetch(),350)}})(),async anularVenta(i){this.$q.dialog({title:"Confirmar",message:`¿Está seguro de anular la venta N° ${i.num_factura||i.id}?`,cancel:!0,ok:{label:"Sí, anular",color:"negative"},cancel:{label:"Cancelar",flat:!0}}).onOk(async()=>{try{await this.$axios.post("/anularVenta",i),this.$q.notify({type:"positive",message:"Venta anulada"}),this.fetch()}catch(e){this.$q.notify({type:"negative",message:e.response?.data?.message||"Error al anular venta"})}})},async openDetalle(i){try{const{data:e}=await this.$axios.get(`/ventas/${i.id}`);this.dlg={open:!0,row:e,detalles:e.detalles||[]}}catch{this.$q.notify({type:"negative",message:"No se pudo cargar el detalle"})}},printVenta(i){const e=`${this.$url}/ventas/${i.id}/nota`;window.open(e,"_blank")}}},R={class:"q-mb-sm"},j={class:"q-mb-sm"},z={class:"text-right"},G={class:"text-right"},K={class:"text-right"},X={class:"text-right text-bold"};function H(i,e,x,_,o,r){return c(),f(M,{class:"q-pa-md"},{default:a(()=>[l(Q,{flat:"",bordered:""},{default:a(()=>[l(v,{class:"row items-center q-gutter-sm"},{default:a(()=>[e[6]||(e[6]=n("div",{class:"text-h6"},"Gestionar Ventas",-1)),l(q),l(w,{modelValue:o.inicio,"onUpdate:modelValue":[e[0]||(e[0]=t=>o.inicio=t),r.fetch],type:"date",label:"Fecha inicio",dense:"",outlined:""},null,8,["modelValue","onUpdate:modelValue"]),l(w,{modelValue:o.fin,"onUpdate:modelValue":[e[1]||(e[1]=t=>o.fin=t),r.fetch],type:"date",label:"Fecha fin",dense:"",outlined:""},null,8,["modelValue","onUpdate:modelValue"]),l(w,{modelValue:o.filter,"onUpdate:modelValue":[e[2]||(e[2]=t=>o.filter=t),r.fetchDebounced],dense:"",outlined:"",placeholder:"Buscar cliente / factura / guía"},{append:a(()=>[l(g,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),l(m,{color:"positive",icon:"add_circle_outline",label:"Crear venta","no-caps":"",onClick:e[3]||(e[3]=t=>i.$router.push("/ventas/crear"))}),l(m,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:o.loading,onClick:r.fetch},null,8,["loading","onClick"]),l(m,{color:"green",label:"EXCEL",onClick:r.generarExcel,loading:o.loading},null,8,["onClick","loading"])]),_:1}),l(E),l(Y,{flat:"",bordered:"",dense:"","wrap-cells":"",rows:o.rows,columns:o.columns,"row-key":"id",loading:o.loading,"rows-per-page-options":[0]},{"body-cell-actions":a(t=>[l(p,{props:t,class:"text-right"},{default:a(()=>[t.row.estado=="VALIDO"?(c(),f(T,{key:0,dense:"",label:"Opciones",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[l(S,null,{default:a(()=>[t.row.estado=="VALIDO"?b((c(),f(k,{key:0,clickable:"",onClick:C=>r.openDetalle(t.row)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(g,{name:"visibility"})]),_:1}),l(u,null,{default:a(()=>e[7]||(e[7]=[d("Ver detalle")])),_:1})]),_:2},1032,["onClick"])),[[V],[y]]):h("",!0),t.row.estado=="VALIDO"?b((c(),f(k,{key:1,clickable:"",onClick:C=>r.printVenta(t.row)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(g,{name:"print",color:"primary"})]),_:1}),l(u,null,{default:a(()=>e[8]||(e[8]=[d("Imprimir nota")])),_:1})]),_:2},1032,["onClick"])),[[V],[y]]):h("",!0),t.row.estado=="VALIDO"?b((c(),f(k,{key:2,clickable:"",onClick:C=>r.anularVenta(t.row)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(g,{name:"delete",color:"red"})]),_:1}),l(u,null,{default:a(()=>e[9]||(e[9]=[d("Anular Venta")])),_:1})]),_:2},1032,["onClick"])),[[V],[y]]):h("",!0)]),_:2},1024)]),_:2},1024)):h("",!0)]),_:2},1032,["props"])]),"body-cell-cliente":a(t=>[l(p,{props:t},{default:a(()=>[d(s(t.row.cliente?.nombre_cliente||"-"),1)]),_:2},1032,["props"])]),"body-cell-estado":a(t=>[l(p,{props:t},{default:a(()=>[l(N,{color:t.row.estado=="VALIDO"?"positive":"negative",label:t.row.estado},null,8,["color","label"])]),_:2},1032,["props"])]),"body-cell-fecha_venta":a(t=>[l(p,{props:t},{default:a(()=>[d(s(r.fmtDate(t.row.fecha_venta)),1)]),_:2},1032,["props"])]),"body-cell-precio_total":a(t=>[l(p,{props:t,class:"text-right"},{default:a(()=>[d(s(r.fmt(t.row.precio_total)),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading"])]),_:1}),l(I,{modelValue:o.dlg.open,"onUpdate:modelValue":e[5]||(e[5]=t=>o.dlg.open=t)},{default:a(()=>[l(Q,{style:{"min-width":"640px"}},{default:a(()=>[l(v,{class:"text-h6"},{default:a(()=>[d("Detalle de Venta #"+s(o.dlg.row?.id),1)]),_:1}),l(v,{class:"q-pt-none"},{default:a(()=>[n("div",R,[e[10]||(e[10]=n("b",null,"Cliente:",-1)),d(" "+s(o.dlg.row?.cliente?.nombre_cliente),1)]),n("div",j,[e[11]||(e[11]=n("b",null,"Fecha:",-1)),d(" "+s(r.fmtDate(o.dlg.row?.fecha_venta)),1)]),l(F,{dense:"",flat:"",bordered:""},{default:a(()=>[e[13]||(e[13]=n("thead",null,[n("tr",null,[n("th",null,"Lote"),n("th",null,"Producto"),n("th",{class:"text-right"},"Kg"),n("th",{class:"text-right"},"Precio"),n("th",{class:"text-right"},"Subtotal")])],-1)),n("tbody",null,[(c(!0),D(U,null,B(o.dlg.detalles,t=>(c(),D("tr",{key:t.id},[n("td",null,s(t.lote?.codigo_lote),1),n("td",null,s(t.producto?.nombre_producto),1),n("td",z,s(r.fmt(t.cantidad_salida)),1),n("td",G,s(r.fmt(t.precio_venta)),1),n("td",K,s(r.fmt(t.cantidad_salida*t.precio_venta)),1)]))),128)),n("tr",null,[e[12]||(e[12]=n("td",{colspan:"4",class:"text-right text-bold"},"Total",-1)),n("td",X,s(r.fmt(o.dlg.row?.precio_total)),1)])])]),_:1})]),_:1}),l(O,{align:"right"},{default:a(()=>[b(l(m,{flat:"",label:"Cerrar"},null,512),[[y]]),l(m,{color:"primary",icon:"print",label:"Imprimir",onClick:e[4]||(e[4]=t=>r.printVenta(o.dlg.row))})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ue=A(P,[["render",H]]);export{ue as default};
