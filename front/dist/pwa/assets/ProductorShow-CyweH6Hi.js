import{_ as R,c as g,o as u,w as a,b as o,a as s,f as b,aa as p,a9 as f,ab as I,ac as F,t as d,P as V,d as x,a8 as h,ad as z,h as Y,Q as q,e as _,O as D,af as k,v as J,aA as ee,aB as te,j as A,aC as oe,G as se,J as re,g as ae,aD as le,x as B,T as ie,aE as ne,az as K,a7 as v}from"./index-DvQRbYdx.js";import{Q as E}from"./QSpace-BLs6PdjP.js";import{Q as H,a as C,b as W,c as y}from"./QTabPanels-BEasxnsn.js";import{Q as de}from"./QPage-eoD7WsNn.js";import{P as ce}from"./ProductorForm-BuLlFf6W.js";import{P as ue,a as me,b as pe}from"./ProductorMapa-BB35V9vL.js";import{Q as j,b as Q,d as P}from"./format-DTV63Uot.js";import{Q as ge}from"./QList-PNNeLjHB.js";import{Q as he}from"./QBtnDropdown-Ci85NyV2.js";import{Q as M}from"./QMarkupTable-XBewXmeY.js";import{Q as T}from"./QSelect-CgPg1UVN.js";import{Q as Z}from"./QForm-CZspFZy7.js";import{C as w}from"./ClosePopup-CXPaKg_f.js";import{Q as L}from"./QTooltip-Btcl4k0M.js";import{Q as fe}from"./QBanner-4stCb5Dm.js";import{C as be}from"./auto-DHENdVy-.js";import{h as G}from"./moment-C5S46NFB.js";import"./QResizeObserver-DhfrBveg.js";import"./use-panel-WoCkbZWG.js";import"./touch-BjYP5sR0.js";import"./selection-BginukLO.js";import"./marker-shadow-B2Jp6WuD.js";import"./QBadge-Bh9hGEzs.js";const _e={name:"ProductorRunsas",props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm()}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},methods:{hydrateFromProductor(){this.productor?.runsas?this.list=this.productor.runsas:this.fetchRunsas()},async fetchRunsas(){console.log(this.productor),this.loading=!0;try{const{data:e}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});console.log(e),this.list=Array.isArray(e)?e:e?.data||[]}catch(e){console.log(e),this.list=[],this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(e){return e==="VIGENTE"?"green":e==="VENCIDO"?"red":e==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(e){this.form={id:e.id,productor_id:this.productor?.id||e.productor_id,codigo:e.codigo||null,subcodigo:e.subcodigo||"",fecha_registro:e.fecha_registro||null,fecha_vencimiento:e.fecha_vencimiento||null,estado:e.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const e={...this.form,productor_id:this.productor.id};e.id?await this.$axios.put(`runsas/${e.id}`,e):await this.$axios.post("runsas",e),this.$alert?.success?.(e.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(e){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${e.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(t){this.$alert?.error?.(t.response?.data?.message||"No se pudo eliminar")}})}}},ye={class:"row items-center q-gutter-sm q-mb-sm"},xe={key:0},ve={class:"text-h6"},Ce={class:"col-12 col-sm-4"},ke={class:"col-12 col-sm-8"},Pe={class:"col-6 col-sm-3"},Ve={class:"col-6 col-sm-3"},we={class:"col-12 col-sm-3"},Ee={class:"col-12 text-right q-gutter-sm q-mt-sm"};function Ne(e,t,c,m,r,i){return u(),g(_,null,{default:a(()=>[o("div",ye,[t[6]||(t[6]=o("div",{class:"text-subtitle1"},"Certificaciones Runsa",-1)),s(E),s(b,{dense:"",color:"primary",icon:"add_circle",label:"Nueva",onClick:i.startCreate,disable:r.saving,"no-caps":""},null,8,["onClick","disable"])]),s(M,{dense:""},{default:a(()=>[t[10]||(t[10]=o("thead",null,[o("tr",{class:"bg-grey-3"},[o("th",{class:"text-left"},"#"),o("th",{class:"text-left",style:{width:"120px"}},"Opciones"),o("th",{class:"text-left"},"Codigo"),o("th",{class:"text-left"},"Subcodigo"),o("th",{class:"text-left"},"Registro"),o("th",{class:"text-left"},"Vencimiento"),o("th",{class:"text-left"},"Estado")])],-1)),o("tbody",null,[(u(!0),p(I,null,F(r.list||[],(l,n)=>(u(),p("tr",{key:l.id||n},[o("td",null,d(n+1),1),o("td",null,[s(he,{dense:"",label:"Opciones",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[s(ge,null,{default:a(()=>[V((u(),g(j,{clickable:"",onClick:N=>i.startEdit(l)},{default:a(()=>[s(Q,{avatar:""},{default:a(()=>[s(x,{name:"edit"})]),_:1}),s(Q,null,{default:a(()=>t[7]||(t[7]=[h("Editar")])),_:1})]),_:2},1032,["onClick"])),[[z],[w]]),V((u(),g(j,{clickable:"",onClick:N=>i.remove(l)},{default:a(()=>[s(Q,{avatar:""},{default:a(()=>[s(x,{name:"delete",class:"text-negative"})]),_:1}),s(Q,{class:"text-negative"},{default:a(()=>t[8]||(t[8]=[h("Eliminar")])),_:1})]),_:2},1032,["onClick"])),[[z],[w]])]),_:2},1024)]),_:2},1024)]),o("td",null,d(l.codigo||"-"),1),o("td",null,d(l.subcodigo||"-"),1),o("td",null,d(l.fecha_registro||"-"),1),o("td",null,d(l.fecha_vencimiento||"-"),1),o("td",null,[s(P,{color:i.chip(l.estado),"text-color":"white",size:"xs",class:"text-bold"},{default:a(()=>[h(d(l.estado),1)]),_:2},1032,["color"])])]))),128)),!r.loading&&(c.productor?.runsas?.length||0)===0?(u(),p("tr",xe,t[9]||(t[9]=[o("td",{colspan:"8",class:"text-center text-grey"},"Sin registros",-1)]))):f("",!0)])]),_:1}),s(Y,{modelValue:r.dlg.open,"onUpdate:modelValue":t[5]||(t[5]=l=>r.dlg.open=l),persistent:""},{default:a(()=>[s(q,{style:{"min-width":"720px","max-width":"95vw"}},{default:a(()=>[s(_,{class:"row items-center q-gutter-sm"},{default:a(()=>[o("div",ve,d(r.form.id?"Editar runsa":"Nueva runsa"),1),s(E),V(s(b,{flat:"",round:"",dense:"",icon:"close"},null,512),[[w]])]),_:1}),s(D),s(_,null,{default:a(()=>[s(Z,{onSubmit:i.submit,class:"row q-col-gutter-sm"},{default:a(()=>[o("div",Ce,[s(k,{modelValue:r.form.codigo,"onUpdate:modelValue":t[0]||(t[0]=l=>r.form.codigo=l),dense:"",outlined:"",label:"Codigo",rules:[l=>!!l||"Requerido"]},null,8,["modelValue","rules"])]),o("div",ke,[s(k,{modelValue:r.form.subcodigo,"onUpdate:modelValue":t[1]||(t[1]=l=>r.form.subcodigo=l),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),o("div",Pe,[s(k,{modelValue:r.form.fecha_registro,"onUpdate:modelValue":t[2]||(t[2]=l=>r.form.fecha_registro=l),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),o("div",Ve,[s(k,{modelValue:r.form.fecha_vencimiento,"onUpdate:modelValue":t[3]||(t[3]=l=>r.form.fecha_vencimiento=l),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),o("div",we,[s(T,{modelValue:r.form.estado,"onUpdate:modelValue":t[4]||(t[4]=l=>r.form.estado=l),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),o("div",Ee,[V(s(b,{flat:"",color:"grey",label:"Cancelar",disable:r.saving},null,8,["disable"]),[[w]]),s(b,{color:"primary",label:r.form.id?"Guardar cambios":"Crear",type:"submit",loading:r.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Se=R(_e,[["render",Ne]]),Ae='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>',qe=J({name:"QSpinnerDots",props:ee,setup(e){const{cSize:t,classes:c}=te(e);return()=>A("svg",{class:c.value,fill:"currentColor",width:t.value,height:t.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:Ae})}}),Ue=J({name:"QInnerLoading",props:{...se,...oe,showing:Boolean,color:String,size:{type:[String,Number],default:"42px"},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(e,{slots:t}){const c=ae(),m=re(e,c.proxy.$q),{transitionProps:r,transitionStyle:i}=le(e),l=B(()=>"q-inner-loading q--avoid-card-border absolute-full column flex-center"+(m.value===!0?" q-inner-loading--dark":"")),n=B(()=>"q-inner-loading__label"+(e.labelClass!==void 0?` ${e.labelClass}`:""));function N(){const U=[A(ne,{size:e.size,color:e.color})];return e.label!==void 0&&U.push(A("div",{class:n.value,style:e.labelStyle},[e.label])),U}function O(){return e.showing===!0?A("div",{class:l.value,style:i.value},t.default!==void 0?t.default():N()):null}return()=>A(ie,r.value,O)}}),Qe={name:"ProductorAcopiosGestion",props:{productor:{type:Object,required:!0}},data(){return{loading:!1,loadingProductos:!1,loadingExcel:!1,gestionSeleccionada:G().year(),productoSeleccionado:1,gestiones:[],productos:[],datosProductor:null,meses:[],totalKg:0,totalEntregas:0,promedioEntrega:0,chartInstance:null}},computed:{datosDisponibles(){return this.meses.length>0&&this.totalKg>0}},mounted(){this.generarGestiones(),this.cargarProductos(),this.cargarAcopios()},beforeUnmount(){this.chartInstance&&this.chartInstance.destroy()},methods:{generarGestiones(){const e=G().year(),t=[];for(let c=e;c>=2020;c--)t.push(c);this.gestiones=t},async cargarProductos(){this.loadingProductos=!0;try{const{data:e}=await this.$axios.get("/productos/tipo/1");this.productos=e?.data||e||[],this.productos.length===0&&this.$alert?.warning?.("No se encontraron productos tipo miel")}catch(e){console.error("Error cargando productos:",e),this.$alert?.error?.("No se pudieron cargar los productos"),this.productos=[]}finally{this.loadingProductos=!1}},async cargarAcopios(){if(!this.productor?.id){console.error("No hay productor seleccionado");return}this.loading=!0;try{const{data:e}=await this.$axios.get(`/productores/${this.productor.id}/acopios-gestion`,{params:{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado}});this.datosProductor={productor:e.productor,runsa:e.runsa,municipio:e.municipio,organizacion:e.organizacion},this.meses=e.meses||[],this.totalKg=Number(e.total_kg||0),this.totalEntregas=Number(e.total_entregas||0),this.promedioEntrega=Number(e.promedio_entrega||0),this.$nextTick(()=>{this.renderChart()})}catch(e){console.error("Error cargando acopios:",e),this.$alert?.error?.(e.response?.data?.message||"Error al cargar acopios por gestión"),this.meses=[],this.totalKg=0,this.totalEntregas=0,this.promedioEntrega=0}finally{this.loading=!1}},renderChart(){if(!this.$refs.chartCanvas){console.warn("Canvas no está disponible");return}this.chartInstance&&this.chartInstance.destroy();const e=this.meses.map(m=>m.mes_nombre),t=this.meses.map(m=>Number(m.cantidad_kg)),c=this.meses.map(m=>Number(m.num_entregas));this.chartInstance=new be(this.$refs.chartCanvas,{type:"bar",data:{labels:e,datasets:[{label:"Cantidad (kg)",data:t,backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,yAxisID:"y"},{label:"N° Entregas",data:c,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:1,type:"line",yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"},title:{display:!0,text:`Acopios Gestión ${this.gestionSeleccionada} (Julio-Junio)`},tooltip:{callbacks:{footer:m=>{const r=m[0].dataIndex,i=this.meses[r];return i&&i.num_entregas>0?`Promedio/entrega: ${(i.cantidad_kg/i.num_entregas).toFixed(2)} kg`:""}}}},scales:{y:{type:"linear",position:"left",beginAtZero:!0,title:{display:!0,text:"Kilogramos (kg)"}},y1:{type:"linear",position:"right",beginAtZero:!0,title:{display:!0,text:"Número de entregas"},grid:{drawOnChartArea:!1}}}}})},formatNumber(e){const t=Number(e);return isNaN(t)?"0.00":t.toFixed(2)},async exportarExcel(){if(!this.datosDisponibles){this.$alert?.warning?.("No hay datos para exportar");return}this.loadingExcel=!0;try{const e=await this.$axios.post(`/productores/${this.productor.id}/acopios-gestion-excel`,{gestion:this.gestionSeleccionada,producto_id:this.productoSeleccionado},{responseType:"blob"}),t=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=window.URL.createObjectURL(t),m=document.createElement("a");m.href=c;const r=this.datosProductor?.productor?.replace(/\s+/g,"_")||"productor";m.setAttribute("download",`acopios_${r}_${this.gestionSeleccionada}.xlsx`),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(c),this.$alert?.success?.("Archivo Excel descargado correctamente")}catch(e){console.error("Error exportando a Excel:",e),this.$alert?.error?.(e.response?.data?.message||"No se pudo generar el archivo Excel")}finally{this.loadingExcel=!1}}}},Ie={class:"row items-center q-gutter-sm q-mb-md"},Fe={class:"row q-col-gutter-md"},De={class:"col-auto"},Me={class:"text-weight-medium"},Te={key:0,class:"col-auto"},Re={class:"text-weight-medium"},Oe={key:1,class:"col-auto"},Ge={class:"text-weight-medium"},ze={key:2,class:"col-auto"},Be={class:"text-weight-medium"},Ke={class:"text-left"},je={class:"text-weight-medium"},Le={key:0,class:"text-caption text-grey-7 q-ml-xs"},Ye={class:"text-right"},Je={class:"text-right"},He={key:1,class:"text-grey-5"},We={class:"text-right"},Ze={key:0,class:"text-grey-8"},Xe={key:1,class:"text-grey-5"},$e={class:"bg-grey-3 text-weight-bold"},et={class:"text-left text-uppercase"},tt={class:"text-right text-primary"},ot={class:"text-right"},st={class:"text-right text-grey-8"},rt={class:"text-caption text-grey-5"},at={class:"text-subtitle2 q-mb-md"},lt={ref:"chartCanvas",height:"100"};function it(e,t,c,m,r,i){return u(),g(_,null,{default:a(()=>[o("div",Ie,[t[4]||(t[4]=o("div",{class:"text-subtitle1 text-weight-medium"},"Acopios por Gestión (Julio-Junio)",-1)),s(E),s(T,{modelValue:r.gestionSeleccionada,"onUpdate:modelValue":[t[0]||(t[0]=l=>r.gestionSeleccionada=l),i.cargarAcopios],options:r.gestiones,label:"Gestión",dense:"",outlined:"",style:{"min-width":"130px"},loading:r.loading},{prepend:a(()=>[s(x,{name:"event"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),s(T,{modelValue:r.productoSeleccionado,"onUpdate:modelValue":[t[1]||(t[1]=l=>r.productoSeleccionado=l),i.cargarAcopios],options:r.productos,"option-label":"nombre_producto","option-value":"id","emit-value":"","map-options":"",label:"Producto",dense:"",outlined:"",style:{"min-width":"200px"},loading:r.loadingProductos},{prepend:a(()=>[s(x,{name:"inventory"})]),_:1},8,["modelValue","options","onUpdate:modelValue","loading"]),s(b,{color:"green",icon:"download",label:"Excel",dense:"","no-caps":"",onClick:i.exportarExcel,loading:r.loadingExcel,disable:!i.datosDisponibles},{default:a(()=>[i.datosDisponibles?f("",!0):(u(),g(L,{key:0},{default:a(()=>t[2]||(t[2]=[h(" No hay datos para exportar ")])),_:1}))]),_:1},8,["onClick","loading","disable"]),s(b,{color:"primary",icon:"refresh",dense:"",round:"",flat:"",onClick:i.cargarAcopios,loading:r.loading},{default:a(()=>[s(L,null,{default:a(()=>t[3]||(t[3]=[h("Recargar datos")])),_:1})]),_:1},8,["onClick","loading"])]),r.datosProductor?(u(),g(fe,{key:0,dense:"",class:"bg-blue-1 q-mb-md",rounded:""},{avatar:a(()=>[s(x,{name:"person",color:"primary"})]),default:a(()=>[o("div",Fe,[o("div",De,[t[5]||(t[5]=o("div",{class:"text-caption text-grey-7"},"Productor",-1)),o("div",Me,d(r.datosProductor.productor),1)]),r.datosProductor.runsa?(u(),p("div",Te,[t[6]||(t[6]=o("div",{class:"text-caption text-grey-7"},"RUNSA",-1)),o("div",Re,d(r.datosProductor.runsa),1)])):f("",!0),r.datosProductor.municipio?(u(),p("div",Oe,[t[7]||(t[7]=o("div",{class:"text-caption text-grey-7"},"Municipio",-1)),o("div",Ge,d(r.datosProductor.municipio),1)])):f("",!0),r.datosProductor.organizacion?(u(),p("div",ze,[t[8]||(t[8]=o("div",{class:"text-caption text-grey-7"},"Organización",-1)),o("div",Be,d(r.datosProductor.organizacion),1)])):f("",!0)])]),_:1})):f("",!0),s(q,{flat:"",bordered:""},{default:a(()=>[s(_,{class:"q-pa-none"},{default:a(()=>[s(M,{dense:"",flat:""},{default:a(()=>[t[9]||(t[9]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",{class:"text-left",style:{width:"30%"}},"Mes"),o("th",{class:"text-right",style:{width:"25%"}},"Cantidad (kg)"),o("th",{class:"text-right",style:{width:"20%"}},"N° Entregas"),o("th",{class:"text-right",style:{width:"25%"}},"Promedio/Entrega")])],-1)),o("tbody",null,[(u(!0),p(I,null,F(r.meses,l=>(u(),p("tr",{key:l.offset_mes,class:K({"bg-grey-2":l.num_entregas===0})},[o("td",Ke,[o("span",je,d(l.mes_nombre),1),l.anio_mes?(u(),p("span",Le,d(l.anio_mes),1)):f("",!0)]),o("td",Ye,[o("span",{class:K({"text-weight-bold":l.num_entregas>0})},d(i.formatNumber(l.cantidad_kg)),3)]),o("td",Je,[l.num_entregas>0?(u(),g(P,{key:0,dense:"",size:"sm",color:"blue-2","text-color":"blue-9"},{default:a(()=>[h(d(l.num_entregas),1)]),_:2},1024)):(u(),p("span",He,"-"))]),o("td",We,[l.num_entregas>0?(u(),p("span",Ze,d(i.formatNumber(l.cantidad_kg/l.num_entregas)),1)):(u(),p("span",Xe,"-"))])],2))),128)),o("tr",$e,[o("td",et," Total Gestión "+d(r.gestionSeleccionada),1),o("td",tt,d(i.formatNumber(r.totalKg)),1),o("td",ot,[s(P,{dense:"",color:"primary","text-color":"white"},{default:a(()=>[h(d(r.totalEntregas),1)]),_:1})]),o("td",st,d(i.formatNumber(r.promedioEntrega)),1)])])]),_:1})]),_:1}),!r.loading&&r.meses.length===0?(u(),g(_,{key:0,class:"text-center q-pa-lg"},{default:a(()=>[s(x,{name:"info_outline",size:"48px",color:"grey-5"}),t[10]||(t[10]=o("div",{class:"text-subtitle2 text-grey-6 q-mt-sm"}," Sin acopios registrados para esta gestión ",-1)),o("div",rt," Período: "+d(r.gestionSeleccionada)+"-07-01 a "+d(r.gestionSeleccionada+1)+"-06-30 ",1)]),_:1})):f("",!0),s(Ue,{showing:r.loading},{default:a(()=>[s(qe,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),i.datosDisponibles&&!r.loading?(u(),g(q,{key:1,flat:"",bordered:"",class:"q-mt-md"},{default:a(()=>[s(_,null,{default:a(()=>[o("div",at,[s(x,{name:"bar_chart",color:"primary",class:"q-mr-xs"}),h(" Gráfica de Acopios Mensuales - Gestión "+d(r.gestionSeleccionada),1)]),o("canvas",lt,null,512)]),_:1})]),_:1})):f("",!0)]),_:1})}const nt=R(Qe,[["render",it],["__scopeId","data-v-c470f742"]]),dt={name:"ProductorAcopios",props:{productor:{type:Object,required:!0}},emits:["updated"],data(){return{loading:!1,saving:!1,list:[],dlg:{open:!1},form:this.emptyForm(),acopioCosechas:[],tab:"detalle"}},mounted(){this.hydrateFromProductor()},watch:{productor(){this.hydrateFromProductor()}},computed:{totals(){let e=0,t=0;return this.acopioCosechas.forEach(c=>{const m=parseFloat(c.cantidad_kg||0),r=parseFloat(c.precio_compra||0);e+=m,t+=m*r}),{totalKg:e,totalMonto:t}},monthlyAggregates(){const e={};return this.acopioCosechas.forEach(t=>{if(!t.fecha_cosecha)return;const c=G(t.fecha_cosecha);if(!c.isValid())return;const m=c.format("YYYY-MM"),r=c.format("MMM YYYY"),i=parseFloat(t.cantidad_kg||0),l=parseFloat(t.precio_compra||0),n=i*l;e[m]||(e[m]={key:m,label:r,totalKg:0,totalMonto:0}),e[m].totalKg+=i,e[m].totalMonto+=n}),Object.values(e).sort((t,c)=>t.key.localeCompare(c.key))},monthlyChartOptions(){return{chart:{id:"acopios-mensuales",toolbar:{show:!1}},xaxis:{categories:this.monthlyAggregates.map(e=>e.label)},dataLabels:{enabled:!0,enabledOnSeries:[0]},stroke:{width:[0,3]},yaxis:[{title:{text:"Kg"}},{opposite:!0,title:{text:"Bs"}}],legend:{position:"top"},tooltip:{shared:!0,intersect:!1}}},monthlyChartSeries(){const e=this.monthlyAggregates.map(c=>c.totalKg),t=this.monthlyAggregates.map(c=>c.totalMonto);return[{name:"Kg",type:"column",data:e},{name:"Monto (Bs)",type:"line",data:t}]}},methods:{async fetchAcopio(){if(this.productor?.id){this.loading=!0;try{const{data:e}=await this.$axios.post("/productorAcopios",{productor_id:this.productor.id});this.acopioCosechas=e}catch(e){console.log(e),this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar las cosechas")}finally{this.loading=!1}}},hydrateFromProductor(){this.fetchAcopio()},async fetchRunsas(){if(this.productor?.id){this.loading=!0;try{const{data:e}=await this.$axios.get("runsas",{params:{productor_id:this.productor.id,paginate:!1}});this.list=Array.isArray(e)?e:e?.data||[]}catch(e){console.log(e),this.list=[],this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar runsas")}finally{this.loading=!1}}},emptyForm(){return{id:null,productor_id:this.productor?.id||null,codigo:null,subcodigo:"",fecha_registro:null,fecha_vencimiento:null,estado:"VIGENTE"}},chip(e){return e==="VIGENTE"?"green":e==="VENCIDO"?"red":e==="SUSPENDIDO"?"orange":"grey"},startCreate(){this.form=this.emptyForm(),this.form.productor_id=this.productor?.id||null,this.dlg.open=!0},startEdit(e){this.form={id:e.id,productor_id:this.productor?.id||e.productor_id,codigo:e.codigo||null,subcodigo:e.subcodigo||"",fecha_registro:e.fecha_registro||null,fecha_vencimiento:e.fecha_vencimiento||null,estado:e.estado||"VIGENTE"},this.dlg.open=!0},async submit(){if(this.productor?.id){this.saving=!0;try{const e={...this.form,productor_id:this.productor.id};e.id?await this.$axios.put(`runsas/${e.id}`,e):await this.$axios.post("runsas",e),this.$alert?.success?.(e.id?"Runsa actualizada":"Runsa creada"),this.dlg.open=!1,this.$emit("updated")}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo guardar")}finally{this.saving=!1}}},remove(e){this.$alert?.dialog?.("¿Eliminar runsa?")?.onOk(async()=>{try{await this.$axios.delete(`runsas/${e.id}`),this.$alert?.success?.("Eliminado"),this.$emit("updated")}catch(t){this.$alert?.error?.(t.response?.data?.message||"No se pudo eliminar")}})}}},ct={class:"row items-center q-gutter-sm q-mb-sm"},ut={class:"text-subtitle1"},mt={key:0},pt={key:1,class:"text-center q-pa-md"},gt={key:0},ht={class:"q-mt-md"},ft={key:1,class:"text-center q-pa-md"},bt={class:"text-h6"},_t={class:"col-12 col-sm-4"},yt={class:"col-12 col-sm-8"},xt={class:"col-6 col-sm-3"},vt={class:"col-6 col-sm-3"},Ct={class:"col-12 col-sm-3"},kt={class:"col-12 text-right q-gutter-sm q-mt-sm"};function Pt(e,t,c,m,r,i){const l=v("apexchart");return u(),g(_,null,{default:a(()=>[o("div",ct,[o("div",ut,[t[8]||(t[8]=h(" Acopios proveedor ")),c.productor?(u(),p("span",mt," — "+d(c.productor.nombre_completo||c.productor.nombre+" "+c.productor.apellidos),1)):f("",!0)]),s(E),s(P,{color:"primary","text-color":"white",dense:""},{default:a(()=>[h(" Total Kg: "+d(i.totals.totalKg.toFixed(2)),1)]),_:1}),s(P,{color:"amber-7","text-color":"black",dense:""},{default:a(()=>[h(" Total compra: "+d(i.totals.totalMonto.toFixed(2))+" Bs ",1)]),_:1}),s(P,{color:"grey-8","text-color":"white",dense:""},{default:a(()=>[h(" Nº cosechas: "+d(r.acopioCosechas.length),1)]),_:1})]),s(H,{modelValue:r.tab,"onUpdate:modelValue":t[0]||(t[0]=n=>r.tab=n),dense:"",align:"left","active-color":"primary","indicator-color":"primary",class:"text-primary q-mb-sm"},{default:a(()=>[s(C,{name:"detalle",label:"Detalle",icon:"table_view"}),s(C,{name:"resumen",label:"Resumen mensual",icon:"analytics"})]),_:1},8,["modelValue"]),s(D,{class:"q-mb-md"}),s(W,{modelValue:r.tab,"onUpdate:modelValue":t[1]||(t[1]=n=>r.tab=n),animated:""},{default:a(()=>[s(y,{name:"detalle"},{default:a(()=>[r.acopioCosechas.length>0?(u(),g(M,{key:0,dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[9]||(t[9]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Fecha Cosecha"),o("th",null,"Productor"),o("th",null,"Cantidad (kg)"),o("th",null,"Humedad (%)"),o("th",null,"Temperatura Almacenaje (°C)"),o("th",null,"Número Acta"),o("th",null,"Condiciones Almacenaje"),o("th",null,"Estado")])],-1)),o("tbody",null,[(u(!0),p(I,null,F(r.acopioCosechas,n=>(u(),p("tr",{key:n.id},[o("td",null,d(n.fecha_cosecha),1),o("td",null,d(n.apiario?.productor.nombre)+" "+d(n.apiario?.productor.apellidos),1),o("td",null,d(Number(n.cantidad_kg).toFixed(2)),1),o("td",null,d(n.humedad),1),o("td",null,d(n.temperatura_almacenaje),1),o("td",null,d(n.num_acta),1),o("td",null,d(n.condiciones_almacenaje),1),o("td",null,[s(P,{color:n.estado==="BUENO"?"green":"red","text-color":"white",dense:"",size:"10px"},{default:a(()=>[h(d(n.estado.replace("_"," ")),1)]),_:2},1032,["color"])])]))),128))])]),_:1})):(u(),p("div",pt,[s(x,{name:"info",size:"48px",color:"grey-5"}),t[10]||(t[10]=o("div",{class:"text-subtitle2 text-grey-5"},"No se encontraron cosechas.",-1))]))]),_:1}),s(y,{name:"resumen"},{default:a(()=>[i.monthlyAggregates.length?(u(),p("div",gt,[s(M,{dense:"",flat:"",bordered:"",class:"q-mb-md"},{default:a(()=>[t[11]||(t[11]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Mes"),o("th",null,"Total Kg"),o("th",null,"Total compra (Bs)")])],-1)),o("tbody",null,[(u(!0),p(I,null,F(i.monthlyAggregates,n=>(u(),p("tr",{key:n.key},[o("td",null,d(n.label),1),o("td",null,d(n.totalKg.toFixed(2)),1),o("td",null,d(n.totalMonto.toFixed(2)),1)]))),128))])]),_:1}),o("div",ht,[s(l,{type:"line",height:"320",options:i.monthlyChartOptions,series:i.monthlyChartSeries},null,8,["options","series"])])])):(u(),p("div",ft,[s(x,{name:"insert_chart_outlined",size:"48px",color:"grey-5"}),t[12]||(t[12]=o("div",{class:"text-subtitle2 text-grey-5"}," Aún no hay datos suficientes para el resumen mensual. ",-1))]))]),_:1})]),_:1},8,["modelValue"]),s(Y,{modelValue:r.dlg.open,"onUpdate:modelValue":t[7]||(t[7]=n=>r.dlg.open=n),persistent:""},{default:a(()=>[s(q,{style:{"min-width":"720px","max-width":"95vw"}},{default:a(()=>[s(_,{class:"row items-center q-gutter-sm"},{default:a(()=>[o("div",bt,d(r.form.id?"Editar runsa":"Nueva runsa"),1),s(E),V(s(b,{flat:"",round:"",dense:"",icon:"close"},null,512),[[w]])]),_:1}),s(D),s(_,null,{default:a(()=>[s(Z,{onSubmit:i.submit,class:"row q-col-gutter-sm"},{default:a(()=>[o("div",_t,[s(k,{modelValue:r.form.codigo,"onUpdate:modelValue":t[2]||(t[2]=n=>r.form.codigo=n),dense:"",outlined:"",label:"Codigo",rules:[n=>!!n||"Requerido"]},null,8,["modelValue","rules"])]),o("div",yt,[s(k,{modelValue:r.form.subcodigo,"onUpdate:modelValue":t[3]||(t[3]=n=>r.form.subcodigo=n),dense:"",outlined:"",label:"Subcodigo"},null,8,["modelValue"])]),o("div",xt,[s(k,{modelValue:r.form.fecha_registro,"onUpdate:modelValue":t[4]||(t[4]=n=>r.form.fecha_registro=n),type:"date",dense:"",outlined:"",label:"Fec Registro"},null,8,["modelValue"])]),o("div",vt,[s(k,{modelValue:r.form.fecha_vencimiento,"onUpdate:modelValue":t[5]||(t[5]=n=>r.form.fecha_vencimiento=n),type:"date",dense:"",outlined:"",label:"Fec Vencimiento"},null,8,["modelValue"])]),o("div",Ct,[s(T,{modelValue:r.form.estado,"onUpdate:modelValue":t[6]||(t[6]=n=>r.form.estado=n),options:["VIGENTE","VENCIDO","SUSPENDIDO"],dense:"",outlined:"",label:"Estado"},null,8,["modelValue"])]),o("div",kt,[V(s(b,{flat:"",color:"grey",label:"Cancelar",disable:r.saving},null,8,["disable"]),[[w]]),s(b,{color:"primary",label:r.form.id?"Guardar cambios":"Crear",type:"submit",loading:r.saving},null,8,["label","loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Vt=R(dt,[["render",Pt]]),wt={name:"ProductorShow",components:{ProductorAcopios:Vt,ProductorMapa:pe,ProductorApiarios:me,ProductorCertificaciones:ue,ProductorForm:ce,ProductorRunsa:Se,ProductorAcopiosGestion:nt},data(){return{tab:"general",loading:!1,productor:null}},mounted(){this.fetchProductor()},methods:{async fetchProductor(){this.loading=!0;try{const e=this.$route.params.id,{data:t}=await this.$axios.get(`productores/${e}`);this.productor=t}catch(e){this.productor=null,this.$alert?.error?.(e.response?.data?.message||"No se pudo cargar el productor")}finally{this.loading=!1}},onSaved(e){this.productor=e,this.$alert?.success?.("Cambios guardados")}}},Et={class:"row items-center q-gutter-sm q-mb-md"};function Nt(e,t,c,m,r,i){const l=v("ProductorForm"),n=v("ProductorCertificaciones"),N=v("ProductorRunsa"),O=v("ProductorApiarios"),U=v("ProductorMapa"),X=v("ProductorAcopiosGestion"),$=v("ProductorAcopios");return u(),g(de,{class:"q-pa-md"},{default:a(()=>[o("div",Et,[s(b,{flat:"",round:"",icon:"arrow_back",onClick:t[0]||(t[0]=S=>e.$router.push("/productores"))}),t[4]||(t[4]=o("div",{class:"text-h6"},"Editar Productor",-1)),s(E),s(b,{flat:"",round:"",icon:"refresh",loading:r.loading,onClick:i.fetchProductor},null,8,["loading","onClick"])]),s(q,{flat:"",bordered:""},{default:a(()=>[s(H,{modelValue:r.tab,"onUpdate:modelValue":t[1]||(t[1]=S=>r.tab=S),class:"text-primary",align:"left",dense:""},{default:a(()=>[s(C,{name:"general",icon:"badge",label:"1) Información general","no-caps":""}),s(C,{name:"runsa",icon:"assured_workload",label:"2) Runsa","no-caps":""}),s(C,{name:"certs",icon:"verified",label:"3) Certificaciones","no-caps":""}),s(C,{name:"apiarios",icon:"hive",label:"4) Apiarios","no-caps":""}),s(C,{name:"mapa",icon:"map",label:"5) Mapa","no-caps":""}),s(C,{name:"acopio",icon:"send",label:"6) Acopio","no-caps":""})]),_:1},8,["modelValue"]),s(D),s(W,{modelValue:r.tab,"onUpdate:modelValue":t[3]||(t[3]=S=>r.tab=S),animated:""},{default:a(()=>[s(y,{name:"general",class:"q-pa-none"},{default:a(()=>[!r.loading&&r.productor?(u(),g(_,{key:0},{default:a(()=>[s(l,{productor:r.productor,"banner-msg":"Actualiza los datos y guarda los cambios",onSaved:i.onSaved,onCancel:t[2]||(t[2]=S=>e.$router.back())},null,8,["productor","onSaved"])]),_:1})):f("",!0)]),_:1}),s(y,{name:"certs",class:"q-pa-none"},{default:a(()=>[s(n,{productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),s(y,{name:"runsa",class:"q-pa-none"},{default:a(()=>[s(N,{productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),s(y,{name:"apiarios",class:"q-pa-none"},{default:a(()=>[s(O,{productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),s(y,{name:"mapa",class:"q-pa-none"},{default:a(()=>[s(U,{productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])]),_:1}),s(y,{name:"acopios",class:"q-pa-none"},{default:a(()=>[!r.loading&&r.productor?(u(),g(X,{key:0,productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])):f("",!0)]),_:1}),s(y,{name:"acopio",class:"q-pa-none"},{default:a(()=>[s($,{productor:r.productor,onUpdated:i.fetchProductor},null,8,["productor","onUpdated"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}const Xt=R(wt,[["render",Nt]]);export{Xt as default};
