import{Q as q}from"./QSpace-CwyDY8FC.js";import{_ as U,c as g,o as c,w as a,a as t,Q as x,e as h,b as o,ad as b,d as _,f,I as L,a5 as d,t as s,J as w,aa as V,h as B,a7 as Q,a8 as S,a9 as T,af as E}from"./index-CiPbvvVd.js";import{Q as k,b as u}from"./format-5DSNLnxW.js";import{Q as Y,a as F}from"./QList-WECI87zz.js";import{Q as I,a as m}from"./QTable-CeVVcnoA.js";import{Q as A}from"./QMarkupTable-D7gWwu1A.js";import{Q as N}from"./QPage-CZBL3KZI.js";import{C as y}from"./ClosePopup-Cc4cFxUW.js";import{h as C}from"./moment-C5S46NFB.js";import"./selection-ByqNC2rw.js";import"./QSelect-DdPr3yLF.js";import"./use-fullscreen-uVwlm4Pz.js";const M={name:"VentasList",data(){return{inicio:C().format("YYYY-MM-DD"),fin:C().format("YYYY-MM-DD"),loading:!1,rows:[],filter:"",columns:[{name:"actions",label:"Acciones",align:"right"},{name:"id",label:"#",align:"left",field:"id"},{name:"fecha_venta",label:"Fecha",align:"left",field:"fecha_venta"},{name:"cliente",label:"Cliente",align:"left",field:"cliente"},{name:"num_factura",label:"Factura",align:"left",field:"num_factura"},{name:"guia_remision",label:"Guía",align:"left",field:"guia_remision"},{name:"precio_total",label:"Total (Bs)",align:"right",field:"precio_total"}],dlg:{open:!1,row:null,detalles:[]}}},mounted(){this.fetch()},methods:{generarExcel(){if(!this.inicio||!this.fin||this.inicio>this.fin){this.$q.notify({type:"negative",message:"Seleccione el rango de fechas"});return}const n={inicio:this.inicio,fin:this.fin,q:this.filter};this.loading=!0,this.$axios.post("ventaExcel",n,{responseType:"blob"}).then(e=>{const v=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),p=window.URL.createObjectURL(v),i=document.createElement("a");i.href=p,i.setAttribute("download","ventas.xlsx"),document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(p)}).catch(e=>{this.$alert?.error?.(e.response?.data?.message||"No se pudo generar el reporte.")}).finally(()=>{this.loading=!1})},fmt(n){return Number(n||0).toFixed(2)},fmtDate(n){return n?new Date(n).toLocaleString():"-"},async fetch(){if(!this.inicio||!this.fin||this.inicio>this.fin){this.$q.notify({type:"negative",message:"Seleccione el rango de fechas"});return}this.loading=!0;try{const n={inicio:this.inicio,fin:this.fin};this.filter&&(n.q=this.filter);const{data:e}=await this.$axios.get("/ventas",{params:n});this.rows=Array.isArray(e)?e:e.data||[],console.log(e)}catch(n){this.$q.notify({type:"negative",message:n.response?.data?.message||"Error al listar ventas"})}finally{this.loading=!1}},fetchDebounced:(()=>{let n;return function(){clearTimeout(n),n=setTimeout(()=>this.fetch(),350)}})(),async openDetalle(n){try{const{data:e}=await this.$axios.get(`/ventas/${n.id}`);this.dlg={open:!0,row:e,detalles:e.detalles||[]}}catch{this.$q.notify({type:"negative",message:"No se pudo cargar el detalle"})}},printVenta(n){const e=`${this.$url}/ventas/${n.id}/nota`;window.open(e,"_blank")}}},R={class:"q-mb-sm"},P={class:"q-mb-sm"},O={class:"text-right"},j={class:"text-right"},z={class:"text-right"},G={class:"text-right text-bold"};function J(n,e,v,p,i,r){return c(),g(N,{class:"q-pa-md"},{default:a(()=>[t(x,{flat:"",bordered:""},{default:a(()=>[t(h,{class:"row items-center q-gutter-sm"},{default:a(()=>[e[6]||(e[6]=o("div",{class:"text-h6"},"Gestionar Ventas",-1)),t(q),t(b,{modelValue:i.inicio,"onUpdate:modelValue":[e[0]||(e[0]=l=>i.inicio=l),r.fetch],type:"date",label:"Fecha inicio",dense:"",outlined:""},null,8,["modelValue","onUpdate:modelValue"]),t(b,{modelValue:i.fin,"onUpdate:modelValue":[e[1]||(e[1]=l=>i.fin=l),r.fetch],type:"date",label:"Fecha fin",dense:"",outlined:""},null,8,["modelValue","onUpdate:modelValue"]),t(b,{modelValue:i.filter,"onUpdate:modelValue":[e[2]||(e[2]=l=>i.filter=l),r.fetchDebounced],dense:"",outlined:"",placeholder:"Buscar cliente / factura / guía"},{append:a(()=>[t(_,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),t(f,{color:"positive",icon:"add_circle_outline",label:"Crear venta","no-caps":"",onClick:e[3]||(e[3]=l=>n.$router.push("/ventas/crear"))}),t(f,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:i.loading,onClick:r.fetch},null,8,["loading","onClick"]),t(f,{color:"green",label:"EXCEL",onClick:r.generarExcel,loading:i.loading},null,8,["onClick","loading"])]),_:1}),t(L),t(I,{flat:"",bordered:"",dense:"","wrap-cells":"",rows:i.rows,columns:i.columns,"row-key":"id",loading:i.loading,"rows-per-page-options":[0]},{"body-cell-actions":a(l=>[t(m,{props:l,class:"text-right"},{default:a(()=>[t(Y,{dense:"",label:"Opciones",color:"primary","no-caps":"",size:"10px"},{default:a(()=>[t(F,null,{default:a(()=>[w((c(),g(k,{clickable:"",onClick:D=>r.openDetalle(l.row)},{default:a(()=>[t(u,{avatar:""},{default:a(()=>[t(_,{name:"visibility"})]),_:1}),t(u,null,{default:a(()=>e[7]||(e[7]=[d("Ver detalle")])),_:1})]),_:2},1032,["onClick"])),[[V],[y]]),w((c(),g(k,{clickable:"",onClick:D=>r.printVenta(l.row)},{default:a(()=>[t(u,{avatar:""},{default:a(()=>[t(_,{name:"print",color:"primary"})]),_:1}),t(u,null,{default:a(()=>e[8]||(e[8]=[d("Imprimir nota")])),_:1})]),_:2},1032,["onClick"])),[[V],[y]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-cliente":a(l=>[t(m,{props:l},{default:a(()=>[d(s(l.row.cliente?.nombre_cliente||"-"),1)]),_:2},1032,["props"])]),"body-cell-fecha_venta":a(l=>[t(m,{props:l},{default:a(()=>[d(s(r.fmtDate(l.row.fecha_venta)),1)]),_:2},1032,["props"])]),"body-cell-precio_total":a(l=>[t(m,{props:l,class:"text-right"},{default:a(()=>[d(s(r.fmt(l.row.precio_total)),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading"])]),_:1}),t(B,{modelValue:i.dlg.open,"onUpdate:modelValue":e[5]||(e[5]=l=>i.dlg.open=l)},{default:a(()=>[t(x,{style:{"min-width":"640px"}},{default:a(()=>[t(h,{class:"text-h6"},{default:a(()=>[d("Detalle de Venta #"+s(i.dlg.row?.id),1)]),_:1}),t(h,{class:"q-pt-none"},{default:a(()=>[o("div",R,[e[9]||(e[9]=o("b",null,"Cliente:",-1)),d(" "+s(i.dlg.row?.cliente?.nombre_cliente),1)]),o("div",P,[e[10]||(e[10]=o("b",null,"Fecha:",-1)),d(" "+s(r.fmtDate(i.dlg.row?.fecha_venta)),1)]),t(A,{dense:"",flat:"",bordered:""},{default:a(()=>[e[12]||(e[12]=o("thead",null,[o("tr",null,[o("th",null,"Lote"),o("th",null,"Producto"),o("th",{class:"text-right"},"Kg"),o("th",{class:"text-right"},"Precio"),o("th",{class:"text-right"},"Subtotal")])],-1)),o("tbody",null,[(c(!0),Q(S,null,T(i.dlg.detalles,l=>(c(),Q("tr",{key:l.id},[o("td",null,s(l.lote?.codigo_lote),1),o("td",null,s(l.producto?.nombre_producto),1),o("td",O,s(r.fmt(l.cantidad_salida)),1),o("td",j,s(r.fmt(l.precio_venta)),1),o("td",z,s(r.fmt(l.cantidad_salida*l.precio_venta)),1)]))),128)),o("tr",null,[e[11]||(e[11]=o("td",{colspan:"4",class:"text-right text-bold"},"Total",-1)),o("td",G,s(r.fmt(i.dlg.row?.precio_total)),1)])])]),_:1})]),_:1}),t(E,{align:"right"},{default:a(()=>[w(t(f,{flat:"",label:"Cerrar"},null,512),[[y]]),t(f,{color:"primary",icon:"print",label:"Imprimir",onClick:e[4]||(e[4]=l=>r.printVenta(i.dlg.row))})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ne=U(M,[["render",J]]);export{ne as default};
