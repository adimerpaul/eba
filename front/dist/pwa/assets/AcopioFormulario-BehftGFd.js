import{Q as x}from"./QBadge-CBC2sDxe.js";import{_ as O,c as v,o as c,w as d,a as t,e as y,b as l,a9 as h,t as _,a8 as p,O as A,aF as N,aa as f,af as n,d as V,f as b,Q as k}from"./index-BN7mrdDx.js";import{Q as q,b as w}from"./format-NUIwdYMO.js";import{Q as m}from"./QSelect-BPlie7Fo.js";import{Q as E}from"./QForm-CqYjiPd0.js";import{h as g}from"./moment-C5S46NFB.js";const U={name:"AcopioFormulario",props:{estado:{type:String,required:!0,validator:a=>["crear","editar"].indexOf(a)!==-1},cosecha:{type:Object,default:null}},data(){return{loading:!1,productos:[],productorOptions:[],apiarioOptions:[],loadingProductores:!1,loadingApiarios:!1,form:{fecha_cosecha:g().format("YYYY-MM-DD"),productor_id:null,apiario_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"",observaciones:"",estado:{label:"BUENO",value:"BUENO"}},estados:[{label:"BUENO",value:"BUENO"},{label:"EN PROCESO",value:"EN_PROCESO"},{label:"CANCELADO",value:"CANCELADO"}]}},mounted(){this.productoGet(),this.estado==="editar"&&this.cosecha&&(this.form={fecha_cosecha:this.cosecha.fecha_cosecha||g().format("YYYY-MM-DD"),producto_id:this.cosecha.producto_id||null,cantidad_kg:this.cosecha.cantidad_kg||null,precio_compra:this.cosecha.precio_compra||32,humedad:this.cosecha.humedad||null,temperatura_almacenaje:this.cosecha.temperatura_almacenaje||null,procedencia:this.cosecha.procedencia||"",tipo_envase:this.cosecha.tipo_envase||"",observaciones:this.cosecha.observaciones||"",estado:this.cosecha.estado||"BUENO"},this.form.productor_id=this.cosecha.apiario?.productor_id||null,this.filterProductores("",a=>{this.form.productor_id&&!this.productorOptions.find(e=>e.value===this.form.productor_id)&&this.$axios.get(`/productores/${this.form.productor_id}`).then(({data:e})=>{const s=e,u={value:s.id,label:`${s.nombre??""} ${s.apellidos??""} — ${s.municipio?.nombre_municipio??""}`.trim(),raw:s};this.productorOptions.push(u),this.form.apiario_id=this.cosecha.apiario_id||null,this.loadApiariosByProductor(this.form.productor_id)})}))},computed:{productorDetalle(){return this.form.productor_id&&this.productorOptions.find(a=>a.value===this.form.productor_id)||null},apiarioDetalle(){return this.form.apiario_id&&this.apiarioOptions.find(a=>a.value===this.form.apiario_id)?.raw||null}},watch:{"form.productor_id"(a){this.form.apiario_id=null,this.apiarioOptions=[],a&&this.loadApiariosByProductor(a)}},methods:{async productoGet(){this.$axios.get("/productos/tipo/1").then(({data:a})=>{this.productos=a?.data||a||[]}).catch(()=>{this.$q.notify({type:"negative",message:"No se pudieron cargar los productos"})})},onReset(){this.$refs.formRef.resetValidation(),this.form=Object.assign({},this.form,{fecha_cosecha:g().format("YYYY-MM-DD"),productor_id:null,apiario_id:null,cantidad_kg:null,precio_compra:32,humedad:null,temperatura_almacenaje:null,procedencia:"",tipo_envase:"",observaciones:"",estado:"BUENO"})},filterProductores(a,e,s){if(!a||a.length<2){e(()=>{this.productorOptions=[]});return}e(async()=>{this.loadingProductores=!0;try{const{data:u}=await this.$axios.get("/productores",{params:{search:a,per_page:20}}),i=(u?.data||u||[]).map(r=>({value:r.id,label:`${r.nombre??""} ${r.apellidos??""} — ${r.municipio?.nombre_municipio??""}`.trim(),raw:r}));this.productorOptions=i}catch{this.$q.notify({type:"negative",message:"No se pudo cargar productores"})}finally{this.loadingProductores=!1}})},async loadApiariosByProductor(a){this.loadingApiarios=!0;try{const{data:e}=await this.$axios.get("/apiarios",{params:{productor_id:a,paginate:!1}});this.apiarioOptions=(e||[]).map(s=>({value:s.id,label:s.nombre_cip?`${s.nombre_cip} — ${s?.municipio?.nombre_municipio??""}`:`Apiario #${s.id} — ${s?.municipio?.nombre_municipio??""}`,raw:{municipio:s?.municipio?.nombre_municipio||"—"}}))}catch{this.$q.notify({type:"negative",message:"No se pudieron cargar apiarios"})}finally{this.loadingApiarios=!1}},async onSubmit(){try{if(this.loading=!0,this.estado==="crear"){const{data:a}=await this.$axios.post("/acopio-cosechas",this.form);this.$q.notify({type:"positive",message:"Acopio guardado"}),this.$emit("saved",a),this.$router.push(`/acopio/cosechas/${a.id}`)}else{const{data:a}=await this.$axios.put(`/acopio-cosechas/${this.cosecha.id}`,this.form);this.$q.notify({type:"positive",message:"Acopio actualizado"}),this.$emit("saved",a)}}catch{this.$q.notify({type:"negative",message:"Error al guardar"})}finally{this.loading=!1}}}},B={class:"text-h6"},C={class:"row q-col-gutter-md"},D={class:"col-12 col-md-3"},P={class:"col-12 col-md-9"},Q={key:0,class:"text-caption text-grey-7 q-mt-xs"},S={class:"col-12 col-md-6"},M={key:0,class:"text-caption text-grey-7 q-mt-xs"},Y={class:"col-6 col-md-3"},j={class:"col-6 col-md-3"},R={class:"col-6 col-md-3"},F={class:"col-6 col-md-3"},z={class:"col-6 col-md-3"},I={class:"col-6 col-md-3"},L={class:"col-6 col-md-3"},T={class:"col-12 col-md-6"},G={class:"col-12 col-md-3"},H={key:0,class:"row q-gutter-sm q-mt-md"},J={key:1,class:"row q-gutter-sm q-mt-md"};function K(a,e,s,u,i,r){return c(),v(k,{flat:"",bordered:""},{default:d(()=>[t(y,{class:"row items-center justify-between"},{default:d(()=>[l("div",B,_(s.estado==="crear"?"Nuevo Acopio":"Editar Acopio"),1),s.estado==="crear"?(c(),v(x,{key:0,color:"primary",outline:""},{default:d(()=>e[12]||(e[12]=[p("Nuevo")])),_:1})):h("",!0)]),_:1}),t(A),t(y,null,{default:d(()=>[t(E,{ref:"formRef",onSubmit:N(r.onSubmit,["prevent"])},{default:d(()=>[l("div",C,[l("div",D,[t(n,{modelValue:i.form.fecha_cosecha,"onUpdate:modelValue":e[0]||(e[0]=o=>i.form.fecha_cosecha=o),type:"date",label:"Fecha de Cosecha",dense:"",outlined:"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","rules"])]),l("div",P,[t(m,{modelValue:i.form.productor_id,"onUpdate:modelValue":e[1]||(e[1]=o=>i.form.productor_id=o),options:i.productorOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"","use-input":"","input-debounce":"400",onFilter:r.filterProductores,label:"Productor",dense:"",outlined:"",loading:i.loadingProductores,clearable:"",rules:[o=>!!o||"Seleccione un productor"]},{"no-option":d(()=>[t(q,null,{default:d(()=>[t(w,{class:"text-grey"},{default:d(()=>e[13]||(e[13]=[p("Escriba al menos 2 caracteres…")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","loading","rules"]),r.productorDetalle?(c(),f("div",Q,[t(V,{name:"badge",size:"16px",class:"q-mr-xs"}),p(" "+_(r.productorDetalle?.label),1)])):h("",!0)]),l("div",S,[t(m,{modelValue:i.form.apiario_id,"onUpdate:modelValue":e[2]||(e[2]=o=>i.form.apiario_id=o),options:i.apiarioOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",label:"Apiario",dense:"",outlined:"",loading:i.loadingApiarios,disable:!i.form.productor_id,clearable:"",rules:[o=>!!o||"Seleccione un apiario"]},null,8,["modelValue","options","loading","disable","rules"]),r.apiarioDetalle?(c(),f("div",M,[t(V,{name:"place",size:"16px",class:"q-mr-xs"}),p(" "+_(r.apiarioDetalle?.municipio||"—"),1)])):h("",!0)]),l("div",Y,[t(n,{modelValue:i.form.cantidad_kg,"onUpdate:modelValue":e[3]||(e[3]=o=>i.form.cantidad_kg=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Cantidad (kg)",dense:"",outlined:"",suffix:"kg",rules:[o=>o>0||"Mayor a 0"]},null,8,["modelValue","rules"])]),l("div",j,[t(m,{modelValue:i.form.producto_id,"onUpdate:modelValue":e[4]||(e[4]=o=>i.form.producto_id=o),options:i.productos.map(o=>({label:o.nombre_producto,value:o.id})),label:"Producto",dense:"",outlined:"","emit-value":"","map-options":"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","options","rules"])]),l("div",R,[t(n,{modelValue:i.form.precio_compra,"onUpdate:modelValue":e[5]||(e[5]=o=>i.form.precio_compra=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Precio de compra",dense:"",outlined:"",prefix:"Bs ",rules:[o=>o>=0||"No negativo"]},null,8,["modelValue","rules"])]),l("div",F,[t(n,{modelValue:i.form.humedad,"onUpdate:modelValue":e[6]||(e[6]=o=>i.form.humedad=o),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",label:"Humedad (%)",dense:"",outlined:"",suffix:"%"},null,8,["modelValue"])]),l("div",z,[t(n,{modelValue:i.form.temperatura_almacenaje,"onUpdate:modelValue":e[7]||(e[7]=o=>i.form.temperatura_almacenaje=o),modelModifiers:{number:!0},type:"number",min:"-50",step:"0.01",label:"Temperatura Almacenaje (°C)",dense:"",outlined:"",suffix:"°C"},null,8,["modelValue"])]),l("div",I,[t(n,{modelValue:i.form.procedencia,"onUpdate:modelValue":e[8]||(e[8]=o=>i.form.procedencia=o),label:"Procedencia",dense:"",outlined:"",maxlength:"50"},null,8,["modelValue"])]),l("div",L,[t(m,{modelValue:i.form.tipo_envase,"onUpdate:modelValue":e[9]||(e[9]=o=>i.form.tipo_envase=o),label:"Tipo de envase",dense:"",outlined:"",maxlength:"100",options:["BALDE","OTRO"]},null,8,["modelValue"])]),l("div",T,[t(n,{modelValue:i.form.observaciones,"onUpdate:modelValue":e[10]||(e[10]=o=>i.form.observaciones=o),label:"Observaciones",dense:"",outlined:"",autogrow:"",maxlength:"255"},null,8,["modelValue"])]),l("div",G,[t(m,{modelValue:i.form.estado,"onUpdate:modelValue":e[11]||(e[11]=o=>i.form.estado=o),options:i.estados,"emit-value":"","map-options":"",label:"Estado",dense:"",outlined:"",rules:[o=>!!o||"Requerido"]},null,8,["modelValue","options","rules"])])]),s.estado==="crear"?(c(),f("div",H,[t(b,{type:"submit",color:"primary",icon:"save",loading:i.loading,"no-caps":"",label:"Guardar"},null,8,["loading"]),t(b,{type:"reset",color:"grey-7",flat:"",icon:"history","no-caps":"",label:"Limpiar",onClick:r.onReset},null,8,["onClick"])])):(c(),f("div",J,[t(b,{type:"submit",color:"primary",icon:"save",loading:i.loading,"no-caps":"",label:"Actualizar"},null,8,["loading"])]))]),_:1},8,["onSubmit"])]),_:1})]),_:1})}const io=O(U,[["render",K]]);export{io as A};
