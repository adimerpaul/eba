import{Q as f,b,a as V}from"./position-engine-D6nSYRF0.js";import{Q as h}from"./QSelect-Cxsf63Um.js";import{_ as C,c as Q,o as g,w as d,a as o,aj as w,Q as x,e as k,b as l,a7 as m,ag as p,O as S,f as v,a9 as y,a8 as N,aa as L,ab as q,t as c,aK as U,ai as O}from"./index-Cl83UuLA.js";import{Q as T}from"./QSpace-dSNKkGFp.js";import{Q as F}from"./QChip-CqufFhuY.js";import{Q as I}from"./QMarkupTable-kt3qpGaC.js";import{Q as A}from"./QForm-DaH_sXUe.js";import{Q as D}from"./QPage-BEA7z6sV.js";import"./selection-BFvblPyJ.js";import"./format-TNedi91C.js";const P={name:"VentaCrear",data(){return{venta:{cliente_id:null,transporte_id:null,fecha_venta:new Date(Date.now()-new Date().getTimezoneOffset()*6e4).toISOString().slice(0,16),destino_final:"",guia_remision:"",num_factura:""},clienteOptions:[],transporteOptions:[],loteOptions:[],loadingClientes:!1,loadingTransportes:!1,loadingLotes:!1,items:[],saving:!1}},computed:{total(){return this.items.reduce((s,e)=>s+(Number(e.subtotal)||0),0)},canSubmit(){const s=!!(this.venta.cliente_id&&this.venta.transporte_id&&this.venta.fecha_venta),e=this.items.length>0&&this.items.every(t=>t.lote_id&&t.cantidad_salida>0&&t.cantidad_salida<=t.disponible_kg&&t.precio_venta>=0);return s&&e}},mounted(){this.seedCombos()},methods:{fmt(s){return Number(s||0).toFixed(2)},async seedCombos(){await Promise.all([this.filterClientes(""),this.filterTransportes(""),this.filterLotes("")])},async filterClientes(s,e){e&&e(),this.loadingClientes=!0;try{const{data:t}=await this.$axios.get("/clientes",{params:{q:s||""}});this.clienteOptions=(Array.isArray(t)?t:t.data||[]).map(i=>({id:i.id,nombre:i.nombre_cliente}))}finally{this.loadingClientes=!1}},async filterTransportes(s,e){e&&e(),this.loadingTransportes=!0;try{const{data:t}=await this.$axios.get("/transportes",{params:{q:s||""}});this.transporteOptions=(Array.isArray(t)?t:t.data||[]).map(i=>({id:i.id,nombre:i.empresa||i.responsable||i.placa}))}finally{this.loadingTransportes=!1}},async filterLotes(s,e){e&&e(),this.loadingLotes=!0;try{const{data:t}=await this.$axios.get("/lotes/disponibles",{params:{q:s||""}});this.loteOptions=(Array.isArray(t)?t:t.data||[]).map(i=>({id:i.id,codigo_lote:i.codigo_lote,producto_id:i.producto_id,producto_nombre:i.producto_nombre||i.producto?.nombre_producto,disponible_kg:Number(i.disponible_kg??i.cantidad_kg??0),label:`${i.codigo_lote} — ${i.producto_nombre||i.producto?.nombre_producto} (Disp: ${Number(i.disponible_kg??i.cantidad_kg??0).toFixed(2)} kg)`}))}finally{this.loadingLotes=!1}},addItem(){this.items.push({uid:Math.random().toString(36).slice(2),lote_id:null,producto_id:null,producto_nombre:"",disponible_kg:0,cantidad_salida:null,precio_venta:0,subtotal:0,err:""})},removeItem(s){this.items.splice(s,1)},findLoteLabel(s){const e=typeof s=="object"?s.id:s,t=this.loteOptions.find(i=>i.id===e);return t?t.codigo_lote:e},onPickLote(s){const e=this.items[s],t=this.loteOptions.find(i=>i.id===e.lote_id);t&&(e.producto_id=t.producto_id,e.producto_nombre=t.producto_nombre,e.disponible_kg=t.disponible_kg,e.cantidad_salida>t.disponible_kg&&(e.cantidad_salida=t.disponible_kg),this.recalcSubtotal(s))},recalcSubtotal(s){const e=this.items[s];e.err="";const t=Number(e.cantidad_salida||0),i=Number(e.disponible_kg||0);t>i?e.err=`No puede exceder ${this.fmt(i)} kg`:t<=0&&(e.err="Ingresa una cantidad válida");const n=Number(e.precio_venta||0);e.subtotal=t>0&&n>=0&&t<=i?t*n:0},async onSubmit(){if(this.canSubmit){this.saving=!0;try{const s={...this.venta,precio_total:this.total,detalles:this.items.map(e=>({lote_id:e.lote_id,producto_id:e.producto_id,cantidad_salida:Number(e.cantidad_salida),precio_venta:Number(e.precio_venta)}))};await this.$axios.post("/ventas",s),this.$q.notify({type:"positive",message:"Venta registrada"}),this.$router.push("/ventas")}catch(s){const e=s.response?.data?.message||"No se pudo registrar la venta";this.$q.notify({type:"negative",message:e})}finally{this.saving=!1}}}}},B={class:"col-12 col-md-6"},M={class:"col-12 col-md-6"},G={class:"col-12 col-md-4"},R={class:"col-12 col-md-4"},j={class:"col-12 col-md-2"},z={class:"col-12 col-md-2"},E={class:"row items-center q-gutter-sm q-mb-sm"},K={class:"text-right"},H={class:"q-pa-xs"},J={class:"text-right"},W={class:"q-pa-xs"},X={class:"text-right"},Y={key:0},Z={class:"row justify-end q-mt-md"},$={class:"col-auto"},ee={class:"text-subtitle1"};function te(s,e,t,i,n,u){return g(),Q(D,{class:"q-pa-md"},{default:d(()=>[o(A,{onSubmit:w(u.onSubmit,["prevent"]),ref:"formRef"},{default:d(()=>[o(x,{flat:"",bordered:""},{default:d(()=>[o(k,{class:"row q-col-gutter-md"},{default:d(()=>[e[9]||(e[9]=l("div",{class:"col-12"},[l("div",{class:"text-h6"},"Nueva Venta")],-1)),l("div",B,[o(h,{modelValue:n.venta.cliente_id,"onUpdate:modelValue":e[0]||(e[0]=a=>n.venta.cliente_id=a),options:n.clienteOptions,"option-value":"id","option-label":"nombre","emit-value":"","map-options":"","input-debounce":"300",onFilter:u.filterClientes,loading:n.loadingClientes,dense:"",filled:"",label:"Cliente",rules:[a=>!!a||"Selecciona un cliente"]},{"no-option":d(()=>[o(f,null,{default:d(()=>[o(b,{class:"text-grey"},{default:d(()=>e[7]||(e[7]=[m("Sin resultados")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","loading","rules"])]),l("div",M,[o(h,{modelValue:n.venta.transporte_id,"onUpdate:modelValue":e[1]||(e[1]=a=>n.venta.transporte_id=a),options:n.transporteOptions,"option-value":"id","option-label":"nombre","emit-value":"","map-options":"","input-debounce":"300",onFilter:u.filterTransportes,loading:n.loadingTransportes,dense:"",filled:"",label:"Transporte",rules:[a=>!!a||"Selecciona un transporte"]},{"no-option":d(()=>[o(f,null,{default:d(()=>[o(b,{class:"text-grey"},{default:d(()=>e[8]||(e[8]=[m("Sin resultados")])),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","loading","rules"])]),l("div",G,[o(p,{modelValue:n.venta.fecha_venta,"onUpdate:modelValue":e[2]||(e[2]=a=>n.venta.fecha_venta=a),type:"datetime-local",dense:"",filled:"",label:"Fecha de venta",rules:[a=>!!a||"Requerido"]},null,8,["modelValue","rules"])]),l("div",R,[o(p,{modelValue:n.venta.destino_final,"onUpdate:modelValue":e[3]||(e[3]=a=>n.venta.destino_final=a),dense:"",filled:"",label:"Destino final"},null,8,["modelValue"])]),l("div",j,[o(p,{modelValue:n.venta.guia_remision,"onUpdate:modelValue":e[4]||(e[4]=a=>n.venta.guia_remision=a),dense:"",filled:"",label:"Guía de remisión"},null,8,["modelValue"])]),l("div",z,[o(p,{modelValue:n.venta.num_factura,"onUpdate:modelValue":e[5]||(e[5]=a=>n.venta.num_factura=a),dense:"",filled:"",label:"N° factura"},null,8,["modelValue"])])]),_:1}),o(S),o(k,null,{default:d(()=>[l("div",E,[e[10]||(e[10]=l("div",{class:"text-subtitle2"},"Detalle de lotes",-1)),o(T),o(v,{color:"primary",icon:"add",label:"Agregar lote","no-caps":"",onClick:u.addItem},null,8,["onClick"])]),o(I,{dense:"",flat:"",bordered:"",class:"full-width"},{default:d(()=>[e[13]||(e[13]=l("thead",null,[l("tr",null,[l("th",{style:{width:"28%"}},"Lote"),l("th",{style:{width:"18%"}},"Producto"),l("th",{style:{width:"14%"},class:"text-right"},"Disp. (kg)"),l("th",{style:{width:"14%"}},"Cantidad (kg)"),l("th",{style:{width:"12%"}},"Precio"),l("th",{style:{width:"10%"},class:"text-right"},"Subtotal"),l("th",{style:{width:"4%"}})])],-1)),l("tbody",null,[(g(!0),y(L,null,q(n.items,(a,_)=>(g(),y("tr",{key:a.uid},[l("td",null,[o(h,{modelValue:a.lote_id,"onUpdate:modelValue":[r=>a.lote_id=r,r=>u.onPickLote(_)],options:n.loteOptions,"option-value":"id","option-label":"label","emit-value":"","map-options":"",dense:"",filled:"","input-debounce":"300",onFilter:u.filterLotes,loading:n.loadingLotes},{option:d(r=>[o(f,U({ref_for:!0},r.itemProps),{default:d(()=>[o(b,null,{default:d(()=>[o(V,null,{default:d(()=>[m(c(r.opt.codigo_lote),1)]),_:2},1024),o(V,{caption:""},{default:d(()=>[m(c(r.opt.producto_nombre)+" — Disp: "+c(u.fmt(r.opt.disponible_kg))+" kg ",1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),"selected-item":d(r=>[o(F,{square:"",dense:""},{default:d(()=>[m(c(u.findLoteLabel(r.opt)),1)]),_:2},1024)]),"no-option":d(()=>[o(f,null,{default:d(()=>[o(b,{class:"text-grey"},{default:d(()=>e[11]||(e[11]=[m("Sin resultados")])),_:1})]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue","options","onFilter","loading"])]),l("td",null,[o(p,{modelValue:a.producto_nombre,"onUpdate:modelValue":r=>a.producto_nombre=r,dense:"",filled:"",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),l("td",K,[l("div",H,c(u.fmt(a.disponible_kg)),1)]),l("td",null,[o(p,{modelValue:a.cantidad_salida,"onUpdate:modelValue":[r=>a.cantidad_salida=r,r=>u.recalcSubtotal(_)],modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:"",error:!!a.err,"error-message":a.err||""},null,8,["modelValue","onUpdate:modelValue","error","error-message"])]),l("td",null,[o(p,{modelValue:a.precio_venta,"onUpdate:modelValue":[r=>a.precio_venta=r,r=>u.recalcSubtotal(_)],modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",filled:""},null,8,["modelValue","onUpdate:modelValue"])]),l("td",J,[l("div",W,c(u.fmt(a.subtotal)),1)]),l("td",X,[o(v,{dense:"",flat:"",icon:"delete",color:"negative",onClick:r=>u.removeItem(_)},null,8,["onClick"])])]))),128)),n.items.length?N("",!0):(g(),y("tr",Y,e[12]||(e[12]=[l("td",{colspan:"7",class:"text-center text-grey"},"Sin ítems. Agrega un lote.",-1)])))])]),_:1}),l("div",Z,[l("div",$,[l("div",ee,[e[14]||(e[14]=m(" Total: ")),l("b",null,c(u.fmt(u.total)),1),e[15]||(e[15]=m(" Bs. "))])])])]),_:1}),o(S),o(O,{align:"right"},{default:d(()=>[o(v,{flat:"",label:"Cancelar",onClick:e[6]||(e[6]=a=>s.$router.back())}),o(v,{color:"primary",loading:n.saving,disable:!u.canSubmit,label:"Guardar venta",type:"submit"},null,8,["loading","disable"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})}const pe=C(P,[["render",te],["__scopeId","data-v-6226f4d7"]]);export{pe as default};
